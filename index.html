<!DOCTYPE html>
<html lang="fr" dir="ltr" :class="{ 'font-ar': currentLang === 'ar', 'font-fr': currentLang === 'fr' }">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="TeacherTrack - Gestion de classe, suivi des élèves et des notes">
    <meta name="theme-color" content="#0f766e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SGC-TeacherTrack">
    <title>SGC-TeacherTrack - Gestion de Classe</title>

    <!-- Polices Google (Français + Arabe) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Script de secours pour charger les ressources (défini AVANT les CSS pour être disponible) -->
    <script>
        // Fonction pour basculer vers le CDN en cas d'échec de chargement du fichier local
        function loadCDN(type, cdnUrl) {
            const element = document.getElementById(type + '-local');
            if (element) {
                console.log('⚠️ Fichier local ' + type + ' non trouvé, basculement vers CDN...');
                element.setAttribute('href', cdnUrl);
            }
        }

        // Fonction pour charger les scripts JavaScript avec secours
        function loadScriptWithFallback(id, localPath, cdnUrl, callback) {
            // Vérifier si le script est déjà chargé
            const existing = document.getElementById(id);
            if (existing && existing.getAttribute('data-loaded') === 'true') {
                console.log('✓ Script ' + id + ' déjà chargé');
                if (callback) callback();
                return;
            }

            const script = document.createElement('script');
            script.id = id;
            script.src = localPath;
            script.onload = function () {
                console.log('✓ Fichier local ' + id + ' chargé avec succès');
                script.setAttribute('data-loaded', 'true');
                if (callback) callback();
            };
            script.onerror = function () {
                console.log('⚠️ Fichier local ' + id + ' non trouvé, basculement vers CDN...');
                script.src = cdnUrl;
                script.onload = function () {
                    console.log('✓ CDN ' + id + ' chargé avec succès');
                    script.setAttribute('data-loaded', 'true');
                    if (callback) callback();
                };
                script.onerror = function () {
                    console.error('✗ Échec du chargement de ' + id + ' depuis le CDN également');
                };
            };
            document.head.appendChild(script);
        }
    </script>

    <!-- Capacitor Injection: Charge les APIs Capacitor depuis CDN (web) ou natif (Android) -->
    <script type="module">
        // Importer Capacitor depuis CDN (fonctionne aussi bien sur web que dans l'APK)
        import { Capacitor } from 'https://cdn.jsdelivr.net/npm/@capacitor/core@5/+esm';
        import { Filesystem, Directory, Encoding } from 'https://cdn.jsdelivr.net/npm/@capacitor/filesystem@5/+esm';
        import { Preferences } from 'https://cdn.jsdelivr.net/npm/@capacitor/preferences@5/+esm';

        // Exposer globalement pour le code Vue existant
        window.Capacitor = Capacitor;
        window.Filesystem = Filesystem;
        window.Directory = Directory;
        window.Encoding = Encoding;
        window.Preferences = Preferences;

        console.log('[Capacitor] Modules chargés:', {
            Capacitor: !!Capacitor,
            Filesystem: !!Filesystem,
            Preferences: !!Preferences,
            isNative: Capacitor.isNativePlatform()
        });

        // Demander la permission du système de fichiers au premier démarrage sur Android
        if (Capacitor.isNativePlatform()) {
            console.log('[Capacitor] Plateforme native détectée:', Capacitor.getPlatform());

            // Demander les permissions au démarrage
            (async () => {
                try {
                    // Sur Android 13+ (API 33+), utiliser les nouvelles permissions granulaires
                    const permStatus = await Filesystem.checkPermissions();
                    console.log('[Capacitor] Statut permissions:', JSON.stringify(permStatus));

                    // Demander les permissions si non accordées
                    if (permStatus.publicStorage !== 'granted') {
                        console.log('[Capacitor] Demande de permission stockage...');
                        const request = await Filesystem.requestPermissions();
                        console.log('[Capacitor] Résultat demande:', JSON.stringify(request));

                        if (request.publicStorage !== 'granted') {
                            console.warn('[Capacitor] Permission stockage refusée - utilisation du stockage interne uniquement');
                        }
                    }
                } catch (e) {
                    console.warn('[Capacitor] Erreur permissions (normal sur Android 13+):', e.message);
                    // Sur Android 13+, les permissions externes ne sont plus nécessaires pour le stockage app
                }
            })();
        } else {
            console.log('[Capacitor] Mode web détecté - APIs Filesystem/Preferences limitées');
        }
    </script>

    <!-- Styles avec mécanisme de secours (local → CDN) -->
    <link id="fontawesome-local" rel="stylesheet" href="fontawesome.min.css"
        onerror="loadCDN('fontawesome', 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css')">
    <!-- Tailwind CSS via script CDN (toujours chargé, pas de fallback fichier local pour le script JS Tailwind) -->
    <link rel="stylesheet" href="tailwind.css">

    <!-- Manifest PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- Icônes PWA -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

    <!-- Styles critiques anti-flash -->
    <style>
        /* Masque les éléments Vue non compilés */
        [v-cloak] {
            display: none !important;
        }

        /* Styles de base */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
        }

        /* Police arabe */
        .font-ar {
            font-family: 'Cairo', sans-serif !important;
        }

        .font-fr {
            font-family: 'Inter', system-ui, -apple-system, sans-serif !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Zone drag-and-drop */
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }

        .drop-zone.dragover {
            border-color: #6366f1;
            background-color: #eef2ff;
        }

        /* Force buttons background colors */
        .bg-emerald-600 {
            background-color: #059669 !important;
        }

        .bg-emerald-600:hover {
            background-color: #047857 !important;
        }

        /* Modal background */
        .bg-white {
            background-color: #ffffff !important;
        }
    </style>


</head>

<body>

    <!-- Application Vue -->
    <div id="app" v-cloak class="min-h-screen flex flex-col">

        <!-- ==================== -->
        <!-- ÉCRAN D'ACCUEIL -->
        <!-- ==================== -->
        <div v-if="!isDataLoaded" class="min-h-screen bg-slate-900 p-4 overflow-auto">
            <!-- Bannière Licence -->
            <div v-if="isLicenseValid"
                class="mb-4 p-3 bg-emerald-600 text-white rounded-lg flex justify-between items-center shadow-lg">
                <span class="font-bold text-sm"><i class="fas fa-certificate text-yellow-400 mr-1"></i> {{
                    t('license_active') }}</span>
                <span class="font-mono text-xs">{{ licenseOwner }}</span>
            </div>
            <div v-else @click="showLicenseModal = true"
                class="mb-4 p-3 bg-red-600 text-white rounded-lg text-center font-bold cursor-pointer hover:bg-red-700 transition shadow-lg animate-pulse">
                <i class="fas fa-lock mr-1"></i> {{ t('license_not_activated') }}
            </div>

            <!-- Sélecteur de langue (coin supérieur droit) -->
            <div class="flex justify-end mb-4">
                <div class="flex items-center bg-slate-800 rounded-lg p-1">
                    <button @click="setLang('fr')"
                        :class="['px-3 py-1.5 rounded text-sm font-medium transition', currentLang === 'fr' ? 'bg-white text-indigo-600' : 'text-slate-400 hover:text-white']">
                        FR
                    </button>
                    <button @click="setLang('en')"
                        :class="['px-3 py-1.5 rounded text-sm font-medium transition', currentLang === 'en' ? 'bg-white text-indigo-600' : 'text-slate-400 hover:text-white']">
                        EN
                    </button>
                    <button @click="setLang('ar')"
                        :class="['px-3 py-1.5 rounded text-sm font-medium transition', currentLang === 'ar' ? 'bg-white text-indigo-600' : 'text-slate-400 hover:text-white']">
                        AR
                    </button>
                </div>
            </div>

            <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
                <!-- En-tête -->
                <div class="bg-gradient-to-br from-indigo-600 via-indigo-700 to-purple-700 p-6 text-center">
                    <img src="Logo-TeacherTrack-Transparent.png" alt="TeacherTrack Logo"
                        style="width: 64px; height: 64px; max-width: 64px; max-height: 64px;"
                        class="mx-auto mb-3 drop-shadow-lg">
                    <h1 class="text-xl font-bold text-white">{{ t('app_title') }}</h1>
                    <p class="text-indigo-200 text-sm mt-1">{{ t('app_subtitle') }}</p>
                    <p class="text-indigo-300 text-xs mt-0.5 font-medium">{{ t('sgc_meaning') }}</p>
                </div>

                <!-- Contenu -->
                <div class="p-5 space-y-3">
                    <!-- Bouton Ouvrir avec File Picker -->
                    <button @click="openFilePicker" :disabled="!isLicenseValid"
                        :class="['w-full flex items-center p-4 rounded-xl border transition group', !isLicenseValid ? 'bg-slate-100 opacity-50 cursor-not-allowed' : 'bg-slate-50 hover:bg-slate-100 border-slate-200']">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ms-3"
                            :class="!isLicenseValid ? 'bg-slate-200' : 'bg-indigo-100 group-hover:bg-indigo-600'">
                            <i class="fas fa-folder-open"
                                :class="!isLicenseValid ? 'text-slate-400' : 'text-indigo-600 group-hover:text-white transition'"></i>
                        </div>
                        <div class="text-start">
                            <div class="font-semibold text-slate-800 text-sm">{{ t('btn_open_file') }}</div>
                            <div class="text-xs text-slate-500">{{ t('btn_explorer') }}</div>
                        </div>
                    </button>

                    <!-- Bouton Scanner Dossier -->
                    <button @click="scanFolder" :disabled="!isLicenseValid"
                        :class="['w-full flex items-center p-4 rounded-xl border transition group', !isLicenseValid ? 'bg-slate-100 opacity-50 cursor-not-allowed' : 'bg-slate-50 hover:bg-slate-100 border-slate-200']">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ms-3"
                            :class="!isLicenseValid ? 'bg-slate-200' : 'bg-purple-100 group-hover:bg-purple-600'">
                            <i class="fas fa-folder"
                                :class="!isLicenseValid ? 'text-slate-400' : 'text-purple-600 group-hover:text-white transition'"></i>
                        </div>
                        <div class="text-start">
                            <div class="font-semibold text-slate-800 text-sm">{{ t('btn_scan_folder') }}</div>
                            <div class="text-xs text-slate-500">{{ t('btn_detect_json') }}</div>
                        </div>
                    </button>

                    <!-- Bouton Nouveau -->
                    <button @click="createNewFile" :disabled="!isLicenseValid"
                        :class="['w-full flex items-center p-4 rounded-xl border transition group', !isLicenseValid ? 'bg-slate-100 opacity-50 cursor-not-allowed' : 'bg-slate-50 hover:bg-slate-100 border-slate-200']">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ms-3"
                            :class="!isLicenseValid ? 'bg-slate-200' : 'bg-emerald-100 group-hover:bg-emerald-600'">
                            <i class="fas fa-plus"
                                :class="!isLicenseValid ? 'text-slate-400' : 'text-emerald-600 group-hover:text-white transition'"></i>
                        </div>
                        <div class="text-start">
                            <div class="font-semibold text-slate-800 text-sm">{{ t('btn_new_space') }}</div>
                            <div class="text-xs text-slate-500">{{ t('btn_create_json') }}</div>
                        </div>
                    </button>

                    <!-- Zone Drag & Drop -->
                    <div id="dropZone"
                        :class="['drop-zone rounded-xl p-4 text-center', !isLicenseValid ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer']"
                        :style="!isLicenseValid ? 'pointer-events: none;' : ''" @dragover.prevent="handleDragOver"
                        @dragleave.prevent="handleDragLeave" @drop.prevent="handleDrop"
                        @click="isLicenseValid && document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt text-2xl text-slate-300 mb-2"></i>
                        <p class="text-xs text-slate-500">{{ t('drop_zone_text') }}</p>
                        <p class="text-xs text-slate-400 mt-1">{{ t('drop_zone_click') }}</p>
                    </div>

                    <!-- Input fichier caché (fallback) -->
                    <input type="file" id="fileInput" @change="loadFileFromInput" accept=".json" class="hidden"
                        :disabled="!isLicenseValid">

                    <!-- Message sécurité -->
                    <div class="p-2.5 bg-amber-50 border border-amber-200 rounded-xl">
                        <p class="text-xs text-amber-700">
                            <i class="fas fa-info-circle ms-1"></i>
                            {{ t('security_note') }}
                        </p>
                    </div>

                    <!-- Gestion des Espaces (Mode Natif) -->
                    <div class="mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                {{ isNative ? 'Mes Espaces (Dossier sgc-teachertrack)' : 'Fichiers Récents' }}
                            </h3>
                            <button v-if="isNative" @click="loadSpaces" class="text-xs text-indigo-600">
                                <i class="fas fa-sync"></i> Actualiser
                            </button>
                        </div>

                        <div v-if="isNative">
                            <div v-if="availableSpaces.length > 0" class="space-y-2">
                                <button v-for="space in availableSpaces" :key="space.path"
                                    @click="openSpace(space.name)"
                                    class="w-full flex items-center p-3 bg-white border border-slate-200 rounded-lg hover:border-indigo-500 transition">
                                    <div
                                        class="w-10 h-10 bg-indigo-50 rounded text-indigo-600 flex items-center justify-center">
                                        <i class="fas fa-database"></i>
                                    </div>
                                    <div class="ms-3 text-start flex-1">
                                        <div class="font-semibold text-slate-700">{{ space.name }}</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-slate-300"></i>
                                </button>
                            </div>
                            <div v-else class="p-6 text-center border-dashed border-2 border-slate-200 rounded-xl mb-3">
                                <p class="text-slate-400">Aucun espace trouvé.</p>
                            </div>

                            <button @click="createNewSpace"
                                class="w-full mt-2 py-3 bg-indigo-600 text-white rounded-xl font-medium shadow hover:bg-indigo-700 transition">
                                <i class="fas fa-plus-circle me-2"></i> Créer un nouvel espace
                            </button>
                        </div>

                        <div v-else>
                            <!-- Mode Web : Afficher les fichiers récents -->
                            <div v-if="recentFiles.length > 0" class="space-y-1.5 max-h-40 overflow-y-auto">
                                <button v-for="file in recentFiles" :key="file.path" @click="openRecentFile(file)"
                                    class="w-full flex items-center p-2.5 bg-slate-50 hover:bg-slate-100 rounded-lg transition text-start">
                                    <i class="fas fa-file-code text-indigo-400 ms-2"></i>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-slate-700 text-sm truncate">{{ file.name }}</div>
                                        <div class="text-xs text-slate-400">{{ formatDate(file.date) }}</div>
                                    </div>
                                    <button @click.stop="removeFromRecent(file.path)"
                                        class="text-slate-400 hover:text-red-500 p-1">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </button>
                            </div>

                            <!-- Message quand aucun fichier récent (mode web) -->
                            <div v-if="recentFiles.length === 0"
                                class="p-3 bg-slate-50 rounded-xl border border-slate-200 text-center">
                                <i class="fas fa-history text-slate-300 text-xl mb-1"></i>
                                <p class="text-xs text-slate-500">{{ t('no_recent') }}</p>
                                <p class="text-xs text-slate-400 mt-0.5">{{ t('recent_appear') }}</p>
                            </div>

                            <button v-if="recentFiles.length === 0" @click="clearRecentFiles"
                                class="hidden text-xs text-slate-400 hover:text-slate-600">{{ t('clear_recent')
                                }}</button>
                        </div>
                    </div>
                </div>

                <!-- Pied de page -->
                <div class="bg-slate-50 px-4 py-3 border-t border-slate-100">
                    <p class="text-xs text-slate-400 text-center">
                        <i class="fas fa-shield-alt ms-1"></i>
                        <span v-html="t('local_note')"></span>
                    </p>
                    <div class="mt-2 text-center">
                        <button @click="openLicenseModalWithWarning"
                            class="text-[10px] text-slate-300 hover:text-slate-500 transition">
                            <i class="fas fa-key me-1"></i> {{ t('change_license') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- APPLICATION PRINCIPALE -->
        <!-- ==================== -->
        <div v-if="isDataLoaded" class="flex flex-col min-h-screen">

            <!-- En-tête -->
            <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
                <div class="px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="Logo-TeacherTrack-Transparent.png" alt="Logo"
                            style="width: 28px; height: 28px; max-width: 28px; max-height: 28px;">
                        <h1 class="text-lg font-semibold text-slate-800">
                            {{ t('app_title') }}
                        </h1>
                        <span v-if="fileName" class="text-sm text-slate-500 bg-slate-100 px-2 py-1 rounded">{{ fileName
                            }}</span>
                        <!-- Indicateur de sauvegarde -->
                        <span v-if="hasUnsavedChanges"
                            class="text-sm px-3 py-1 rounded-full bg-red-100 text-red-700 flex items-center gap-1.5 font-medium">
                            <i class="fas fa-circle text-xs animate-pulse"></i>
                            {{ t('unsaved') }}
                        </span>
                        <span v-else-if="fileName"
                            class="text-sm px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 flex items-center gap-1.5 font-medium">
                            <i class="fas fa-check-circle"></i>
                            {{ t('saved') }}
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Sélecteur de langue -->
                        <div class="flex items-center bg-slate-100 rounded-lg p-1">
                            <button @click="setLang('fr')"
                                :class="['px-2 py-1 rounded text-xs font-medium transition', currentLang === 'fr' ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700']">
                                FR
                            </button>
                            <button @click="setLang('en')"
                                :class="['px-2 py-1 rounded text-xs font-medium transition', currentLang === 'en' ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700']">
                                EN
                            </button>
                            <button @click="setLang('ar')"
                                :class="['px-2 py-1 rounded text-xs font-medium transition', currentLang === 'ar' ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700']">
                                AR
                            </button>
                        </div>
                        <button @click="closeFile"
                            class="px-3 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">
                            <i class="fas fa-times ms-1"></i>
                            <span class="hidden sm:inline">{{ t('close') }}</span>
                        </button>
                        <button @click="saveFile"
                            class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center">
                            <i class="fas fa-save ms-1"></i>
                            <span class="hidden sm:inline">{{ t('save') }}</span>
                        </button>
                    </div>
                </div>

                <!-- Navigation par onglets -->
                <div class="px-4 flex gap-1 overflow-x-auto border-t border-slate-100 pb-2">
                    <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                        :class="['px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap',
                                 currentTab === tab.id ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-100']">
                        <i :class="tab.icon + ' ms-2'"></i>
                        <span class="hidden md:inline">{{ tab.name }}</span>
                    </button>

                    <!-- Sélecteur de classe avec bouton d'ajout (visible si classes existent) -->
                    <div v-if="db.classes.length > 0" class="ms-auto flex items-center gap-2">
                        <button @click="showClassModal = true"
                            class="p-2 bg-indigo-100 text-indigo-600 rounded-lg hover:bg-indigo-200 transition"
                            :title="t('add_class')">
                            <i class="fas fa-plus"></i>
                        </button>
                        <select v-model="currentClassIndex"
                            class="px-3 py-2 bg-slate-100 border-0 rounded-lg text-sm font-medium text-slate-700 focus:ring-2 focus:ring-indigo-500">
                            <option v-for="(cls, idx) in db.classes" :key="idx" :value="idx">{{ cls.name }}</option>
                        </select>

                        <!-- Sélecteur de matières -->
                        <div class="flex items-center gap-1">
                            <i class="fas fa-book text-slate-400 text-xs"></i>
                            <select v-model="currentSubjectId"
                                class="px-2 py-1 bg-purple-50 border border-purple-200 rounded text-sm text-purple-700 focus:ring-2 focus:ring-purple-500">
                                <option :value="null">{{ t('all_subjects') }}</option>
                                <option v-for="subject in currentSubjects" :key="subject.id" :value="subject.id">
                                    {{ subject.name }}
                                </option>
                            </select>
                            <button @click="showSubjectModal = true"
                                class="p-1 bg-purple-100 text-purple-600 rounded hover:bg-purple-200 transition"
                                :title="t('manage_subjects')">
                                <i class="fas fa-cog text-xs"></i>
                            </button>
                        </div>

                        <!-- Affichage établissement lié à la classe -->
                        <div v-if="getCurrentClassEstablishment"
                            class="flex items-center gap-1 px-2 py-1 bg-emerald-50 border border-emerald-200 rounded text-xs text-emerald-700 cursor-pointer hover:bg-emerald-100 transition"
                            @click="showClassEstablishmentModal = true" :title="t('click_to_change_establishment')">
                            <i class="fas fa-building text-[10px]"></i>
                            <span class="truncate max-w-[120px]">{{ getCurrentClassEstablishment.name }}</span>
                            <i class="fas fa-pencil-alt text-[10px] ml-1 opacity-60"></i>
                        </div>

                        <!-- Gestion des trimestres -->
                        <button @click="resetTrimesterForm(); showTrimesterModal = true"
                            class="px-2 py-1 bg-amber-100 text-amber-700 rounded hover:bg-amber-200 transition text-xs"
                            :title="t('manage_trimesters')">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                    </div>

                    <!-- Bouton ajouter classe si aucune classe n'existe -->
                    <div v-else class="ms-auto">
                        <button @click="showClassModal = true"
                            class="px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition text-sm font-medium">
                            <i class="fas fa-plus ms-1"></i> {{ t('add_class') }}
                        </button>
                    </div>
                </div>
            </header>

            <!-- Contenu principal -->
            <main class="flex-1 p-4 overflow-auto">

                <!-- CARTE INFORMATIONS ENSEIGNANT (toujours visible) -->
                <div class="bg-blue-950 rounded-xl shadow-lg p-4 mb-4 border border-blue-800"
                    style="background: linear-gradient(to right, #0f172a, #1e3a5f, #0f172a);">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-14 h-14 bg-blue-900/80 rounded-full flex items-center justify-center ring-2 ring-blue-700/50 shadow-lg">
                                <i class="fas fa-user-tie text-2xl text-blue-200"></i>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-white drop-shadow-md">
                                    <span class="opacity-80">{{ t('teacher_label') }}</span> {{ db.teacherInfo.lastname
                                    }} {{ db.teacherInfo.firstname }}
                                </div>
                                <div class="flex items-center gap-4 mt-1">
                                    <span v-if="db.teacherInfo.teacherType"
                                        class="flex items-center gap-1 text-blue-300 text-sm font-semibold drop-shadow">
                                        <i class="fas fa-briefcase text-xs text-blue-400"></i>
                                        <span v-if="db.teacherInfo.teacherType === 'professor'">{{ t('type_professor')
                                            }}</span>
                                        <span v-else-if="db.teacherInfo.teacherType === 'institute'">{{
                                            t('type_institute') }}</span>
                                        <span v-else-if="db.teacherInfo.teacherType === 'supeur'">{{ t('type_supeur')
                                            }}</span>
                                        <span v-else class="text-blue-300">{{ db.teacherInfo.teacherType }}</span>
                                    </span>
                                    <span v-if="db.teacherInfo.schoolYear"
                                        class="flex items-center gap-1 text-blue-300 text-sm font-semibold drop-shadow">
                                        <i class="fas fa-calendar-alt text-xs text-blue-400"></i>
                                        <span>{{ db.teacherInfo.schoolYear }}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-3 text-sm">
                            <div v-if="getEstablishmentName(db.teacherInfo.mainEstablishment)"
                                class="flex items-center gap-2 bg-blue-900/80 px-3 py-1.5 rounded-lg text-white border border-blue-700 shadow">
                                <i class="fas fa-building text-blue-300"></i>
                                <span class="font-medium">{{ getEstablishmentName(db.teacherInfo.mainEstablishment)
                                    }}</span>
                            </div>
                            <div v-if="db.teacherInfo.phone"
                                class="flex items-center gap-2 bg-blue-900/80 px-3 py-1.5 rounded-lg text-white border border-blue-700 shadow">
                                <i class="fas fa-phone text-blue-300"></i>
                                <span>{{ db.teacherInfo.phone }}</span>
                            </div>
                            <div v-if="db.teacherInfo.email"
                                class="flex items-center gap-2 bg-blue-900/80 px-3 py-1.5 rounded-lg text-white border border-blue-700 shadow">
                                <i class="fas fa-envelope text-blue-300"></i>
                                <span class="truncate max-w-[150px]">{{ db.teacherInfo.email }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AUCUNE CLASSE - Bannière d'information (non bloquante) -->
                <div v-if="db.classes.length === 0" class="w-full mb-4">
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-3 text-center">
                        <div class="flex items-center justify-center gap-2 mb-2">
                            <i class="fas fa-school text-amber-500"></i>
                            <h2 class="text-base font-semibold text-amber-800">{{ t('welcome_title') }}</h2>
                        </div>
                        <p class="text-amber-700 text-sm mb-2">{{ t('create_first_class_hint') }}</p>
                        <button @click="showClassModal = true"
                            class="px-4 py-1.5 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition text-sm">
                            <i class="fas fa-plus ms-1"></i> {{ t('create_class') }}
                        </button>
                    </div>
                </div>

                <!-- VUE DES ÉLÈVES -->
                <div v-if="currentTab === 'students'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div
                            class="p-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <div class="flex-1">
                                <h2 class="text-lg font-semibold text-slate-800">
                                    {{ t('students_title') }} <span class="text-sm font-normal text-slate-500">({{
                                        filteredStudents.length }})</span>
                                </h2>
                            </div>
                            <div class="flex flex-wrap gap-2 items-center">
                                <!-- Champ de recherche -->
                                <div class="relative">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input v-model="searchQuery" type="text" :placeholder="t('search_placeholder')"
                                        class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none w-48">
                                </div>
                                <label
                                    class="px-3 py-2 bg-emerald-50 text-emerald-700 rounded-lg cursor-pointer hover:bg-emerald-100 transition text-sm font-medium">
                                    <i class="fas fa-file-excel ms-1"></i> {{ t('import') }}
                                    <input type="file" @change="importExcel" accept=".xlsx" class="hidden">
                                </label>
                                <button @click="showStudentModal = true"
                                    class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                                    <i class="fas fa-plus ms-1"></i> {{ t('add') }}
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50">
                                    <tr class="text-start text-sm font-medium text-slate-600">
                                        <th class="px-4 py-3">{{ t('lastname') }}</th>
                                        <th class="px-4 py-3">{{ t('firstname') }}</th>
                                        <th class="px-4 py-3 text-center">{{ t('average') }}</th>
                                        <th class="px-4 py-3 text-end">{{ t('actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr v-for="(student, idx) in filteredStudents" :key="student.id"
                                        class="hover:bg-slate-50 transition">
                                        <td class="px-4 py-3 font-medium text-slate-800">{{ student.lastname }}</td>
                                        <td class="px-4 py-3 text-slate-600">{{ student.firstname }}</td>
                                        <td class="px-4 py-3 text-center">
                                            <span :class="getGradeBadgeClass(student)">{{ calculateAverage(student)
                                                }}</span>
                                        </td>
                                        <td class="px-4 py-3 text-end">
                                            <button @click="deleteStudent(idx)"
                                                class="text-slate-400 hover:text-red-500 transition p-1">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="filteredStudents.length === 0">
                                        <td colspan="4" class="px-4 py-8 text-center text-slate-400">
                                            {{ searchQuery ? t('no_results') : t('no_students') }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VUE LISTE DES ÉLÈVES -->
                <div v-if="currentTab === 'eleves'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div
                            class="p-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <h2 class="text-lg font-semibold text-slate-800">
                                {{ t('students_list_title') }}
                                <span v-if="currentSubject" class="text-sm font-normal text-purple-600 ms-2">
                                    <i class="fas fa-book ms-1"></i>{{ currentSubject.name }}
                                </span>
                                <span v-else-if="currentSubjectId === null"
                                    class="text-sm font-normal text-slate-400 ms-2">
                                    <i class="fas fa-layer-group ms-1"></i>{{ t('all_subjects') }}
                                </span>
                            </h2>
                            <div class="flex flex-wrap gap-2 items-center">
                                <!-- Champ de recherche -->
                                <div class="relative">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input v-model="searchQuery" type="text" :placeholder="t('search_placeholder')"
                                        class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none w-48">
                                </div>
                                <label
                                    class="px-3 py-2 bg-emerald-50 text-emerald-700 rounded-lg cursor-pointer hover:bg-emerald-100 transition text-sm font-medium">
                                    <i class="fas fa-file-excel ms-1"></i> {{ t('import') }}
                                    <input type="file" @change="importExcel" accept=".xlsx" class="hidden">
                                </label>
                                <button @click="showStudentModal = true"
                                    class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                                    <i class="fas fa-plus ms-1"></i> {{ t('add') }}
                                </button>
                            </div>
                        </div>

                        <div v-if="filteredStudents.length === 0" class="p-8 text-center text-slate-400">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <p>{{ searchQuery ? t('no_results') : t('no_students_list_msg') }}</p>
                            <p v-if="!searchQuery" class="text-sm mt-2">{{ t('add_student_hint') }}</p>
                        </div>

                        <div v-else class="grid gap-3 p-4 sm:grid-cols-2 lg:grid-cols-3">
                            <div v-for="student in filteredStudents" :key="student.id"
                                @click="selectedStudent = student"
                                class="border border-slate-200 rounded-xl p-4 hover:shadow-md hover:border-indigo-300 cursor-pointer transition bg-white">
                                <div class="flex items-start gap-3">
                                    <div
                                        class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                                        <img v-if="student.photo" :src="student.photo"
                                            class="w-full h-full object-cover">
                                        <i v-else class="fas fa-user text-indigo-600"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-semibold text-slate-800 truncate">{{ student.lastname }} {{
                                            student.firstname }}</div>
                                        <div v-if="student.student_id" class="text-xs text-slate-400 mt-0.5">{{
                                            student.student_id }}</div>
                                        <div class="text-sm text-slate-500 mt-1">
                                            <span class="inline-flex items-center gap-1">
                                                <i class="fas fa-chart-line text-xs"></i>
                                                {{ t('mean') }} {{ calculateAverage(student) }}
                                            </span>
                                        </div>
                                        <div class="text-xs text-slate-400 mt-1 flex flex-wrap gap-2">
                                            <span class="text-red-500">{{ getAttendanceCount(student.id, 'absent') }} {{
                                                t('absent_count') }}</span>
                                            <span class="text-amber-500">{{ getAttendanceCount(student.id, 'late') }} {{
                                                t('late_count') }}</span>
                                            <span class="text-yellow-500">{{ getAppreciationCount(student.id, 'star') }}
                                                <i class="fas fa-star text-[10px]"></i></span>
                                            <span class="text-red-500">{{ getAppreciationCount(student.id, 'stop') }} <i
                                                    class="fas fa-stop text-[10px]"></i></span>
                                        </div>
                                        <div v-if="student.phone" class="text-xs text-slate-400 mt-1">
                                            <i class="fas fa-phone text-xs mr-1"></i>{{ student.phone }}
                                        </div>
                                        <div v-if="student.birthdate" class="text-xs text-slate-400 mt-1">
                                            <i class="fas fa-calendar text-xs mr-1"></i>{{
                                            formatDateFull(student.birthdate) }}
                                        </div>
                                        <div v-if="student.parent_father_email" class="text-xs text-slate-400 mt-1">
                                            <i class="fas fa-envelope text-xs mr-1 text-blue-400"></i>
                                            <a :href="'mailto:' + student.parent_father_email"
                                                class="text-blue-600 hover:text-blue-800" @click.stop>{{
                                                student.parent_father_email }}</a>
                                        </div>
                                        <div v-if="student.parent_mother_email" class="text-xs text-slate-400 mt-1">
                                            <i class="fas fa-envelope text-xs mr-1 text-purple-400"></i>
                                            <a :href="'mailto:' + student.parent_mother_email"
                                                class="text-purple-600 hover:text-purple-800" @click.stop>{{
                                                student.parent_mother_email }}</a>
                                        </div>
                                    </div>
                                    <div class="text-slate-400 hover:text-slate-600">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE DES NOTES -->
                <div v-if="currentTab === 'grades'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div
                            class="p-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <h2 class="text-lg font-semibold text-slate-800">
                                {{ t('grades_title') }}
                                <span v-if="currentSubject" class="text-sm font-normal text-purple-600 ms-2">
                                    <i class="fas fa-book ms-1"></i>{{ currentSubject.name }}
                                </span>
                                <span v-else-if="currentSubjectId === null"
                                    class="text-sm font-normal text-slate-400 ms-2">
                                    <i class="fas fa-layer-group ms-1"></i>{{ t('all_subjects') }}
                                </span>
                            </h2>
                            <div class="flex flex-wrap gap-2 items-center">
                                <!-- Champ de recherche -->
                                <div class="relative">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input v-model="searchQuery" type="text" :placeholder="t('search_placeholder')"
                                        class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none w-48">
                                </div>
                                <button @click="showExamModal = true"
                                    class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                                    <i class="fas fa-plus ms-1"></i> {{ t('new_evaluation') }}
                                </button>
                                <button @click="showExportModal = true"
                                    class="px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition text-sm font-medium">
                                    <i class="fas fa-file-excel ms-1"></i> {{ t('export_grades') }}
                                </button>
                            </div>
                        </div>

                        <!-- Tableau des notes -->
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50">
                                    <!-- Ligne 1: En-têtes des trimestres -->
                                    <tr class="text-left text-sm font-medium text-slate-600 border-b border-slate-200">
                                        <th class="px-4 py-3 sticky left-0 bg-slate-50 min-w-[150px] z-20 shadow-sm">{{
                                            t('tab_students') }}</th>
                                        <template v-for="(tri, triIdx) in currentTrimesters" :key="tri.id">
                                            <template v-if="getTrimesterExamCount(tri.id) > 0">
                                                <th :colspan="getTrimesterExamCount(tri.id) + 2"
                                                    class="px-4 py-3 text-center bg-amber-50 text-amber-800 border-x border-amber-100 min-w-[180px]">
                                                    {{ tri.name }}
                                                </th>
                                            </template>
                                        </template>
                                        <!-- Colonne pour nouvelle évaluation -->
                                        <th
                                            class="px-4 py-3 text-center min-w-[100px] bg-indigo-50 border-l border-indigo-100 z-10">
                                            <button @click="showExamModal = true"
                                                class="flex items-center justify-center gap-1 text-indigo-600 hover:text-indigo-800 transition"
                                                :title="t('new_evaluation')">
                                                <i class="fas fa-plus-circle"></i>
                                                <span class="text-sm">{{ t('new_evaluation') }}</span>
                                            </button>
                                        </th>
                                        <!-- Moyenne annuelle -->
                                        <th v-if="currentTrimesters.length > 0"
                                            class="px-4 py-3 text-center min-w-[80px] bg-emerald-50 text-emerald-700 border-l border-emerald-100">
                                            {{ t('annual_average') }}
                                        </th>
                                    </tr>
                                    <!-- Ligne 2: En-têtes des examens -->
                                    <tr class="text-left text-xs font-medium text-slate-500 border-b border-slate-200">
                                        <th class="px-4 py-2 sticky left-0 bg-slate-50 min-w-[150px] z-10"></th>
                                        <template v-for="(tri, triIdx) in currentTrimesters" :key="tri.id">
                                            <template
                                                v-for="(exam, examIdx) in filteredExams.filter(e => e.trimesterId === tri.id)"
                                                :key="exam.id">
                                                <th class="px-2 py-2 text-center min-w-[80px]">
                                                    <span class="text-indigo-700">{{ exam.name }}</span>
                                                    <span class="text-slate-400 block text-[10px]">{{ exam.max }}/{{
                                                        exam.coeff }}</span>
                                                </th>
                                            </template>
                                            <!-- En-tête moyenne trimestre -->
                                            <template v-if="getTrimesterExamCount(tri.id) > 0">
                                                <th
                                                    class="px-2 py-2 text-center min-w-[60px] bg-amber-50 text-amber-700">
                                                    {{ t('trimester_average') }}
                                                </th>
                                                <th
                                                    class="px-2 py-2 text-center min-w-[40px] bg-amber-50 text-amber-700">
                                                    <i class="fas fa-comment-alt text-xs"></i>
                                                </th>
                                            </template>
                                        </template>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <template v-for="student in filteredStudents" :key="student.id">
                                        <tr class="hover:bg-slate-50">
                                            <!-- Info élève -->
                                            <td
                                                class="px-4 py-3 font-medium text-slate-800 sticky left-0 bg-white z-10 border-r border-slate-100">
                                                <div class="flex items-center gap-2">
                                                    <div
                                                        class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                                                        <img v-if="student.photo" :src="student.photo"
                                                            class="w-full h-full object-cover">
                                                        <i v-else class="fas fa-user text-indigo-600 text-xs"></i>
                                                    </div>
                                                    <div>
                                                        <div>{{ student.lastname }} {{ student.firstname }}</div>
                                                        <div v-if="student.student_id" class="text-xs text-slate-400">{{
                                                            student.student_id }}</div>
                                                    </div>
                                                </div>
                                            </td>

                                            <!-- Évaluations et données par trimestre -->
                                            <template v-for="(tri, triIdx) in currentTrimesters" :key="tri.id">
                                                <!-- Évaluations du trimestre -->
                                                <td v-for="exam in filteredExams.filter(e => e.trimesterId === tri.id)"
                                                    :key="exam.id" class="px-0">
                                                    <input type="number" v-model.number="student.grades[exam.id]"
                                                        class="w-full px-4 py-3 text-center bg-transparent focus:bg-indigo-50 focus:outline-none"
                                                        placeholder="-" :min="0" :max="exam.max">
                                                </td>
                                                <!-- Moyenne du trimestre -->
                                                <template v-if="getTrimesterExamCount(tri.id) > 0">
                                                    <td class="px-2 py-3 text-center bg-amber-50 min-w-[60px]">
                                                        <span
                                                            :class="['font-bold text-sm', 
                                                        calculateTrimesterAverage(student, tri.id) !== '-' && parseFloat(calculateTrimesterAverage(student, tri.id)) < 5 ? 'text-red-600' : 'text-amber-700']">
                                                            {{ calculateTrimesterAverage(student, tri.id) }}
                                                        </span>
                                                    </td>
                                                    <!-- Observation du trimestre -->
                                                    <td class="px-2 py-3 text-center bg-amber-50 min-w-[40px]">
                                                        <button @click="promptObservation(student, tri)"
                                                            class="p-1.5 rounded hover:bg-amber-200 transition"
                                                            :title="t('trimester_observation')">
                                                            <i
                                                                :class="['fas text-sm', getTrimesterObservation(student, tri.id) ? 'fa-comment text-amber-600' : 'fa-comment-alt text-slate-300']"></i>
                                                        </button>
                                                    </td>
                                                </template>
                                            </template>

                                            <!-- Colonne vide pour le bouton "Nouvelle évaluation" -->
                                            <td class="bg-indigo-50/30 border-l border-indigo-100"></td>

                                            <!-- Moyenne annuelle -->
                                            <td v-if="currentTrimesters.length > 0"
                                                class="px-4 py-3 text-center font-bold text-emerald-700 bg-emerald-50 min-w-[80px] text-sm">
                                                {{ calculateAnnualAverage(student) }}
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <!-- Message si aucun élève -->
                        <div v-if="currentClass.students.length === 0" class="p-8 text-center text-slate-400">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <p>{{ t('no_students') }}</p>
                        </div>
                    </div>
                </div>

                <!-- VUE DES PRÉSENCES -->
                <div v-if="currentTab === 'attendance'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div
                            class="p-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <h2 class="text-lg font-semibold text-slate-800">{{ t('attendance_title') }}</h2>
                            <div class="flex flex-wrap gap-2 items-center">
                                <!-- Champ de recherche -->
                                <div class="relative">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input v-model="searchQuery" type="text" :placeholder="t('search_placeholder')"
                                        class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none w-48">
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-calendar-alt text-slate-400"></i>
                                    <input type="date" v-model="attendanceDate"
                                        class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                        </div>

                        <div v-if="filteredStudents.length === 0" class="p-8 text-center text-slate-400">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <p>{{ searchQuery ? t('no_results') : t('no_students') }}</p>
                        </div>

                        <div v-else class="p-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                            <div v-for="student in filteredStudents" :key="student.id"
                                class="border border-slate-200 rounded-xl p-4 hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="font-semibold text-slate-800">{{ student.lastname }}</div>
                                        <div class="text-sm text-slate-500">{{ student.firstname }}</div>
                                    </div>
                                    <div class="text-xs text-slate-400 text-end">
                                        <div class="text-red-500">{{ getAttendanceCount(student.id, 'absent') }} {{
                                            t('absent_count') }}</div>
                                        <div class="text-amber-500">{{ getAttendanceCount(student.id, 'late') }} {{
                                            t('late_count') }}</div>
                                        <div class="text-yellow-500">{{ getAppreciationCount(student.id, 'star') }} <i
                                                class="fas fa-star text-[10px]"></i></div>
                                        <div class="text-red-500">{{ getAppreciationCount(student.id, 'stop') }} <i
                                                class="fas fa-stop text-[10px]"></i></div>
                                    </div>
                                </div>
                                <!-- Boutons de présence -->
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <button @click="setAttendance(student.id, 'present')"
                                        :style="getAttendanceStyle(student.id, 'present')"
                                        :class="['py-2 rounded-lg text-sm font-medium transition border', getAttendanceClass(student.id, 'present')]">
                                        {{ t('present') }}
                                    </button>
                                    <button @click="setAttendance(student.id, 'absent')"
                                        :style="getAttendanceStyle(student.id, 'absent')"
                                        :class="['py-2 rounded-lg text-sm font-medium transition border', getAttendanceClass(student.id, 'absent')]">
                                        {{ t('absent') }}
                                    </button>
                                    <button @click="setAttendance(student.id, 'late')"
                                        :style="getAttendanceStyle(student.id, 'late')"
                                        :class="['py-2 rounded-lg text-sm font-medium transition border', getAttendanceClass(student.id, 'late')]">
                                        {{ t('late_word') }}
                                    </button>
                                </div>
                                <!-- Boutons d'appréciation -->
                                <div class="grid grid-cols-2 gap-2">
                                    <button @click="setAppreciation(student.id, 'star')"
                                        :class="['py-2 rounded-lg text-sm font-medium transition border', getAppreciationClass(student.id, 'star')]"
                                        :title="t('good_appreciation')">
                                        <i :class="['fas', getAppreciationIcon(student.id, 'star')]"></i>
                                    </button>
                                    <button @click="setAppreciation(student.id, 'stop')"
                                        :class="['py-2 rounded-lg text-sm font-medium transition border', getAppreciationClass(student.id, 'stop')]"
                                        :title="t('bad_appreciation')">
                                        <i :class="['fas', getAppreciationIcon(student.id, 'stop')]"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE DU PLANNING -->
                <div v-if="currentTab === 'planner'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div
                            class="p-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <h2 class="text-lg font-semibold text-slate-800">{{ t('planning_title') }}</h2>
                            <div class="flex flex-wrap gap-2 items-center">
                                <!-- Champ de recherche pour le planning -->
                                <div class="relative">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input v-model="searchPlanningQuery" type="text" :placeholder="t('search_planning')"
                                        class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none w-48">
                                </div>
                                <button @click="addPlannerItem"
                                    class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                                    <i class="fas fa-plus ms-1"></i> {{ t('add_planning') }}
                                </button>
                            </div>
                        </div>

                        <div class="p-4 space-y-3">
                            <div v-for="(item, idx) in filteredPlanner" :key="idx"
                                class="border border-slate-200 border-l-4 border-l-indigo-500 rounded-lg p-4 hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-1">
                                        <input type="date" v-model="item.date"
                                            class="text-sm font-medium text-indigo-600 bg-indigo-50 px-2 py-1 rounded ms-2">
                                        <input type="text" v-model="item.title"
                                            :placeholder="t('planning_session_title')"
                                            class="font-semibold text-slate-800 border-b border-transparent hover:border-slate-300 focus:border-indigo-500 focus:outline-none">
                                    </div>
                                    <button @click="deletePlannerItem(idx)"
                                        class="text-slate-400 hover:text-red-500 transition">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                <textarea v-model="item.content" :placeholder="t('planning_content')"
                                    class="w-full mt-2 p-3 bg-slate-50 rounded-lg text-sm text-slate-600 resize-none focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-200"
                                    rows="2"></textarea>
                            </div>

                            <div v-if="filteredPlanner.length === 0" class="p-8 text-center text-slate-400">
                                {{ searchPlanningQuery ? t('no_results') : t('no_planning') }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE INFORMATIONS ENSEIGNANT -->
                <div v-if="currentTab === 'teacher'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div class="p-4 border-b border-slate-200">
                            <h2 class="text-lg font-semibold text-slate-800">{{ t('teacher_info_title') }}</h2>
                        </div>

                        <div class="p-6 space-y-6">
                            <!-- Informations personnelles -->
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('teacher_name')
                                        }}</label>
                                    <input v-model="db.teacherInfo.lastname" type="text" disabled
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-slate-50 cursor-not-allowed"
                                        :placeholder="t('teacher_name')">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{
                                        t('teacher_firstname') }}</label>
                                    <input v-model="db.teacherInfo.firstname" type="text" disabled
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-slate-50 cursor-not-allowed"
                                        :placeholder="t('teacher_firstname')">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('phone')
                                        }}</label>
                                    <input v-model="db.teacherInfo.phone" type="tel"
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                        :placeholder="t('phone')">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('email')
                                        }}</label>
                                    <input v-model="db.teacherInfo.email" type="email"
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                        :placeholder="t('email')">
                                </div>
                            </div>

                            <!-- Année scolaire et type d'enseignant -->
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('school_year')
                                        }}</label>
                                    <input v-model="db.teacherInfo.schoolYear" type="text"
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                        :placeholder="t('school_year')">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('teacher_type')
                                        }}</label>
                                    <select v-model="db.teacherInfo.teacherType"
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">{{ t('select_establishment') }}</option>
                                        <option value="professor">{{ t('type_professor') }}</option>
                                        <option value="institute">{{ t('type_institute') }}</option>
                                        <option value="supeur">{{ t('type_supeur') }}</option>
                                        <option value="other">{{ t('type_other') }}</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Établissement principal -->
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('main_establishment')
                                    }}</label>
                                <select v-model="db.teacherInfo.mainEstablishment"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">{{ t('select_establishment') }}</option>
                                    <option v-for="est in db.establishments" :key="est.id" :value="est.id">
                                        {{ est.name }}
                                    </option>
                                </select>
                            </div>

                            <!-- Champs officiels pour les documents -->
                            <div>
                                <h3 class="text-sm font-medium text-slate-600 mb-3">{{ t('official_header_fields') }}
                                </h3>
                                <div class="grid gap-4 sm:grid-cols-3">
                                    <div>
                                        <input v-model="db.teacherInfo.fieldRepublic" type="text"
                                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            :placeholder="t('field_republic')">
                                    </div>
                                    <div>
                                        <input v-model="db.teacherInfo.fieldMinistry" type="text"
                                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            :placeholder="t('field_ministry')">
                                    </div>
                                    <div>
                                        <input v-model="db.teacherInfo.fieldDirectorate" type="text"
                                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            :placeholder="t('field_directorate') + ' ...'">
                                    </div>
                                </div>
                            </div>

                            <!-- Établissements secondaires -->
                            <div>
                                <div class="flex items-center justify-between mb-3">
                                    <label class="block text-sm font-medium text-slate-600">{{
                                        t('secondary_establishments') }}</label>
                                    <button @click="showEstablishmentModal = true"
                                        class="px-3 py-1 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition">
                                        <i class="fas fa-plus ms-1"></i>{{ t('add_establishment') }}
                                    </button>
                                </div>

                                <div v-if="db.establishments.length === 0"
                                    class="p-6 text-center text-slate-400 bg-slate-50 rounded-lg">
                                    <i class="fas fa-building text-3xl mb-2"></i>
                                    <p>{{ t('no_establishments') }}</p>
                                </div>

                                <div v-else class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                                    <div v-for="est in db.establishments" :key="est.id"
                                        class="p-4 border border-slate-200 rounded-lg hover:shadow-md transition">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <h4 class="font-medium text-slate-800">{{ est.name }}</h4>
                                                <p v-if="est.address" class="text-sm text-slate-500 mt-1">{{ est.address
                                                    }}</p>
                                                <p v-if="est.phone" class="text-sm text-slate-500">{{ est.phone }}</p>
                                                <!-- Classes liées -->
                                                <div v-if="getEstablishmentClasses(est).length > 0"
                                                    class="mt-2 flex flex-wrap gap-1">
                                                    <span v-for="(clsName, idx) in getEstablishmentClasses(est)"
                                                        :key="idx"
                                                        class="px-2 py-0.5 bg-indigo-50 text-indigo-700 text-xs rounded">
                                                        {{ clsName }}
                                                    </span>
                                                </div>
                                                <div v-else class="mt-2 text-xs text-slate-400">
                                                    {{ t('no_classes_linked') }}
                                                </div>
                                            </div>
                                            <div class="flex gap-1">
                                                <button @click="openEstablishmentModal(est)"
                                                    class="text-slate-400 hover:text-indigo-500 transition p-1"
                                                    :title="t('edit_establishment')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button @click="deleteEstablishment(est.id)"
                                                    class="text-slate-400 hover:text-red-500 transition p-1"
                                                    :title="t('delete_establishment')">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE DES RAPPORTS -->
                <div v-if="currentTab === 'reports'">
                    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                        <!-- Statistiques -->
                        <div
                            class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 sm:col-span-2 lg:col-span-2">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('stats_title') }}</h3>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div class="p-4 bg-indigo-50 rounded-xl">
                                    <div class="text-3xl font-bold text-indigo-600">{{ classStats.average }}</div>
                                    <div class="text-sm text-indigo-600 font-medium">{{ t('class_average') }}</div>
                                </div>
                                <div class="p-4 bg-emerald-50 rounded-xl">
                                    <div class="text-3xl font-bold text-emerald-600">{{ classStats.highest }}</div>
                                    <div class="text-sm text-emerald-600 font-medium">{{ t('highest_grade') }}</div>
                                </div>
                                <div class="p-4 bg-red-50 rounded-xl">
                                    <div class="text-3xl font-bold text-red-600">{{ classStats.lowest }}</div>
                                    <div class="text-sm text-red-600 font-medium">{{ t('lowest_grade') }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Export -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('export') }}</h3>
                            <button @click="exportToExcel"
                                class="w-full py-3 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition flex items-center justify-center">
                                <i class="fas fa-file-excel ms-2"></i>
                                {{ t('export_excel') }}
                            </button>
                            <p class="text-xs text-slate-500 mt-3 text-center">
                                {{ t('export_desc') }}
                            </p>
                        </div>
                    </div>
                </div>

            </main>
        </div>

        <!-- ==================== -->
        <!-- MODALS -->
        <!-- ==================== -->

        <!-- Modal Élève -->
        <div v-if="showStudentModal"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 mx-auto relative">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('modal_new_student') }}</h3>
                <div class="space-y-3">
                    <!-- Photo upload -->
                    <div class="flex flex-col items-center mb-4">
                        <div
                            class="w-20 h-20 rounded-full overflow-hidden bg-slate-100 border-2 border-slate-200 flex items-center justify-center">
                            <img v-if="newStudent.photo" :src="newStudent.photo" class="w-full h-full object-cover">
                            <i v-else class="fas fa-user text-3xl text-slate-300"></i>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <label
                                class="px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg cursor-pointer hover:bg-indigo-100 transition text-xs font-medium">
                                <i class="fas fa-camera ms-1"></i> {{ t('upload_photo') }}
                                <input type="file" @change="handlePhotoUpload" accept="image/*" class="hidden">
                            </label>
                            <button v-if="newStudent.photo" @click="removeStudentPhoto"
                                class="px-3 py-1.5 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition text-xs font-medium">
                                <i class="fas fa-times ms-1"></i> {{ t('remove_photo') }}
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">{{ t('photo_hint') }}</p>
                    </div>

                    <!-- ID field -->
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('student_id') }}</label>
                        <input v-model="newStudent.student_id" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('student_id')">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('lastname') }}</label>
                            <input v-model="newStudent.lastname" type="text"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('lastname')" autofocus>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('firstname') }}</label>
                            <input v-model="newStudent.firstname" type="text"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('firstname')">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('birthdate') }}</label>
                        <input v-model="newStudent.birthdate" type="date"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('address') }}</label>
                        <textarea v-model="newStudent.address"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 resize-none"
                            :placeholder="t('address')" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('phone_parents') }}</label>
                        <input v-model="newStudent.phone" type="tel"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            placeholder="01 23 45 67 89">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('father') }}</label>
                            <input v-model="newStudent.parent_father" type="text"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('father')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('father_email') }}</label>
                            <input v-model="newStudent.parent_father_email" type="email"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('father_email')">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('mother') }}</label>
                            <input v-model="newStudent.parent_mother" type="text"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('mother')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('mother_email') }}</label>
                            <input v-model="newStudent.parent_mother_email" type="email"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('mother_email')">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showStudentModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button @click="addStudent"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">{{
                        t('add_student_btn') }}</button>
                </div>
            </div>
        </div>

        <!-- Modal Évaluation -->
        <div v-if="showExamModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('modal_new_evaluation') }}</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('evaluation_subject')
                            }}</label>
                        <select v-model="newExam.subjectId"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option v-for="subject in currentSubjects" :key="subject.id" :value="subject.id">
                                {{ subject.name }}
                            </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('evaluation_trimester')
                            }}</label>
                        <select v-model="newExam.trimesterId"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option v-for="tri in currentTrimesters" :key="tri.id" :value="tri.id">
                                {{ tri.name }}
                            </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('evaluation_name') }}</label>
                        <input v-model="newExam.name" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('evaluation_name')" autofocus>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('evaluation_max')
                                }}</label>
                            <input v-model.number="newExam.max" type="number"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('evaluation_coeff')
                                }}</label>
                            <input v-model.number="newExam.coeff" type="number"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="1" min="1">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showExamModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button @click="addExam"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">{{
                        t('create') }}</button>
                </div>
            </div>
        </div>

        <!-- Modal Gestion des Matières -->
        <div v-if="showSubjectModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('modal_subjects') }}</h3>
                <p class="text-sm text-slate-500 mb-4">{{ t('class_subject') }} {{ currentClass?.name }}</p>

                <!-- Liste des matières -->
                <div class="max-h-48 overflow-y-auto space-y-2 mb-4">
                    <div v-for="subject in currentSubjects" :key="subject.id"
                        class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <span class="font-medium text-slate-700">{{ subject.name }}</span>
                        <button @click="deleteSubject(subject.id)"
                            class="text-slate-400 hover:text-red-500 transition p-1" :title="t('delete_subject')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div v-if="currentSubjects.length === 0" class="p-4 text-center text-slate-400">
                        <i class="fas fa-book text-2xl mb-2"></i>
                        <p>{{ t('no_subject') }}</p>
                    </div>
                </div>

                <!-- Ajouter une matière -->
                <div class="flex gap-2">
                    <input v-model="newSubjectName" type="text" @keyup.enter="addSubject"
                        class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        :placeholder="t('add_subject')">
                    <button @click="addSubject"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showSubjectModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('close')
                        }}</button>
                </div>
            </div>
        </div>

        <!-- Modal Gestion des Trimestres -->
        <div v-if="showTrimesterModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('manage_trimesters') }}</h3>
                <p class="text-sm text-slate-500 mb-4">{{ t('class_subject') }} {{ currentClass?.name }}</p>

                <!-- Liste des trimestres -->
                <div class="max-h-48 overflow-y-auto space-y-2 mb-4">
                    <div v-for="tri in currentTrimesters" :key="tri.id"
                        class="flex items-center justify-between p-3 bg-amber-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium text-slate-700">{{ tri.name }}</span>
                            <div v-if="tri.observation" class="text-xs text-slate-500 mt-1 truncate">{{ tri.observation
                                }}</div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button @click="editTrimester(tri)"
                                class="p-1.5 text-slate-400 hover:text-indigo-600 transition rounded"
                                :title="t('edit')">
                                <i class="fas fa-edit text-xs"></i>
                            </button>
                            <button @click="deleteTrimester(tri.id)"
                                class="p-1.5 text-slate-400 hover:text-red-500 transition rounded" :title="t('delete')">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div v-if="currentTrimesters.length === 0" class="p-4 text-center text-slate-400">
                        <i class="fas fa-calendar-alt text-2xl mb-2"></i>
                        <p>{{ t('no_trimesters') }}</p>
                    </div>
                </div>

                <!-- Formulaire -->
                <div class="border-t border-slate-200 pt-4">
                    <input v-model="newTrimester.name" type="text"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 mb-3"
                        :placeholder="t('trimester_name')">
                    <textarea v-model="newTrimester.observation"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 mb-3"
                        :placeholder="t('trimester_observation_hint')" rows="2"></textarea>
                </div>

                <div class="flex justify-end gap-2 mt-4">
                    <button @click="showTrimesterModal = false; resetTrimesterForm()"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button @click="saveTrimester"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">{{
                        t('save') }}</button>
                </div>
            </div>
        </div>

        <!-- Modal Détails Élève -->
        <div v-if="selectedStudent"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl mx-auto relative">

                <!-- En-tête -->
                <div class="sticky top-0 bg-white border-b border-slate-200 p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center overflow-hidden">
                            <img v-if="selectedStudent.photo" :src="selectedStudent.photo"
                                class="w-full h-full object-cover">
                            <i v-else class="fas fa-user text-indigo-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-slate-800">{{ selectedStudent.lastname }} {{
                                selectedStudent.firstname }}</h3>
                            <p v-if="selectedStudent.student_id" class="text-sm text-slate-500">{{
                                selectedStudent.student_id }}</p>
                            <p v-else class="text-sm text-slate-500">{{ currentClass?.name }}</p>
                        </div>
                    </div>
                    <button @click="selectedStudent = null" class="text-slate-400 hover:text-slate-600 p-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Contenu -->
                <div class="p-4 space-y-4 overflow-y-auto" style="max-height: 70vh;">

                    <!-- Photo et ID -->
                    <div class="flex items-center gap-4 bg-slate-50 rounded-lg p-4">
                        <div
                            class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center overflow-hidden flex-shrink-0">
                            <img v-if="selectedStudent.photo" :src="selectedStudent.photo"
                                class="w-full h-full object-cover">
                            <i v-else class="fas fa-user text-2xl text-indigo-600"></i>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('student_id') }}</label>
                            <input v-model="selectedStudent.student_id" type="text"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('student_id')">
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <label
                                class="px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg cursor-pointer hover:bg-indigo-100 transition text-xs font-medium">
                                <i class="fas fa-camera ms-1"></i> {{ t('upload_photo') }}
                                <input type="file" @change="(e) => handleDetailPhotoUpload(e, selectedStudent)"
                                    accept="image/*" class="hidden">
                            </label>
                            <button v-if="selectedStudent.photo" @click="removeDetailPhoto(selectedStudent)"
                                class="px-3 py-1.5 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition text-xs font-medium">
                                <i class="fas fa-times ms-1"></i> {{ t('remove_photo') }}
                            </button>
                        </div>
                    </div>

                    <!-- Informations personnelles -->
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2 text-sm">{{ t('personal_info') }}</h4>
                        <div class="bg-slate-50 rounded-lg p-3 space-y-2">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-slate-500">{{ t('lastname') }}</label>
                                    <input v-model="selectedStudent.lastname" type="text"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">{{ t('firstname') }}</label>
                                    <input v-model="selectedStudent.firstname" type="text"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500">{{ t('birthdate') }}</label>
                                <input v-model="selectedStudent.birthdate" type="date"
                                    class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="text-xs text-slate-500">Adresse</label>
                                <textarea v-model="selectedStudent.address"
                                    class="w-full px-2 py-1 border rounded text-sm resize-none" rows="2"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-slate-500">Téléphone</label>
                                    <input v-model="selectedStudent.phone" type="tel"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">Père / Tuteur</label>
                                    <input v-model="selectedStudent.parent_father" type="text"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">Email Père</label>
                                    <input v-model="selectedStudent.parent_father_email" type="email"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">Mère / Tutrice</label>
                                    <input v-model="selectedStudent.parent_mother" type="text"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">Email Mère</label>
                                    <input v-model="selectedStudent.parent_mother_email" type="email"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques -->
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-indigo-50 rounded-lg p-2 text-center">
                            <div class="text-lg font-bold text-indigo-600">{{ calculateAverage(selectedStudent) }}</div>
                            <div class="text-xs text-indigo-500">Moyenne</div>
                        </div>
                        <div class="bg-emerald-50 rounded-lg p-2 text-center">
                            <div class="text-lg font-bold text-emerald-600">{{ getStudentSubjectAverage(selectedStudent)
                                }}</div>
                            <div class="text-xs text-emerald-500">Matière</div>
                        </div>
                        <div class="bg-amber-50 rounded-lg p-2 text-center">
                            <div class="text-lg font-bold text-amber-500">{{ getAttendanceCount(selectedStudent,
                                'absent') }}</div>
                            <div class="text-xs text-amber-500">Absences</div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2 text-sm">Notes</h4>
                        <div class="bg-slate-50 rounded-lg overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-100">
                                    <tr class="text-left text-xs">
                                        <th class="px-2 py-1">Évaluation</th>
                                        <th class="px-2 py-1">Note</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="exam in filteredExams" :key="exam.id" class="border-t">
                                        <td class="px-2 py-1">{{ exam.name }}</td>
                                        <td class="px-2 py-1">
                                            <span :class="getStudentGradeClass(selectedStudent, exam)">
                                                {{ selectedStudent.grades[exam.id] || '-' }}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr v-if="filteredExams.length === 0">
                                        <td colspan="2" class="px-2 py-2 text-center text-slate-400 text-xs">
                                            Aucune évaluation
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Présences -->
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2 text-sm">Présences</h4>
                        <div class="flex flex-wrap gap-1">
                            <span v-for="(status, date) in getStudentAttendance(selectedStudent)" :key="date" :class="['px-2 py-0.5 rounded text-xs', 
                                   status === 'present' ? 'bg-emerald-100 text-emerald-700' :
                                   status === 'absent' ? 'bg-red-100 text-red-700' :
                                   'bg-amber-100 text-amber-700']">
                                {{ formatDateShort(date) }}
                            </span>
                            <span v-if="Object.keys(getStudentAttendance(selectedStudent)).length === 0"
                                class="text-xs text-slate-400">
                                Aucune
                            </span>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal Nouvelle Classe -->
        <div v-if="showClassModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('modal_new_class') }}</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('class_name_label') }}</label>
                        <input v-model="newClassName" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('class_name')" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('subject_label') }}</label>
                        <input v-model="newClassSubject" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('subject_name')">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('establishment_label')
                            }}</label>
                        <div class="flex gap-2">
                            <select v-model="newClassEstablishmentId"
                                class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">{{ t('no_establishment') }}</option>
                                <option v-for="est in db.establishments" :key="est.id" :value="est.id">
                                    {{ est.name }}
                                </option>
                            </select>
                            <button
                                @click="pendingClassIdForEstablishment = Date.now().toString(); openEstablishmentModal(null, true)"
                                class="px-3 py-2 bg-emerald-100 text-emerald-700 rounded-lg hover:bg-emerald-200 transition"
                                :title="t('add_establishment')">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showClassModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button @click="addClass"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">{{
                        t('create') }}</button>
                </div>
            </div>
        </div>

        <!-- Modal Scanner Dossier -->
        <div v-if="showScanModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('modal_scan') }}</h3>
                <p class="text-sm text-slate-500 mb-4">{{ t('select_file') }}</p>

                <div class="max-h-64 overflow-y-auto space-y-2">
                    <button v-for="file in scannedFiles" :key="file.name" @click="openScannedFile(file)"
                        class="w-full flex items-center p-3 bg-slate-50 hover:bg-indigo-50 rounded-lg transition text-start">
                        <i class="fas fa-file-code text-indigo-400 ms-3"></i>
                        <div class="flex-1">
                            <div class="font-medium text-slate-700">{{ file.name }}</div>
                            <div class="text-xs text-slate-400">{{ formatSize(file.size) }}</div>
                        </div>
                    </button>
                    <div v-if="scannedFiles.length === 0" class="p-4 text-center text-slate-400">
                        <i class="fas fa-folder-open text-3xl mb-2"></i>
                        <p>{{ t('no_json_found') }}</p>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showScanModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('close')
                        }}</button>
                </div>
            </div>
        </div>

        <!-- Modal Nouvel Établissement -->
        <div v-if="showEstablishmentModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">
                    {{ editingEstablishment ? t('edit_establishment') : t('add_establishment') }}
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('establishment_name')
                            }}</label>
                        <input v-model="newEstablishment.name" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('establishment_name')" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('establishment_address')
                            }}</label>
                        <input v-model="newEstablishment.address" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('establishment_address')">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('establishment_phone')
                            }}</label>
                        <input v-model="newEstablishment.phone" type="tel"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('establishment_phone')">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('establishment_classes')
                            }}</label>
                        <div class="max-h-32 overflow-y-auto border border-slate-300 rounded-lg p-2 space-y-1">
                            <label v-for="cls in db.classes" :key="cls.id"
                                class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-50 p-1 rounded">
                                <input type="checkbox" :value="cls.id" v-model="newEstablishment.classes"
                                    class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="text-slate-700">{{ cls.name }}</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button @click="resetEstablishmentForm(); showEstablishmentModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button @click="saveEstablishment"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">{{
                        t('save_establishment') }}</button>
                </div>
            </div>
        </div>

        <!-- Modal Établissement de la Classe -->
        <div v-if="showClassEstablishmentModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('select_class_establishment') }}</h3>
                <p class="text-sm text-slate-500 mb-4">
                    {{ t('class') }}: <span class="font-medium text-slate-700">{{ currentClass?.name }}</span>
                </p>
                <div class="space-y-2 max-h-48 overflow-y-auto border border-slate-200 rounded-lg p-2">
                    <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-50 p-2 rounded">
                        <input type="radio" :value="''" :checked="!getCurrentClassEstablishment"
                            @change="assignClassToEstablishment('')"
                            class="border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-slate-700">{{ t('no_establishment') }}</span>
                    </label>
                    <label v-for="est in db.establishments" :key="est.id"
                        class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-50 p-2 rounded">
                        <input type="radio" :value="est.id" :checked="getCurrentClassEstablishment?.id === est.id"
                            @change="assignClassToEstablishment(est.id)"
                            class="border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-slate-700">{{ est.name }}</span>
                    </label>
                    <div v-if="db.establishments.length === 0" class="p-4 text-center text-slate-400 text-sm">
                        {{ t('no_establishments') }}
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showClassEstablishmentModal = false"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        {{ t('close') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Export Trimestre -->
        <div v-if="showExportModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('export_grades_title') }}</h3>

                <div v-if="currentClass?.students?.length === 0" class="p-4 text-center text-slate-400">
                    <i class="fas fa-users text-3xl mb-2"></i>
                    <p>{{ t('no_students_to_export') }}</p>
                </div>

                <div v-else class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">{{ t('select_trimester_export')
                            }}</label>
                        <select v-model="selectedTrimesterExport"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">{{ t('all_trimesters') }}</option>
                            <option v-for="tri in currentTrimesters" :key="tri.id" :value="tri.id">
                                {{ tri.name }}
                            </option>
                        </select>
                    </div>

                    <div v-if="selectedTrimesterExport && getTrimesterExamCount(selectedTrimesterExport) === 0"
                        class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-700">
                        <i class="fas fa-exclamation-triangle ms-1"></i>
                        {{ t('no_exams_for_trimester') }}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">{{ t('select_layout_format')
                            }}</label>
                        <select v-model="exportFormat"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="rtl">{{ t('format_arabic') }}</option>
                            <option value="ltr">{{ t('format_western') }}</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showExportModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button v-if="currentClass?.students?.length > 0" @click="exportGradesToExcel"
                        class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                        <i class="fas fa-file-excel ms-1"></i> {{ t('export_button') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Licence (affiché au-dessus de tout) -->
        <div v-if="showLicenseModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <!-- Logo dans le modal -->
                <div class="text-center mb-4">
                    <img src="Logo-TeacherTrack-Transparent.png" alt="TeacherTrack Logo"
                        style="width: 56px; height: 56px; max-width: 56px; max-height: 56px;"
                        class="mx-auto drop-shadow-lg">
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-4 text-center">
                    <i class="fas fa-key text-indigo-600 me-1"></i> {{ t('license_activation_title') }}
                </h3>

                <div v-if="isLicenseValid && !isChangingLicense" class="text-center py-4">
                    <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-check text-3xl text-emerald-600"></i>
                    </div>
                    <p class="font-bold text-emerald-700 text-lg mb-2">{{ t('license_active') }}</p>
                    <p class="text-slate-600">{{ t('license_owner_label') }}: <span class="font-semibold">{{
                            licenseOwner }}</span></p>
                    <button @click="cancelLicenseModal"
                        class="mt-4 px-6 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition">
                        {{ t('close') }}
                    </button>
                    <button @click="isChangingLicense = true"
                        class="mt-2 block mx-auto text-xs text-slate-400 hover:text-indigo-600 transition">
                        <i class="fas fa-exchange-alt me-1"></i> {{ t('change_license') }}
                    </button>
                </div>

                <div v-else class="space-y-4">
                    <p class="text-sm text-slate-600">{{ t('license_enter_key') }}</p>

                    <!-- Option 1: Saisie manuelle -->
                    <div class="border border-slate-200 rounded-xl p-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-keyboard me-1 text-indigo-500"></i> {{ t('license_manual_entry') }}
                        </label>
                        <input v-model="licenseInput" type="text" :placeholder="t('license_placeholder')"
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg text-center font-mono text-sm tracking-wider uppercase focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" />
                        <button @click="verifyLicense(licenseInput)" :disabled="licenseInput.length < 16"
                            class="w-full mt-3 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-unlock me-1"></i> {{ t('license_activate') }}
                        </button>
                    </div>

                    <!-- Séparateur OU -->
                    <div class="flex items-center gap-3">
                        <div class="flex-1 border-t border-slate-200"></div>
                        <span class="text-sm text-slate-400 font-medium">{{ t('or') }}</span>
                        <div class="flex-1 border-t border-slate-200"></div>
                    </div>

                    <!-- Option 2: Import fichier .txt -->
                    <div class="border border-slate-200 rounded-xl p-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-file-alt me-1 text-purple-500"></i> {{ t('license_select_file') }}
                        </label>
                        <label
                            class="block w-full px-4 py-3 bg-purple-50 border-2 border-dashed border-purple-200 rounded-lg text-center cursor-pointer hover:border-purple-400 hover:bg-purple-100 transition">
                            <i class="fas fa-folder-open text-purple-500 me-2"></i>
                            <span class="text-purple-700 font-medium">{{ t('browse') }}</span>
                            <input type="file" @change="importLicenseFile" accept=".txt" class="hidden">
                        </label>
                        <p class="text-xs text-slate-400 mt-2 text-center">{{ t('license_file_hint') }}</p>
                    </div>

                    <div v-if="licenseError" class="p-3 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-sm text-red-600"><i class="fas fa-exclamation-triangle me-1"></i> {{ licenseError
                            }}</p>
                    </div>

                    <button @click="cancelLicenseModal"
                        class="w-full px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">
                        {{ t('cancel') }}
                    </button>

                    <div class="p-3 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-500 text-center">
                            <i class="fas fa-info-circle me-1"></i> {{ t('license_get_key') }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts avec mécanisme de secours (local → CDN) -->
    <script>
        // Charger Vue.js avec secours
        loadScriptWithFallback('vue-js', 'vue.global.js', 'https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js', function () {
            console.log('✓ Vue.js prêt, initialisation de l\'application...');
            initApp();
        });

        // Charger SheetJS avec secours
        loadScriptWithFallback('xlsx-js', 'xlsx.full.min.js', 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js');
    </script>

    <script>
        // Fonction principale d'initialisation (appelée après le chargement de Vue)
        function initApp() {
            // Vérification que Vue est bien disponible
            if (typeof Vue === 'undefined') {
                document.body.innerHTML = '<div style="padding: 50px; text-align: center; color: red;"><h1>Erreur: Vue.js non chargé</h1><p>Vérifiez que vue.global.js existe dans le dossier.</p></div>';
                throw new Error('Vue.js non chargé');
            }
            console.log('TeacherTrack - Démarrage...');

            const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

            // ==================== INDEXEDDB HELPERS ====================
            const DB_NAME = 'TeacherTrackDB';
            const DB_VERSION = 1;
            const STORE_NAME = 'recentFiles';

            const initDB = () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'path' });
                        }
                    };
                });
            };

            const saveRecentToDB = async (files) => {
                try {
                    const db = await initDB();
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    store.clear();
                    files.forEach(f => {
                        // Stocker seulement les métadonnées (pas le handle qui n'est pas clonable)
                        store.put({ path: f.path, name: f.name, date: f.date });
                    });
                    await tx.complete;
                } catch (e) { console.error('Erreur IndexedDB:', e); }
            };

            const loadRecentFromDB = async () => {
                try {
                    const db = await initDB();
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    return new Promise((resolve) => {
                        const request = store.getAll();
                        request.onsuccess = () => {
                            // Sort by date desc
                            const files = request.result.sort((a, b) => new Date(b.date) - new Date(a.date));
                            resolve(files.slice(0, 5)); // Max 5 files
                        };
                        request.onerror = () => resolve([]);
                    });
                } catch (e) { console.error('Erreur IndexedDB:', e); return []; }
            };

            const removeFromDB = async (path) => {
                try {
                    const db = await initDB();
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).delete(path);
                    await tx.complete;
                } catch (e) { console.error('Erreur IndexedDB:', e); }
            };

            const clearDB = async () => {
                try {
                    const db = await initDB();
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).clear();
                    await tx.complete;
                } catch (e) { console.error('Erreur IndexedDB:', e); }
            };

            // ==================== TRADUCTIONS ====================
            const translations = {
                fr: {
                    // Accueil
                    app_title: "TeacherTrack",
                    app_subtitle: "Gestion de classe simple et locale",
                    sgc_meaning: "Système de Gestion de Classe",
                    btn_open_file: "Ouvrir un fichier",
                    btn_explorer: "Sélectionner via l'explorateur système",
                    btn_scan_folder: "Scanner un dossier",
                    btn_detect_json: "Détecter les fichiers .json présents",
                    btn_new_space: "Nouvel espace",
                    btn_create_json: "Créer un nouveau fichier .json",
                    drop_zone_text: "Glissez-déposez un fichier .json ici",
                    drop_zone_click: "ou cliquez pour sélectionner",
                    security_note: "Note : Pour des raisons de sécurité, les navigateurs ne peuvent pas accéder automatiquement au dossier du projet. Utilisez les boutons ci-dessus ou glissez-déposez un fichier.",
                    recent_files: "Fichiers récents",
                    clear_recent: "Effacer",
                    no_recent: "Aucun fichier récent",
                    recent_appear: "Vos fichiers récents apparaîtront ici",
                    local_note: "100% local - Aucune donnée n'est envoyée sur internet <br> Made By : SG-Commander | Copyright: StacGate-Amadenus",

                    // Licence
                    license_title: "Licence",
                    license_placeholder: "XXXX-XXXX-XXXX-XXXX",
                    license_activate: "Activer la licence",
                    license_invalid: "Licence invalide",
                    license_expired: "Licence expirée",
                    license_wrong_user: "Cette licence appartient à un autre utilisateur",
                    license_success: "Licence activée avec succès",
                    license_owner: "Propriétaire",
                    license_get: "Obtenez votre clé auprès de votre revendeur",
                    license_active: "LICENCE PRO",
                    license_not_activated: "VERSION NON ACTIVÉE",
                    change_license: "Changer la licence",
                    license_change_warning: "Attention: Une licence est déjà active. Voulez-vous vraiment la modifier ?",
                    license_activation_title: "Activation Licence",
                    license_owner_label: "Propriétaire",
                    license_enter_key: "Entrez votre clé de licence pour activer l'application.",
                    license_get_key: "Obtenez votre clé auprès de votre revendeur",
                    license_manual_entry: "Entrer la clé manuellement",
                    license_select_file: "Sélectionner le fichier licence (.txt)",
                    license_file_hint: "Le fichier licence vous a été envoyé par email",
                    license_file_invalid: "Fichier licence invalide",
                    or: "OU",
                    browse: "Parcourir...",

                    // En-tête
                    close: "Fermer",
                    save: "Sauvegarder",
                    unsaved: "Non sauvegardé",
                    saved: "Sauvegardé",

                    // Messages d'accueil
                    welcome_title: "Bienvenue dans TeacherTrack",
                    create_first_class_hint: "Créez votre première classe pour gérer vos élèves",
                    class_name: "Nom de la classe (ex: 3ème B)",
                    subject_name: "Matière (ex: Mathématiques)",
                    create_class: "Créer ma première classe",
                    main_subject: "Matière principale",

                    // Onglets
                    tab_students: "Élèves",
                    tab_list: "Liste Élèves",
                    tab_grades: "Notes",
                    tab_attendance: "Présences",
                    tab_planning: "Planning",
                    tab_reports: "Rapports",

                    // Page Élèves
                    students_title: "Élèves",
                    students_count: "Élèves",
                    import: "Importer depuis Excel",
                    import_students: "Importer élèves",
                    add: "Ajouter",
                    lastname: "Nom",
                    firstname: "Prénom",
                    average: "Moyenne",
                    actions: "Actions",
                    delete: "Supprimer",
                    no_students: "Aucun élève. Cliquez sur \"Ajouter\" pour en créer un.",

                    // Page Liste Élèves
                    students_list_title: "Liste des Élèves",
                    all_subjects: "Toutes les matières",
                    phone: "Téléphone",
                    absent: "A",
                    late: "R",
                    no_students_list: "Aucun élève dans cette classe",
                    add_student_list: "Cliquez sur \"Ajouter\" pour créer un élève",
                    tab_teacher: "Mes Infos",
                    tab_teacher_icon: "fas fa-user-tie",

                    // Page Notes
                    grades_title: "Carnet de Notes",
                    new_evaluation: "Nouvelle Évaluation",
                    no_evaluations: "Aucune évaluation pour cette matière",
                    create_eval: "Créez une évaluation ou sélectionnez \"Toutes\" pour voir toutes les matières",
                    evaluation_name: "Nom",
                    evaluation_subject: "Matière",
                    evaluation_trimester: "Trimestre/Période",
                    evaluation_max: "Note sur",
                    evaluation_coeff: "Coefficient",

                    // Page Présences
                    attendance_title: "Présences",
                    present: "Présent",
                    absent: "Absent",
                    late_word: "Retard",
                    good_appreciation: "Appréciation positive",
                    bad_appreciation: "Appréciation négative",

                    // Page Planning
                    planning_title: "Planification",
                    add_planning: "Ajouter",
                    planning_session_title: "Titre de la séance",
                    planning_content: "Contenu du cours, devoirs...",
                    no_planning: "Aucune séance planifiée. Cliquez sur \"Ajouter\" pour créer une entrée.",

                    // Page Rapports
                    stats_title: "Statistiques de la classe",
                    class_average: "Moyenne classe",
                    highest_grade: "Meilleure note",
                    lowest_grade: "Note la plus basse",
                    export: "Export",
                    export_excel: "Exporter Excel",
                    export_desc: "Télécharge un fichier .xlsx avec toutes les données",

                    // Modals
                    modal_new_student: "Nouvel Élève",
                    student_id: "Numéro d'identification",
                    photo: "Photo",
                    upload_photo: "Télécharger une photo",
                    remove_photo: "Supprimer la photo",
                    photo_hint: "JPG, PNG (max 2Mo)",
                    birthdate: "Date de naissance",
                    address: "Adresse",
                    phone_parents: "Téléphone (parents)",
                    father: "Nom du père/tuteur",
                    father_email: "Email du père",
                    mother: "Nom de la mère/tutrice",
                    mother_email: "Email de la mère",
                    cancel: "Annuler",
                    add_student_btn: "Ajouter",
                    search_placeholder: "Rechercher un élève...",
                    search_planning: "Rechercher une séance...",
                    no_results: "Aucun résultat trouvé",

                    modal_new_evaluation: "Nouvelle Évaluation",
                    create: "Créer",
                    evaluation_name: "Nom",
                    evaluation_subject: "Matière",
                    evaluation_trimester: "Trimestre/Période",
                    evaluation_max: "Note sur",
                    evaluation_coeff: "Coefficient",

                    modal_subjects: "Gestion des Matières",
                    class_subject: "de la classe",
                    add_subject: "Nouvelle matière",
                    no_subject: "Aucune matière",
                    subject_list: "Liste des matières",
                    delete_subject: "Supprimer",
                    close: "Fermer",

                    modal_student_details: "Détails Élève",
                    personal_info: "Informations personnelles",
                    subject_average: "Moyenne matière",
                    absences: "Absences",
                    grades_by_eval: "Notes par évaluation",
                    attendance_history: "Historique des présences",
                    no_evaluations_grade: "Aucune évaluation pour cette matière",
                    no_attendance: "Aucune présence enregistrée",
                    general_average: "Moyenne générale",

                    // Teacher Info
                    teacher_info_title: "Informations de l'Enseignant",
                    teacher_name: "Nom",
                    teacher_firstname: "Prénom",
                    school_year: "Année Scolaire",
                    main_establishment: "Établissement Principal",
                    secondary_establishments: "Établissements Secondaires",
                    // Nouveaux champs pour l'entête officiel
                    field_republic: "1- République Algérienne Démocratique et Populaire",
                    field_ministry: "2- Ministère de l'Éducation Nationale",
                    field_directorate: "3- Direction de l'Éducation de la Wilaya de",
                    official_header_fields: "Champs officiels pour les documents (éditables)",
                    add_establishment: "Ajouter un établissement",
                    establishment_name: "Nom de l'établissement",
                    establishment_classes: "Classes liées",
                    subject_taught: "Matière enseignée",
                    teacher_type: "Type d'enseignant",
                    type_professor: "Professeur",
                    type_institute: "Instituteur",
                    type_supeur: "Surveillant",
                    type_other: "Autre",
                    teacher_label: "Professeur",
                    phone: "Téléphone",
                    email: "Email",
                    no_establishments: "Aucun établissement ajouté",
                    select_establishment: "Sélectionner un établissement",
                    establishment_address: "Adresse de l'établissement",
                    establishment_phone: "Téléphone de l'établissement",
                    delete_establishment: "Supprimer l'établissement",
                    confirm_delete_establishment: "Êtes-vous sûr de vouloir supprimer cet établissement?",
                    edit_establishment: "Modifier l'établissement",
                    save_establishment: "Enregistrer l'établissement",
                    no_classes_linked: "Aucune classe liée",
                    select_class_establishment: "Établissement de la classe",
                    class: "Classe",
                    no_establishment: "Aucun établissement",
                    click_to_change_establishment: "Cliquez pour changer l'établissement",

                    modal_new_class: "Nouvelle Classe",
                    class_name_label: "Nom de la classe",
                    subject_label: "Matière",
                    establishment_label: "Établissement (optionnel)",

                    // Trimestres
                    manage_trimesters: "Gestion des Trimestres",
                    no_trimesters: "Aucun trimestre défini",
                    trimester_name: "Nom du trimestre (ex: Trimestre 1)",
                    trimester_observation_hint: "Observation pour ce trimestre...",
                    trimester_observation: "Observation",
                    edit: "Modifier",
                    save: "Sauvegarder",
                    annual_average: "Moyenne Annuelle",
                    trimester_average: "Moyenne",

                    modal_scan: "Fichiers détectés",
                    select_file: "Sélectionnez un fichier TeacherTrack à ouvrir :",
                    no_json_found: "Aucun fichier .json trouvé dans ce dossier",

                    // Messages
                    confirm_delete_student: "Supprimer cet élève?",
                    file_modified: "Le fichier a été modifié depuis la dernière lecture.",
                    confirm_close: "Fermer ce fichier?",
                    unsaved_changes: "Des modifications n'ont pas été sauvegardées.",
                    save_before_close: "Cliquez sur OK pour sauvegarder avant de fermer, ou Annuler pour fermer sans sauvegarder.",
                    close_without_save: "Fermer sans sauvegarder ?",
                    confirm_delete_subject: "Cette matière contient évaluation(s). Voulez-vous vraiment la supprimer ?",
                    exam_count: (count) => count === 1 ? `${count} évaluation` : `${count} évaluations`,
                    import_success: (count) => `${count} élève(s) importé(s)`,
                    error_file_format: "Format de fichier invalide",
                    error_opening: "Erreur lors de l'ouverture:",
                    browser_not_supported: "Votre navigateur ne supporte pas l'API File System Access. Utilisez Chrome, Edge ou Opera.",

                    // Details élève
                    general_average: "Moyenne générale",

                    // Présences
                    attendance_date: "Date",

                    // Header
                    add_class: "Ajouter une classe",
                    all_subjects: "Toutes",
                    manage_subjects: "Gérer les matières",

                    // Students list
                    no_students_list_msg: "Aucun élève dans cette classe",
                    add_student_hint: "Cliquez sur \"Ajouter\" pour créer un élève",
                    mean: "Moy:",
                    absent_count: "A",
                    late_count: "R",

                    // Export
                    export_grades: "Exporter les notes",
                    export_grades_title: "Exporter document de relevé de notes",
                    select_trimester_export: "Sélectionner le trimestre à exporter",
                    export_button: "Exporter",
                    no_students_to_export: "Aucun élève à exporter",
                    all_trimesters: "Tous les trimestres",
                    no_exams_for_trimester: "Aucune évaluation pour ce trimestre",
                    select_layout_format: "Sélectionner le format de mise en page",
                    format_arabic: "Arabe (de droite à gauche)",
                    format_western: "Occidental (de gauche à droite)",

                    // Grades
                    exam: (exam) => `/${exam.max} • Coef ${exam.coeff}`,
                },
                ar: {
                    // Accueil
                    app_title: "TeacherTrack",
                    app_subtitle: "إدارة فصول بسيطة ومحلية",
                    sgc_meaning: "نظام إدارة الأقسام",
                    btn_open_file: "فتح ملف",
                    btn_explorer: "تحديد عبر مستكشف النظام",
                    btn_scan_folder: "فحص مجلد",
                    btn_detect_json: "اكتشاف ملفات .json الموجودة",
                    btn_new_space: "مساحة جديدة",
                    btn_create_json: "إنشاء ملف .json جديد",
                    drop_zone_text: "اسحب وأفلت ملف .json هنا",
                    drop_zone_click: "أو انقر للتحديد",
                    security_note: "ملاحظة: لأسباب أمنية، لا يمكن للمتصفحات الوصول تلقائيًا إلى مجلد المشروع. استخدم الأزرار أعلاه أو اسحب وأفلت ملفًا.",
                    recent_files: "الملفات الأخيرة",
                    clear_recent: "مسح",
                    no_recent: "لا توجد ملفات حديثة",
                    recent_appear: "ستظهر ملفاتك الحديثة هنا",
                    local_note: "100٪ محلي - لا يتم إرسال أي بيانات إلى الإنترنت  <br> Made By : SG-Commander | Copyright: StacGate-Amadenus",

                    // Licence
                    license_title: "الترخيص",
                    license_placeholder: "XXXX-XXXX-XXXX-XXXX",
                    license_activate: "تفعيل الترخيص",
                    license_invalid: "ترخيص غير صالح",
                    license_expired: "انتهت صلاحية الترخيص",
                    license_wrong_user: "هذا الترخيص يخص مستخدم آخر",
                    license_success: "تم تفعيل الترخيص بنجاح",
                    license_owner: "المالك",
                    license_get: "احصل على المفتاح من البائع",
                    license_active: "ترخيص محترف",
                    license_not_activated: "الإصدار غير مُفعَّل",
                    change_license: "تغيير الترخيص",
                    license_change_warning: "تحذير: يوجد ترخيص نشط بالفعل. هل تريد حقا تغييره؟",
                    license_activation_title: "تفعيل الترخيص",
                    license_owner_label: "المالك",
                    license_enter_key: "أدخل مفتاح الترخيص لتفعيل التطبيق",
                    license_get_key: "احصل على المفتاح من البائع",
                    license_manual_entry: "أدخل المفتاح يدويًا",
                    license_select_file: "حدد ملف الترخيص (.txt)",
                    license_file_hint: "تم إرسال ملف الترخيص إليك بالبريد الإلكتروني",
                    license_file_invalid: "ملف ترخيص غير صالح",
                    or: "أو",
                    browse: "استعراض...",

                    // En-tête
                    close: "إغلاق",
                    save: "حفظ",
                    unsaved: "غير محفوظ",
                    saved: "محفوظ",

                    // Messages d'accueil
                    welcome_title: "مرحبًا بكم في TeacherTrack",
                    create_first_class_hint: "أنشئ فصلك الأول لإدارة طلابك",
                    create_first_class: "أنشئ صفك الأول للبدء",
                    class_name: "اسم الصف (مثال: الثالث ب)",
                    subject_name: "المادة (مثال: الرياضيات)",
                    create_class: "إنشائي الأول صف",

                    // Onglets
                    tab_students: "الطلاب",
                    tab_list: "قائمة الطلاب",
                    tab_grades: "الدرجات",
                    tab_attendance: "الحضور",
                    tab_planning: "الجدول",
                    tab_reports: "التقارير",

                    // Page Élèves
                    students_title: "الطلاب",
                    students_count: "طلاب",
                    import: "استيراد من إكسل",
                    import_students: "استيراد طلاب",
                    add: "إضافة",
                    lastname: "الاسم",
                    firstname: "اللقب",
                    average: "المتوسط",
                    actions: "إجراءات",
                    delete: "حذف",
                    no_students: "لا يوجد طلاب. انقر على \"إضافة\" لإنشاء طالب.",

                    // Page Liste Élèves
                    students_list_title: "قائمة الطلاب",
                    all_subjects: "جميع المواد",
                    phone: "الهاتف",
                    absent: "غ",
                    late: "ت",
                    no_students_list: "لا يوجد طلاب في هذا الصف",
                    add_student_list: "انقر على \"إضافة\" لإنشاء طالب",

                    // Page Notes
                    grades_title: "سجل الدرجات",
                    new_evaluation: "تقييم جديد",
                    no_evaluations: "لا توجد تقييمات لهذه المادة",
                    create_eval: "أنشئ تقييمًا أو حدد \"جميع المواد\" لعرض الجميع",
                    evaluation_name: "الاسم",
                    evaluation_subject: "المادة",
                    evaluation_trimester: "الفترة الدراسية",
                    evaluation_max: "الدرجة من",
                    evaluation_coeff: "المعامل",

                    // Page Présences
                    attendance_title: "الحضور",
                    present: "حاضر",
                    absent: "غائب",
                    late_word: "متأخر",
                    good_appreciation: "تقدير جيد",
                    bad_appreciation: "تقدير ضعيف",

                    // Page Planning
                    planning_title: "الجدول",
                    add_planning: "إضافة",
                    planning_session_title: "عنوان الحصة",
                    planning_content: "محتوى الدرس، واجبات...",
                    no_planning: "لا توجد حصص مجدولة. انقر على \"إضافة\" لإنشاء مدخلة.",

                    // Page Rapports
                    stats_title: "إحصائيات الصف",
                    class_average: "متوسط الفصل",
                    highest_grade: "أعلى درجة",
                    lowest_grade: "أدنى درجة",
                    export: "تصدير",
                    export_excel: "تصدير Excel",
                    export_desc: "تحميل ملف .xlsx بجميع البيانات",

                    // Modals
                    modal_new_student: "طالب جديد",
                    student_id: "رقم التعريف",
                    photo: "الصورة",
                    upload_photo: "تحميل صورة",
                    remove_photo: "حذف الصورة",
                    photo_hint: "JPG, PNG (بحد أقصى 2Mo)",
                    birthdate: "تاريخ الميلاد",
                    address: "العنوان",
                    phone_parents: "هاتف الأولياء",
                    father: "اسم الأب/الوصي",
                    father_email: "البريد الإلكتروني للأب",
                    mother: "اسم الأم/الوصية",
                    mother_email: "البريد الإلكتروني للأم",
                    cancel: "إلغاء",
                    add_student_btn: "إضافة",

                    modal_new_evaluation: "تقييم جديد",
                    create: "إنشاء",
                    evaluation_name: "الاسم",
                    evaluation_subject: "المادة",
                    evaluation_trimester: "الفترة الدراسية",
                    evaluation_max: "الدرجة من",
                    evaluation_coeff: "المعامل",

                    modal_subjects: "إدارة المواد",
                    class_subject: "الصف",
                    add_subject: "مادة جديدة",
                    no_subject: "لا توجد مادة",
                    subject_list: "قائمة المواد",
                    delete_subject: "حذف",
                    close: "إغلاق",

                    modal_student_details: "تفاصيل الطالب",
                    personal_info: "المعلومات الشخصية",
                    subject_average: "متوسط المادة",
                    absences: "الغيابات",
                    grades_by_eval: "الدرجات حسب التقييم",
                    attendance_history: "سجل الحضور",
                    no_evaluations_grade: "لا توجد تقييمات لهذه المادة",
                    no_attendance: "لا يوجد حضور مسجل",
                    general_average: "المتوسط العام",
                    search_placeholder: "البحث عن طالب...",
                    search_planning: "البحث عن حصة...",
                    no_results: "لم يتم العثور على نتائج",
                    tab_teacher: "معلوماتي",

                    // Teacher Info
                    teacher_info_title: "معلومات المعلم",
                    teacher_name: "اللقب",
                    teacher_firstname: "الاسم",
                    school_year: "السنة الدراسية",
                    main_establishment: "المؤسسة الرئيسية",
                    secondary_establishments: "المؤسسات الثانوية",
                    // Nouveaux champs pour l'entête officiel
                    field_republic: "1- الجمهورية الجزائرية الديمقراطية الشعبية",
                    field_ministry: "2- وزارة التربية الوطنية",
                    field_directorate: "3- المديرية التربية لولاية",
                    official_header_fields: "الحقول الرسمية للوثائق (قابلة للتعديل)",
                    add_establishment: "إضافة مؤسسة",
                    establishment_name: "اسم المؤسسة",
                    establishment_classes: "الصفوف المرتبطة",
                    subject_taught: "المادة المُعلَّمة",
                    teacher_type: "نوع المعلم",
                    type_professor: "أستاذ",
                    type_institute: "معلم",
                    type_supeur: "مشرف",
                    type_other: "آخر",
                    teacher_label: "أستاذ",
                    phone: "الهاتف",
                    email: "البريد الإلكتروني",
                    no_establishments: "لم يتم إضافة أي مؤسسة",
                    select_establishment: "اختر مؤسسة",
                    establishment_address: "عنوان المؤسسة",
                    establishment_phone: "هاتف المؤسسة",
                    delete_establishment: "حذف المؤسسة",
                    confirm_delete_establishment: "هل أنت متأكد من حذف هذه المؤسسة؟",
                    edit_establishment: "تعديل المؤسسة",
                    save_establishment: "حفظ المؤسسة",
                    no_classes_linked: "لم يتم ربط أي صف",
                    select_class_establishment: "مؤسسة الصف",
                    class: "الصف",
                    no_establishment: "لا توجد مؤسسة",
                    click_to_change_establishment: "انقر لتغيير المؤسسة",

                    modal_new_class: "صف جديد",
                    class_name_label: "اسم الصف",
                    subject_label: "المادة",
                    establishment_label: "المؤسسة (اختياري)",

                    // Trimestres
                    manage_trimesters: "إدارة الفترات الدراسية",
                    no_trimesters: "لم يتم تحديد أي فترة دراسية",
                    trimester_name: "اسم الفترة (مثل: الفصل الأول)",
                    trimester_observation_hint: "ملاحظة لهذه الفترة...",
                    trimester_observation: "ملاحظة",
                    edit: "تعديل",
                    save: "حفظ",
                    annual_average: "المتوسط السنوي",
                    trimester_average: "المتوسط",

                    modal_scan: "الملفات المكتشفة",
                    select_file: "حدد ملف TeacherTrack للفتح:",
                    no_json_found: "لم يتم العثور على ملفات .json في هذا المجلد",

                    // Messages
                    confirm_delete_student: "حذف هذا الطالب؟",
                    file_modified: "تم تعديل الملف منذ آخر قراءة.",
                    confirm_close: "إغلاق هذا الملف؟",
                    unsaved_changes: "لم يتم حفظ بعض التعديلات.",
                    save_before_close: "انقر فوق \"موافق\" للحفظ قبل الإغلاق، أو \"إلغاء\" للإغلاق دون حفظ.",
                    close_without_save: "إغلاق دون حفظ؟",
                    confirm_delete_subject: "تحتوي هذه المادة على تقييم. هل تريد حذفها حقًا؟",
                    no_subject: "لا توجد مادة",
                    exam_count: (count) => count === 1 ? `${count} تقييم` : `${count} تقييمات`,
                    import_success: (count) => `${count} طالب(ة) مستورد(ون)`,
                    error_file_format: "صيغة الملف غير صالحة",
                    error_opening: "خطأ أثناء الفتح:",
                    browser_not_supported: "متصفحك لا يدعم واجهة برمجة تطبيقات الوصول إلى نظام الملفات. استخدم Chrome أو Edge أو Opera.",

                    // Details élève
                    general_average: "المتوسط العام",

                    // Présences
                    attendance_date: "التاريخ",

                    // Header
                    add_class: "إضافة صف",
                    all_subjects: "الكل",
                    manage_subjects: "إدارة المواد",

                    // Students list
                    no_students_list_msg: "لا يوجد طلاب في هذا الصف",
                    add_student_hint: "انقر على \"إضافة\" لإنشاء طالب",
                    mean: "المتوسط:",
                    absent_count: "غ",
                    late_count: "ت",

                    // Export
                    export_grades: "تصدير النقاط",
                    export_grades_title: "تصدير وثيقة حجز النقاط",
                    select_trimester_export: "اختر الفترة الدراسية",
                    export_button: "تصدير",
                    no_students_to_export: "لا يوجد طلاب للتصدير",
                    all_trimesters: "جميع الفترات",
                    no_exams_for_trimester: "لا توجد تقييمات لهذه الفترة",
                    select_layout_format: "اختر تنسيق التخطيط",
                    format_arabic: "عربي (من اليمين لليسار)",
                    format_western: "غربي (من اليسار لليمين)",

                    // Grades
                    exam: (exam) => `/ ${exam.max} • مع ${exam.coeff}`,
                },

                // ==================== ANGLAIS ====================
                en: {
                    // Home
                    app_title: "TeacherTrack",
                    app_subtitle: "Simple and local class management",
                    sgc_meaning: "Smart Grade Control",
                    btn_open_file: "Open file",
                    btn_explorer: "Select via system explorer",
                    btn_scan_folder: "Scan folder",
                    btn_detect_json: "Detect existing .json files",
                    btn_new_space: "New space",
                    btn_create_json: "Create new .json file",
                    drop_zone_text: "Drag and drop a .json file here",
                    drop_zone_click: "or click to select",
                    security_note: "Note: For security reasons, browsers cannot automatically access the project folder. Use the buttons above or drag and drop a file.",
                    recent_files: "Recent files",
                    clear_recent: "Clear",
                    no_recent: "No recent files",
                    recent_appear: "Your recent files will appear here",
                    local_note: "100% local - No data is sent to the internet <br> Made By : SG-Commander | Copyright: StacGate-Amadenus",

                    // Licence
                    license_title: "License",
                    license_placeholder: "XXXX-XXXX-XXXX-XXXX",
                    license_activate: "Activate license",
                    license_invalid: "Invalid license",
                    license_expired: "License expired",
                    license_wrong_user: "This license belongs to another user",
                    license_success: "License activated successfully",
                    license_owner: "Owner",
                    license_get: "Get your key from your reseller",
                    license_active: "PRO LICENSE",
                    license_not_activated: "VERSION NOT ACTIVATED",
                    license_activation_title: "License Activation",
                    license_owner_label: "Owner",
                    license_enter_key: "Enter your license key to activate the application.",
                    license_get_key: "Get your key from your reseller",
                    license_manual_entry: "Enter key manually",
                    license_select_file: "Select license file (.txt)",
                    license_file_hint: "The license file was sent to you by email",
                    license_file_invalid: "Invalid license file",
                    or: "OR",
                    browse: "Browse...",

                    // Header
                    close: "Close",
                    save: "Save",
                    unsaved: "Unsaved",
                    saved: "Saved",

                    // Welcome messages
                    welcome_title: "Welcome to TeacherTrack",
                    create_first_class_hint: "Create your first class to manage your students",
                    create_first_class: "Create your first class to get started",
                    class_name: "Class name (e.g., 3rd Grade B)",
                    subject_name: "Subject (e.g., Mathematics)",
                    create_class: "Create my first class",
                    main_subject: "Main subject",

                    // Tabs
                    tab_students: "Students",
                    tab_list: "Student List",
                    tab_grades: "Grades",
                    tab_attendance: "Attendance",
                    tab_planning: "Planning",
                    tab_reports: "Reports",

                    // Students page
                    students_title: "Students",
                    students_count: "Students",
                    import: "Import from Excel",
                    import_students: "Import students",
                    add: "Add",
                    lastname: "Last name",
                    firstname: "First name",
                    average: "Average",
                    actions: "Actions",
                    delete: "Delete",
                    no_students: "No students. Click \"Add\" to create one.",

                    // Student list page
                    students_list_title: "Student List",
                    all_subjects: "All subjects",
                    phone: "Phone",
                    absent: "A",
                    late: "L",
                    no_students_list: "No students in this class",
                    add_student_list: "Click \"Add\" to create a student",

                    // Grades page
                    grades_title: "Grade Book",
                    new_evaluation: "New Evaluation",
                    no_evaluations: "No evaluations for this subject",
                    create_eval: "Create an evaluation or select \"All\" to see all subjects",
                    evaluation_name: "Name",
                    evaluation_subject: "Subject",
                    evaluation_trimester: "Period",
                    evaluation_max: "Grade out of",
                    evaluation_coeff: "Coefficient",

                    // Attendance page
                    attendance_title: "Attendance",
                    present: "Present",
                    absent: "Absent",
                    late_word: "Late",
                    good_appreciation: "Good appreciation",
                    bad_appreciation: "Poor appreciation",

                    // Planning page
                    planning_title: "Planning",
                    add_planning: "Add",
                    planning_session_title: "Session title",
                    planning_content: "Lesson content, homework...",
                    no_planning: "No scheduled sessions. Click \"Add\" to create an entry.",

                    // Reports page
                    stats_title: "Class Statistics",
                    class_average: "Class Average",
                    highest_grade: "Highest Grade",
                    lowest_grade: "Lowest Grade",
                    export: "Export",
                    export_excel: "Export Excel",
                    export_desc: "Download a .xlsx file with all data",

                    // Modals
                    modal_new_student: "New Student",
                    student_id: "Identification Number",
                    photo: "Photo",
                    upload_photo: "Upload photo",
                    remove_photo: "Remove photo",
                    photo_hint: "JPG, PNG (max 2Mo)",
                    birthdate: "Date of birth",
                    address: "Address",
                    phone_parents: "Phone (parents)",
                    father: "Father's name",
                    mother: "Mother's name",
                    parent_email: "Parent's email",

                    // Teacher info
                    tab_teacher: "My Info",
                    teacher_name: "Last name",
                    teacher_firstname: "First name",
                    school_year: "School Year",
                    main_establishment: "Main Establishment",
                    secondary_establishments: "Secondary Establishments",
                    add_establishment: "Add establishment",
                    establishment_name: "Establishment name",
                    establishment_classes: "Linked classes",
                    subject_taught: "Subject taught",
                    teacher_type: "Teacher type",
                    type_professor: "Professor",
                    type_institute: "Teacher",
                    type_supeur: "Supervisor",
                    type_other: "Other",
                    teacher_label: "Teacher",
                    phone: "Phone",
                    email: "Email",
                    no_establishments: "No establishments added",
                    select_establishment: "Select an establishment",
                    establishment_address: "Establishment address",
                    establishment_phone: "Establishment phone",
                    delete_establishment: "Delete establishment",
                    confirm_delete_establishment: "Are you sure you want to delete this establishment?",
                    edit_establishment: "Edit establishment",
                    save_establishment: "Save establishment",
                    no_classes_linked: "No linked classes",
                    select_class_establishment: "Class establishment",
                    class: "Class",
                    no_establishment: "No establishment",
                    click_to_change_establishment: "Click to change establishment",

                    modal_new_class: "New Class",
                    class_name_label: "Class name",
                    subject_label: "Subject",
                    establishment_label: "Establishment (optional)",

                    // Trimesters
                    manage_trimesters: "Manage Trimesters",
                    no_trimesters: "No trimester defined",
                    trimester_name: "Trimester name (e.g., Trimester 1)",
                    trimester_observation_hint: "Observation for this trimester...",
                    trimester_observation: "Observation",
                    edit: "Edit",
                    save: "Save",
                    annual_average: "Annual Average",
                    trimester_average: "Average",

                    modal_scan: "Detected files",
                    select_file: "Select a TeacherTrack file to open:",
                    no_json_found: "No .json files found in this folder",

                    // Messages
                    confirm_delete_student: "Delete this student?",
                    file_modified: "The file has been modified since last read.",
                    confirm_close: "Close this file?",
                    unsaved_changes: "Some changes have not been saved.",
                    save_before_close: "Click OK to save before closing, or Cancel to close without saving.",
                    close_without_save: "Close without saving?",
                    confirm_delete_subject: "This subject contains evaluations. Are you sure you want to delete it?",
                    no_subject: "No subject",
                    exam_count: (count) => count === 1 ? `${count} evaluation` : `${count} evaluations`,
                    import_success: (count) => `${count} student(s) imported`,
                    error_file_format: "Invalid file format",
                    error_opening: "Error opening:",
                    browser_not_supported: "Your browser does not support the File System Access API. Use Chrome, Edge, or Opera.",

                    // Student details
                    general_average: "General Average",

                    // Attendance
                    attendance_date: "Date",

                    // Header
                    add_class: "Add class",
                    all_subjects: "All",
                    manage_subjects: "Manage subjects",

                    // Students list
                    no_students_list_msg: "No students in this class",
                    add_student_hint: "Click \"Add\" to create a student",
                    mean: "Average:",
                    absent_count: "A",
                    late_count: "L",

                    // Export
                    export_grades: "Export Grades",
                    export_grades_title: "Export grade document",
                    select_trimester_export: "Select the period",
                    export_button: "Export",
                    no_students_to_export: "No students to export",
                    all_trimesters: "All periods",
                    no_exams_for_trimester: "No evaluations for this period",
                    select_layout_format: "Select layout format",
                    format_arabic: "Arabic (Right to Left)",
                    format_western: "Western (Left to Right)",

                    // Grades
                    exam: (exam) => `/ ${exam.max} • Coeff ${exam.coeff}`,

                    // New fields for official header
                    field_republic: "1- People's Democratic Republic of Algeria",
                    field_ministry: "2- Ministry of National Education",
                    field_directorate: "3- Directorate of Education of Wilaya of",
                    official_header_fields: "Official fields for documents (editable)",
                }
            };

            const currentLang = ref(localStorage.getItem('teacherTrack_lang') || 'fr');

            const t = (key, ...args) => {
                const dict = translations[currentLang.value];
                if (dict && dict[key]) {
                    const value = dict[key];
                    if (typeof value === 'function') {
                        return value(...args);
                    }
                    return value;
                }
                // Fallback vers français si traduction manquante
                const frDict = translations['fr'];
                const frValue = frDict[key] || key;
                if (typeof frValue === 'function') {
                    return frValue(...args);
                }
                return frValue;
            };

            const setLang = (lang) => {
                currentLang.value = lang;
                localStorage.setItem('teacherTrack_lang', lang);
                document.documentElement.lang = lang;
                // RTL for Arabic only, LTR for French and English
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            };

            createApp({
                setup() {
                    // États principaux
                    const isDataLoaded = ref(false);
                    const db = reactive({
                        classes: [],
                        teacherInfo: {
                            lastname: '',
                            firstname: '',
                            schoolYear: new Date().getFullYear().toString() + '-' + (new Date().getFullYear() + 1).toString(),
                            mainEstablishment: '',
                            subject: '',
                            teacherType: 'professor',
                            phone: '',
                            email: '',
                            fieldRepublic: '1- République Algérienne Démocratique et Populaire',
                            fieldMinistry: '2- Ministère de l\'Éducation Nationale',
                            fieldDirectorate: '3- Direction de l\'Éducation de la Wilaya de Constantine'
                        },
                        establishments: []
                    });
                    const currentClassIndex = ref(0);
                    const currentTab = ref('teacher');
                    const fileName = ref('');
                    const fileHandle = ref(null);
                    const hasUnsavedChanges = ref(false);

                    // Modals
                    const showStudentModal = ref(false);
                    const showExamModal = ref(false);
                    const showClassModal = ref(false);
                    const showSubjectModal = ref(false);
                    const showScanModal = ref(false);
                    const showTrimesterModal = ref(false);
                    const showEstablishmentModal = ref(false);
                    const showClassEstablishmentModal = ref(false); // Pour assigner un établissement à la classe
                    const editingEstablishment = ref(null); // Pour l'édition d'établissement
                    const showExportModal = ref(false); // Pour l'export des notes
                    const selectedTrimesterExport = ref(''); // Trimestre sélectionné pour l'export
                    const exportFormat = ref('rtl'); // Format d'export: 'rtl' (arabe) ou 'ltr' (occidental)

                    // Gestion des espaces (Capacitor Android)
                    const availableSpaces = ref([]); // Liste des espaces (fichiers JSON)
                    const isNative = ref(false); // Détection plateforme native (évite erreur template)

                    // Licence RSA
                    const showLicenseModal = ref(false);
                    const licenseInput = ref('');
                    const licenseError = ref('');
                    const isLicenseValid = ref(false);
                    const licenseOwner = ref('');
                    const isChangingLicense = ref(false); // Pour afficher le formulaire de saisie même si licence active

                    // ============================================================
                    // SYSTÈME DE LICENCE SÉCURISÉ (RSA-PSS)
                    // ============================================================
                    // Clé publique RSA pour la vérification des licences (algorithme PS256)
                    // NOTE: La clé privée est stockée séparément dans admin-keygen.html pour la génération des licences

                    const PUBLIC_KEY = { "alg": "PS256", "e": "AQAB", "ext": true, "key_ops": ["verify"], "kty": "RSA", "n": "yeAKJ28Va45Nl4dHQlYimbGn_L5j57MWLkT1ClMlwIqe1DqGuYhgFfk-faxFALDB9av64yBhcXgawMEei_433HZyl51xuvDmRMKe4pCJT-ax5Lz99LjbKEFTrp4E6H3mzE_BP0FDRk1nnO86jsfpgP_5iW2wBVxq26G5ykvWmvChRZamSqkc-TUgyT4mc-moizTqp2BF30KTzXG0Fg2V8-mjKMGcqfpZbUdAF48gtzyWwi8gGvTOHh_9V4N8FIn2B2vIS-uBTftKHp0J8EA_c3Tnj82gSNdt9QKXOuKtgNxiRHtrX2tbPF1KexSdWw2GyYFE4ArxNrF6mjKjOxRNhQ" };

                    // Annuler le modal de licence et fermer le fichier pour protéger les données
                    const cancelLicenseModal = () => {
                        showLicenseModal.value = false;
                        isChangingLicense.value = false; // Reset quand on ferme
                        closeFile();
                    };

                    // Ouvrir le modal de licence avec avertissement si déjà valide
                    const openLicenseModalWithWarning = () => {
                        if (isLicenseValid.value) {
                            if (confirm(t('license_change_warning'))) {
                                isChangingLicense.value = true; // Forcer affichage formulaire
                                showLicenseModal.value = true;
                            }
                        } else {
                            showLicenseModal.value = true;
                        }
                    };

                    // Vérifier que l'utilisateur du fichier correspond à la licence
                    // NOUVELLE LOGIQUE: Vérifie AVANT de charger les données, retourne true/false
                    // NE modifie PAS l'état de la licence
                    const validateDataFileOwner = (data) => {
                        // Si pas de licence valide, on accepte (pas de vérification à faire)
                        if (!isLicenseValid.value || !licenseOwner.value) {
                            return true;
                        }

                        // Si le fichier est vide (nouveau), on accepte
                        if (!data.teacherInfo?.lastname && !data.teacherInfo?.firstname) {
                            return true;
                        }

                        // Récupérer les infos utilisateur de la licence (Chaîne complète)
                        const licenseNormalized = licenseOwner.value.trim().toLowerCase();

                        // Reconstituer le nom complet depuis le fichier JSON
                        // On concatène "Nom" + " " + "Prénom"
                        const dataLastname = (data.teacherInfo?.lastname || '').trim();
                        const dataFirstname = (data.teacherInfo?.firstname || '').trim();
                        const dataFullName = `${dataLastname} ${dataFirstname}`;
                        const dataNormalized = dataFullName.trim().toLowerCase();

                        // Vérifier la correspondance par string complet
                        const isMatch = (licenseNormalized === dataNormalized);

                        console.log(`🔍 Vérification correspondance fichier/licence:`);
                        console.log(`   Fichier (Reconstruit): "${dataNormalized}"`);
                        console.log(`   Licence (Original):    "${licenseNormalized}"`);
                        console.log(`   Résultat: ${isMatch ? '✅ CORRESPOND' : '❌ DIFFÉRENT'}`);

                        return isMatch;
                    };

                    // Ancienne fonction conservée pour compatibilité - ne fait plus rien d'actif
                    // La vérification est maintenant faite par validateDataFileOwner AVANT chargement
                    const verifyUserMatchWithLicense = async () => {
                        return true; // Ne fait plus rien, la vérification est faite avant chargement
                    };

                    // Vérification et activation de licence
                    const verifyLicense = async (inputCode) => {
                        licenseError.value = ''; // Reset error
                        if (!inputCode) return;
                        try {
                            // 1. Décoder l'enveloppe (Compatible UTF-8 / Arabe)
                            const jsonRaw = decodeURIComponent(atob(inputCode).split('').map(function (c) {
                                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                            }).join(''));
                            const licObj = JSON.parse(jsonRaw);

                            // 2. Vérifier si clé publique est configurée
                            if (Object.keys(PUBLIC_KEY).length === 0) {
                                console.warn("ERREUR DEV: Clé Publique non configurée dans index.html!");
                                // En mode dev, on autorise quand même sans vérification cryptographique
                                isLicenseValid.value = true;
                                licenseOwner.value = licObj.owner || "Développeur";
                                licenseInput.value = '';
                                showLicenseModal.value = false;
                                isChangingLicense.value = false; // Reset changement
                                return;
                            }

                            // 3. Import Clé Publique
                            const key = await window.crypto.subtle.importKey("jwk", PUBLIC_KEY, { name: "RSA-PSS", hash: "SHA-256" }, false, ["verify"]);

                            // 4. Préparer données
                            const sig = Uint8Array.from(atob(licObj.sig), c => c.charCodeAt(0));
                            const data = new TextEncoder().encode(licObj.owner);

                            // 5. VÉRIFIER SIGNATURE
                            const valid = await window.crypto.subtle.verify({ name: "RSA-PSS", saltLength: 32 }, key, sig, data);

                            if (valid) {
                                // 6. Vérifier que les informations de l'utilisateur correspondent à la licence
                                // La licence contient "NOM Prénom" dans licObj.owner
                                const licenseNameParts = licObj.owner.split(' ');
                                const licenseLastname = licenseNameParts[0]?.trim().toLowerCase() || '';
                                const licenseFirstname = licenseNameParts.slice(1).join(' ').trim().toLowerCase() || '';

                                // Vérifier avec les infos sauvegardées localement
                                const savedUserInfoJSON = localStorage.getItem('teachertrack_user_info');
                                const savedUserInfo = savedUserInfoJSON ? JSON.parse(savedUserInfoJSON) : null;

                                let isUserMatch = false;

                                if (savedUserInfo) {
                                    // Comparer avec les infos sauvegardées (utiliser les bonnes clés)
                                    const savedLastname = (savedUserInfo.lastname || savedUserInfo.name || '').trim().toLowerCase();
                                    const savedFirstname = (savedUserInfo.firstname || savedUserInfo.surname || '').trim().toLowerCase();

                                    isUserMatch = (savedLastname === licenseLastname && savedFirstname === licenseFirstname);
                                    console.log(`🔍 Vérification utilisateur: "${savedLastname} ${savedFirstname}" vs licence "${licenseLastname} ${licenseFirstname}" = ${isUserMatch}`);
                                }

                                // Vérifier également avec les données du fichier JSON si disponible
                                if (!isUserMatch && db.teacherInfo && (db.teacherInfo.lastname || db.teacherInfo.firstname)) {
                                    const jsonLastname = (db.teacherInfo.lastname || '').trim().toLowerCase();
                                    const jsonFirstname = (db.teacherInfo.firstname || '').trim().toLowerCase();

                                    isUserMatch = (jsonLastname === licenseLastname && jsonFirstname === licenseFirstname);
                                    console.log(`🔍 Vérification JSON: "${jsonLastname} ${jsonFirstname}" vs licence "${licenseLastname} ${licenseFirstname}" = ${isUserMatch}`);
                                }

                                // Si aucune info n'est disponible (pas de données locales ni fichier chargé), on accepte la licence
                                if (!savedUserInfo && (!db.teacherInfo || (!db.teacherInfo.lastname && !db.teacherInfo.firstname))) {
                                    isUserMatch = true;
                                    console.log(`🔍 Première activation ou pas de données - licence acceptée`);
                                }

                                // Si les infos ne correspondent pas mais qu'aucun fichier n'est chargé, on accepte quand même
                                // (l'utilisateur change peut-être de licence sur l'écran d'accueil)
                                if (!isUserMatch && !db.teacherInfo?.lastname && !db.teacherInfo?.firstname) {
                                    isUserMatch = true;
                                    console.log(`🔍 Pas de fichier chargé - licence acceptée`);
                                }

                                if (!isUserMatch) {
                                    // Les informations ne correspondent pas
                                    licenseError.value = t('license_wrong_user');
                                    isLicenseValid.value = false;
                                    return;
                                }

                                // 7. Activer la licence
                                isLicenseValid.value = true;
                                licenseOwner.value = licObj.owner; // "NOM Prénom"
                                licenseInput.value = '';
                                showLicenseModal.value = false;
                                isChangingLicense.value = false; // Reset changement

                                // Sauvegarder les infos utilisateur pour les vérifications futures
                                // Utiliser les bonnes clés: lastname et firstname
                                localStorage.setItem('teachertrack_user_info', JSON.stringify({
                                    lastname: licenseLastname,
                                    firstname: licenseFirstname,
                                    timestamp: Date.now()
                                }));

                                // Sauvegarde Persistante de la licence
                                const storeKey = 'teachertrack_license_v1';
                                if (window.Capacitor?.isNativePlatform()) {
                                    await window.Preferences.set({ key: storeKey, value: inputCode });
                                } else {
                                    localStorage.setItem(storeKey, inputCode);
                                }

                                console.log(`✅ Licence activée pour: ${licObj.owner}`);
                            } else {
                                licenseError.value = t('license_invalid');
                            }
                        } catch (e) {
                            console.error("Erreur licence:", e);
                            licenseError.value = t('license_invalid');
                            isLicenseValid.value = false;
                            licenseOwner.value = "";
                        }
                    };

                    // Vérifier le contenu d'une licence (sans modifier l'état)
                    const verifyLicenseContent = async (inputCode) => {
                        if (!inputCode) return false;
                        try {
                            const jsonRaw = decodeURIComponent(atob(inputCode).split('').map(function (c) {
                                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                            }).join(''));
                            const licObj = JSON.parse(jsonRaw);

                            if (Object.keys(PUBLIC_KEY).length === 0) return true;

                            const key = await window.crypto.subtle.importKey("jwk", PUBLIC_KEY,
                                { name: "RSA-PSS", hash: "SHA-256" }, false, ["verify"]);
                            const sig = Uint8Array.from(atob(licObj.sig), c => c.charCodeAt(0));
                            const data = new TextEncoder().encode(licObj.owner);
                            return await window.crypto.subtle.verify(
                                { name: "RSA-PSS", saltLength: 32 }, key, sig, data);
                        } catch (e) {
                            return false;
                        }
                    };

                    // Importer un fichier licence via file picker
                    const importLicenseFile = async (event) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        licenseError.value = '';

                        try {
                            const content = await file.text();
                            let licenseCode = null;

                            // Chercher une ligne commençant par 'eyJ' (base64 JSON)
                            const lines = content.split('\n');
                            for (const line of lines) {
                                const trimmed = line.trim();
                                if (trimmed.startsWith('eyJ') && trimmed.length > 50) {
                                    licenseCode = trimmed;
                                    break;
                                }
                            }

                            // Fallback: contenu entier
                            if (!licenseCode && content.trim().startsWith('eyJ')) {
                                licenseCode = content.trim();
                            }

                            if (!licenseCode) {
                                licenseError.value = t('license_file_invalid');
                                event.target.value = '';
                                return;
                            }

                            const isValid = await verifyLicenseContent(licenseCode);
                            if (isValid) {
                                await verifyLicense(licenseCode);
                            } else {
                                licenseError.value = t('license_file_invalid');
                            }
                        } catch (e) {
                            console.error('Erreur import licence:', e);
                            licenseError.value = t('license_file_invalid');
                        }

                        event.target.value = '';
                    };

                    // Injecter l'identité de la licence dans les données
                    const applyLicenseIdentity = () => {
                        if (isLicenseValid.value && licenseOwner.value) {
                            const parts = licenseOwner.value.split(' ');
                            db.teacherInfo.lastname = parts[0] || '';
                            db.teacherInfo.firstname = parts.slice(1).join(' ') || '';
                        }
                    };

                    // GARDIEN (Wrapper) - Bloque les actions si pas de licence
                    const requireLicense = async (actionFn) => {
                        let code = "";
                        if (window.Capacitor?.isNativePlatform()) {
                            const ret = await window.Preferences.get({ key: 'teachertrack_license_v1' });
                            code = ret.value;
                        } else {
                            code = localStorage.getItem('teachertrack_license_v1');
                        }

                        if (!code) {
                            showLicenseModal.value = true;
                            return; // Stop - affiche le modal
                        }

                        // Si licence pas encore validée, on vérifie
                        if (!isLicenseValid.value) {
                            await verifyLicense(code);
                        }

                        // Si après vérification c'est bon, on exécute
                        if (isLicenseValid.value) {
                            actionFn();
                        } else {
                            showLicenseModal.value = true;
                        }
                    };

                    // Données de l'enseignant
                    const teacherInfo = reactive({
                        lastname: '',
                        firstname: '',
                        schoolYear: new Date().getFullYear().toString() + '-' + (new Date().getFullYear() + 1).toString(),
                        mainEstablishment: '',
                        secondaryEstablishments: [],
                        subject: '',
                        teacherType: 'professor',
                        phone: '',
                        email: ''
                    });

                    // Nouvel établissement
                    const newEstablishment = reactive({ name: '', address: '', phone: '', classes: [] });

                    // Données temporaires
                    const newTrimester = reactive({ id: '', name: '', observation: '' });

                    // Données temporaires
                    const newStudent = reactive({
                        firstname: '',
                        lastname: '',
                        student_id: '',
                        birthdate: '',
                        address: '',
                        phone: '',
                        parent_father: '',
                        parent_father_email: '',
                        parent_mother: '',
                        parent_mother_email: '',
                        photo: ''
                    });
                    const newExam = reactive({ name: '', max: 20, coeff: 1, subjectId: '', trimesterId: '' });
                    const newClassName = ref('');
                    const newClassSubject = ref('');
                    const newClassEstablishmentId = ref(''); // Établissement pour la nouvelle classe
                    const pendingClassIdForEstablishment = ref(null); // ID temporaire pour lier la classe à l'établissement lors de sa création
                    const newSubjectName = ref('');
                    const attendanceDate = ref(new Date().toISOString().split('T')[0]);
                    const searchQuery = ref('');
                    const searchPlanningQuery = ref('');

                    // Matière active (sélectionnée dans le dropdown)
                    const currentSubjectId = ref(null);

                    // Élève sélectionné pour les détails
                    const selectedStudent = ref(null);

                    // Historique
                    const recentFiles = ref([]);
                    const scannedFiles = ref([]);
                    const maxRecentFiles = 5;

                    // Onglets
                    const tabs = computed(() => [
                        { id: 'teacher', name: t('tab_teacher'), icon: 'fas fa-user-tie' },
                        { id: 'students', name: t('tab_students'), icon: 'fas fa-users' },
                        { id: 'eleves', name: t('tab_list'), icon: 'fas fa-list' },
                        { id: 'grades', name: t('tab_grades'), icon: 'fas fa-clipboard-list' },
                        { id: 'attendance', name: t('tab_attendance'), icon: 'fas fa-calendar-check' },
                        { id: 'planner', name: t('tab_planning'), icon: 'fas fa-calendar-alt' },
                        { id: 'reports', name: t('tab_reports'), icon: 'fas fa-chart-bar' }
                    ]);

                    // === GESTION DES MATIÈRES ===

                    // Migration des données anciennes (sujet unique → tableau de matières)
                    const migrateSubjects = (cls) => {
                        if (typeof cls.subject === 'string' && cls.subject) {
                            // Ancien format : une seule matière
                            cls.subjects = [{
                                id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                                name: cls.subject
                            }];
                            delete cls.subject;
                        } else if (!cls.subjects || !Array.isArray(cls.subjects)) {
                            // Pas de matières du tout, créer une matière par défaut
                            cls.subjects = [{
                                id: Date.now().toString() + '_default',
                                name: t('main_subject')
                            }];
                        }

                        // Migration des trimestres (si inexistant)
                        if (!cls.trimesters || !Array.isArray(cls.trimesters)) {
                            cls.trimesters = [
                                { id: 'tri1', name: 'Trimestre 1', observation: '' },
                                { id: 'tri2', name: 'Trimestre 2', observation: '' },
                                { id: 'tri3', name: 'Trimestre 3', observation: '' }
                            ];
                        }

                        // Migration des exams pour ajouter trimesterId (si inexistant)
                        if (cls.exams && Array.isArray(cls.exams)) {
                            cls.exams.forEach(exam => {
                                if (!exam.trimesterId) exam.trimesterId = 'tri1';
                            });
                        }

                        // Migration des élèves pour ajouter les nouveaux champs et observations par trimestre
                        if (cls.students && Array.isArray(cls.students)) {
                            cls.students.forEach(student => {
                                if (!student.hasOwnProperty('student_id')) student.student_id = '';
                                if (!student.hasOwnProperty('birthdate')) student.birthdate = '';
                                if (!student.hasOwnProperty('address')) student.address = '';
                                if (!student.hasOwnProperty('phone')) student.phone = '';
                                if (!student.hasOwnProperty('parent_father')) student.parent_father = '';
                                if (!student.hasOwnProperty('parent_father_email')) student.parent_father_email = '';
                                if (!student.hasOwnProperty('parent_mother')) student.parent_mother = '';
                                if (!student.hasOwnProperty('parent_mother_email')) student.parent_mother_email = '';
                                if (!student.grades) student.grades = {};
                                if (!student.photo) student.photo = '';
                                // Observations par trimestre
                                if (!student.trimesterObservations) student.trimesterObservations = {};
                            });
                        }
                    };

                    // Matières de la classe courante
                    const currentSubjects = computed(() => currentClass.value?.subjects || []);

                    // Matière active sélectionnée
                    const currentSubject = computed(() => {
                        if (!currentClass.value?.subjects) return null;
                        if (currentSubjectId.value) {
                            return currentClass.value.subjects.find(s => s.id === currentSubjectId.value);
                        }
                        // Par défaut, première matière
                        return currentClass.value.subjects[0] || null;
                    });

                    // Examens filtrés par matière active
                    const filteredExams = computed(() => {
                        if (!currentClass.value?.exams) return [];
                        if (!currentSubjectId.value) {
                            return currentClass.value.exams; // Toutes les matières
                        }
                        return currentClass.value.exams.filter(e => e.subjectId === currentSubjectId.value);
                    });

                    // Ajouter une matière
                    const addSubject = () => {
                        if (!newSubjectName.value.trim() || !currentClass.value) return;
                        const subject = {
                            id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                            name: newSubjectName.value.trim()
                        };
                        currentClass.value.subjects.push(subject);
                        newSubjectName.value = '';
                        showSubjectModal.value = false;
                    };

                    // Supprimer une matière
                    const deleteSubject = (subjectId) => {
                        if (!currentClass.value) return;
                        // Vérifier s'il y a des évaluations pour cette matière
                        const examCount = currentClass.value.exams.filter(e => e.subjectId === subjectId).length;
                        if (examCount > 0) {
                            if (!confirm(t('confirm_delete_subject'))) {
                                return;
                            }
                            // Supprimer les évaluations associées
                            currentClass.value.exams = currentClass.value.exams.filter(e => e.subjectId !== subjectId);
                        }
                        currentClass.value.subjects = currentClass.value.subjects.filter(s => s.id !== subjectId);
                        // Réinitialiser la matière active si nécessaire
                        if (currentSubjectId.value === subjectId) {
                            currentSubjectId.value = currentClass.value.subjects[0]?.id || null;
                        }
                    };

                    // Sélectionner une matière
                    const selectSubject = (subjectId) => {
                        currentSubjectId.value = subjectId;
                    };

                    // === GESTION DES TRIMESTRES ===

                    // Trimestres de la classe courante
                    const currentTrimesters = computed(() => currentClass.value?.trimesters || []);

                    // Réinitialiser le formulaire de trimestre
                    const resetTrimesterForm = () => {
                        newTrimester.id = '';
                        newTrimester.name = '';
                        newTrimester.observation = '';
                    };

                    // Ouvrir le modal pour modifier un trimestre
                    const editTrimester = (tri) => {
                        newTrimester.id = tri.id;
                        newTrimester.name = tri.name;
                        newTrimester.observation = tri.observation || '';
                        showTrimesterModal.value = true;
                    };

                    // Ajouter/Modifier un trimestre
                    const saveTrimester = () => {
                        if (!newTrimester.name.trim() || !currentClass.value) return;

                        if (newTrimester.id) {
                            // Modification
                            const tri = currentClass.value.trimesters.find(t => t.id === newTrimester.id);
                            if (tri) {
                                tri.name = newTrimester.name.trim();
                                tri.observation = newTrimester.observation;
                            }
                        } else {
                            // Ajout
                            currentClass.value.trimesters.push({
                                id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                                name: newTrimester.name.trim(),
                                observation: newTrimester.observation
                            });
                        }

                        resetTrimesterForm();
                        showTrimesterModal.value = false;
                    };

                    // Supprimer un trimestre
                    const deleteTrimester = (triId) => {
                        if (!currentClass.value) return;

                        // Vérifier s'il y a des évaluations pour ce trimestre
                        const examCount = currentClass.value.exams.filter(e => e.trimesterId === triId).length;
                        if (examCount > 0) {
                            alert('Impossible de supprimer ce trimestre car il contient des évaluations. Réassignez d\'abord les évaluations.');
                            return;
                        }

                        if (!confirm('Supprimer ce trimestre ?')) return;

                        currentClass.value.trimesters = currentClass.value.trimesters.filter(t => t.id !== triId);

                        // Supprimer les observations des élèves pour ce trimestre
                        currentClass.value.students.forEach(student => {
                            if (student.trimesterObservations && student.trimesterObservations[triId]) {
                                delete student.trimesterObservations[triId];
                            }
                        });
                    };

                    // Observations des élèves par trimestre
                    const getTrimesterObservation = (student, triId) => {
                        return student.trimesterObservations?.[triId] || '';
                    };

                    const setTrimesterObservation = (student, triId, text) => {
                        if (!student.trimesterObservations) student.trimesterObservations = {};
                        student.trimesterObservations[triId] = text;
                    };

                    // === GESTION DES INFORMATIONS DE L'ENSEIGNANT ===

                    // Ouvrir le modal d'établissement (pour ajouter ou modifier)
                    const openEstablishmentModal = (establishment = null, fromClassModal = false) => {
                        if (establishment) {
                            // Mode édition
                            editingEstablishment.value = establishment.id;
                            newEstablishment.name = establishment.name || '';
                            newEstablishment.address = establishment.address || '';
                            newEstablishment.phone = establishment.phone || '';
                            newEstablishment.classes = [...(establishment.classes || [])];
                        } else {
                            // Mode ajout
                            editingEstablishment.value = null;
                            newEstablishment.name = '';
                            newEstablishment.address = '';
                            newEstablishment.phone = '';
                            newEstablishment.classes = [];
                        }
                        showEstablishmentModal.value = true;
                    };

                    // Sauvegarder un établissement (ajout ou modification)
                    const saveEstablishment = () => {
                        if (!newEstablishment.name.trim()) return;

                        if (editingEstablishment.value) {
                            // Modification d'un établissement existant
                            const est = db.establishments.find(e => e.id === editingEstablishment.value);
                            if (est) {
                                est.name = newEstablishment.name.trim();
                                est.address = newEstablishment.address || '';
                                est.phone = newEstablishment.phone || '';
                                est.classes = [...newEstablishment.classes];
                            }
                        } else {
                            // Ajout d'un nouvel établissement
                            const estId = Date.now().toString();
                            const classes = [...newEstablishment.classes];

                            // Si on crée un établissement depuis le modal de création de classe, ajouter la classe en attente
                            if (pendingClassIdForEstablishment.value) {
                                if (!classes.includes(pendingClassIdForEstablishment.value)) {
                                    classes.push(pendingClassIdForEstablishment.value);
                                }
                                // Mettre à jour le dropdown de sélection d'établissement pour la nouvelle classe
                                newClassEstablishmentId.value = estId;
                                // Réinitialiser l'ID en attente
                                pendingClassIdForEstablishment.value = null;
                            }

                            db.establishments.push({
                                id: estId,
                                name: newEstablishment.name.trim(),
                                address: newEstablishment.address || '',
                                phone: newEstablishment.phone || '',
                                classes: classes
                            });
                        }

                        // Réinitialiser le formulaire
                        newEstablishment.name = '';
                        newEstablishment.address = '';
                        newEstablishment.phone = '';
                        newEstablishment.classes = [];
                        editingEstablishment.value = null;
                        showEstablishmentModal.value = false;
                    };

                    // Supprimer un établissement
                    const deleteEstablishment = (id) => {
                        if (!confirm(t('confirm_delete_establishment'))) return;
                        db.establishments = db.establishments.filter(e => e.id !== id);
                        // Mettre à jour l'établissement principal si nécessaire
                        if (db.teacherInfo.mainEstablishment === id) {
                            db.teacherInfo.mainEstablishment = '';
                        }
                    };

                    // Obtenir les noms des classes liées à un établissement
                    const getEstablishmentClasses = (establishment) => {
                        if (!establishment?.classes || establishment.classes.length === 0) return [];
                        return establishment.classes.map(clsId => {
                            const cls = db.classes.find(c => c.id === clsId);
                            return cls ? cls.name : clsId;
                        });
                    };

                    // Obtenir l'établissement de la classe actuelle (basé sur les classes assignées à l'établissement)
                    const getCurrentClassEstablishment = computed(() => {
                        if (!currentClass.value) return null;
                        // Trouver l'établissement qui contient cette classe
                        const est = db.establishments.find(e =>
                            e.classes && e.classes.includes(currentClass.value.id)
                        );
                        return est || null;
                    });

                    // Assigner la classe à un établissement
                    const assignClassToEstablishment = (establishmentId) => {
                        if (!currentClass.value) return;

                        // Retirer la classe de tous les établissements
                        db.establishments.forEach(est => {
                            if (est.classes) {
                                est.classes = est.classes.filter(id => id !== currentClass.value.id);
                            }
                        });

                        // Ajouter la classe à l'établissement sélectionné (sauf si vide)
                        if (establishmentId) {
                            const est = db.establishments.find(e => e.id === establishmentId);
                            if (est) {
                                if (!est.classes) est.classes = [];
                                if (!est.classes.includes(currentClass.value.id)) {
                                    est.classes.push(currentClass.value.id);
                                }
                            }
                        }
                    };

                    // Réinitialiser le formulaire d'établissement
                    const resetEstablishmentForm = () => {
                        newEstablishment.name = '';
                        newEstablishment.address = '';
                        newEstablishment.phone = '';
                        newEstablishment.classes = [];
                        editingEstablishment.value = null;
                    };

                    // === FIN GESTION DES INFORMATIONS DE L'ENSEIGNANT ===

                    // === FIN GESTION DES TRIMESTRES ===

                    // === FIN GESTION DES MATIÈRES ===

                    // Propriétés calculées
                    const getEstablishmentName = (id) => {
                        if (!id) return '';
                        const est = db.establishments.find(e => e.id === id);
                        return est ? est.name : '';
                    };

                    const currentClass = computed(() => {
                        if (!db.classes || db.classes.length === 0) return { students: [], subjects: [], exams: [], planner: [], attendance: {}, appreciations: {}, trimesters: [] };
                        const idx = currentClassIndex.value;
                        return db.classes[idx < db.classes.length ? idx : 0] || db.classes[0];
                    });

                    const sortedPlanner = computed(() => {
                        if (!currentClass.value?.planner) return [];
                        return [...currentClass.value.planner].sort((a, b) => new Date(b.date) - new Date(a.date));
                    });

                    const classStats = computed(() => {
                        if (!currentClass.value || !currentClass.value.students || !currentClass.value.students.length) return { average: '-', highest: '-', lowest: '-' };

                        const averages = currentClass.value.students
                            .map(s => parseFloat(calculateAverage(s)))
                            .filter(v => !isNaN(v) && v !== '-');

                        if (averages.length === 0) return { average: '-', highest: '-', lowest: '-' };

                        const sum = averages.reduce((a, b) => a + b, 0);
                        return {
                            average: (sum / averages.length).toFixed(2),
                            highest: Math.max(...averages).toFixed(2),
                            lowest: Math.min(...averages).toFixed(2)
                        };
                    });

                    // Élèves filtrés par recherche
                    const filteredStudents = computed(() => {
                        if (!currentClass.value?.students) return [];
                        if (!searchQuery.value.trim()) return currentClass.value.students;
                        const query = searchQuery.value.toLowerCase().trim();
                        return currentClass.value.students.filter(s =>
                            (s.lastname && s.lastname.toLowerCase().includes(query)) ||
                            (s.firstname && s.firstname.toLowerCase().includes(query)) ||
                            (s.student_id && s.student_id.toLowerCase().includes(query))
                        );
                    });

                    // Planning filtré par recherche
                    const filteredPlanner = computed(() => {
                        if (!currentClass.value?.planner) return [];
                        let items = [...currentClass.value.planner].sort((a, b) => new Date(b.date) - new Date(a.date));
                        if (!searchPlanningQuery.value.trim()) return items;
                        const query = searchPlanningQuery.value.toLowerCase().trim();
                        return items.filter(item =>
                            (item.title && item.title.toLowerCase().includes(query)) ||
                            (item.content && item.content.toLowerCase().includes(query)) ||
                            (item.date && item.date.includes(query))
                        );
                    });

                    // Historique des fichiers avec IndexedDB
                    const loadRecentFiles = async () => {
                        recentFiles.value = await loadRecentFromDB();
                    };


                    // ========== FIN LICENCE RSA ==========

                    const addToRecent = async (name, path, handle) => {
                        const file = { name, path, date: new Date().toISOString(), handle: handle };
                        recentFiles.value = recentFiles.value.filter(f => f.path !== path);
                        recentFiles.value.unshift(file);
                        if (recentFiles.value.length > maxRecentFiles) {
                            recentFiles.value = recentFiles.value.slice(0, maxRecentFiles);
                        }
                        await saveRecentToDB(recentFiles.value);
                    };

                    const removeFromRecent = async (path) => {
                        recentFiles.value = recentFiles.value.filter(f => f.path !== path);
                        await removeFromDB(path);
                    };

                    const clearRecentFiles = async () => {
                        recentFiles.value = [];
                        await clearDB();
                    };

                    // Gestion des fichiers avec File System Access API
                    const openFilePicker = async () => {
                        // GUARDIAN: Vérifier la licence avant d'exécuter
                        await requireLicense(async () => {
                            try {
                                if (!window.showOpenFilePicker) {
                                    alert('Votre navigateur ne supporte pas l\'API File System Access. Utilisez Chrome, Edge ou Opera.');
                                    return;
                                }
                                const [handle] = await window.showOpenFilePicker({
                                    types: [{ description: 'Fichiers TeacherTrack', accept: { 'application/json': ['.json'] } }]
                                });
                                await loadFromHandle(handle, handle.name);
                            } catch (e) {
                                if (e.name !== 'AbortError') { console.error(e); alert('Erreur: ' + e.message); }
                            }
                        });
                    };

                    const loadFromHandle = async (handle, name) => {
                        try {
                            const file = await handle.getFile();
                            const content = await file.text();
                            const data = JSON.parse(content);
                            if (data.classes && Array.isArray(data.classes)) {
                                // VÉRIFIER LE PROPRIÉTAIRE AVANT DE CHARGER
                                if (!validateDataFileOwner(data)) {
                                    const fileOwner = `${data.teacherInfo?.lastname || ''} ${data.teacherInfo?.firstname || ''}`.trim();
                                    alert(`❌ Ce fichier appartient à "${fileOwner}".\n\nVotre licence est enregistrée pour "${licenseOwner.value}".\n\nVeuillez ouvrir un fichier vous appartenant.`);
                                    return;
                                }

                                // Migration des données anciennes et initialisation
                                data.classes.forEach(cls => {
                                    migrateSubjects(cls);
                                });
                                db.classes = data.classes;

                                // Charger les informations de l'enseignant dans db.teacherInfo
                                if (data.teacherInfo) {
                                    db.teacherInfo.lastname = data.teacherInfo.lastname || '';
                                    db.teacherInfo.firstname = data.teacherInfo.firstname || '';
                                    db.teacherInfo.schoolYear = data.teacherInfo.schoolYear || new Date().getFullYear().toString() + '-' + (new Date().getFullYear() + 1).toString();
                                    db.teacherInfo.mainEstablishment = data.teacherInfo.mainEstablishment || '';
                                    db.teacherInfo.subject = data.teacherInfo.subject || '';
                                    db.teacherInfo.teacherType = data.teacherInfo.teacherType || 'professor';
                                    db.teacherInfo.phone = data.teacherInfo.phone || '';
                                    db.teacherInfo.email = data.teacherInfo.email || '';
                                    db.teacherInfo.fieldRepublic = data.teacherInfo.fieldRepublic || '1- République Algérienne Démocratique et Populaire';
                                    db.teacherInfo.fieldMinistry = data.teacherInfo.fieldMinistry || '2- Ministère de l\'Éducation Nationale';
                                    db.teacherInfo.fieldDirectorate = data.teacherInfo.fieldDirectorate || '3- Direction de l\'Éducation de la Wilaya de Constantine';
                                }

                                // Charger les établissements dans db.establishments
                                if (data.establishments && Array.isArray(data.establishments)) {
                                    db.establishments = data.establishments;
                                } else if (data.teacherInfo && data.teacherInfo.secondaryEstablishments) {
                                    // Migration des anciens établissements secondaires
                                    db.establishments = data.teacherInfo.secondaryEstablishments.map((est, idx) => ({
                                        ...est,
                                        id: est.id || (Date.now().toString() + '_' + idx)
                                    }));
                                }

                                // Sélectionner la première matière par défaut
                                currentSubjectId.value = db.classes[0]?.subjects?.[0]?.id || null;
                                isDataLoaded.value = true;
                                fileHandle.value = handle;
                                fileName.value = name || handle.name;
                                await addToRecent(name || handle.name, name || handle.name, handle);
                            } else { alert('Format de fichier invalide'); }
                        } catch (e) {
                            console.error(e);
                            alert('Erreur lors de l\'ouverture: ' + e.message);
                        }
                    };

                    // Scanner un dossier
                    const scanFolder = async () => {
                        // GUARDIAN: Vérifier la licence avant d'exécuter
                        await requireLicense(async () => {
                            try {
                                if (!window.showDirectoryPicker) {
                                    alert('Votre navigateur ne supporte pas l\'API Directory Picker. Utilisez Chrome, Edge ou Opera.');
                                    return;
                                }
                                const dirHandle = await window.showDirectoryPicker();
                                scannedFiles.value = [];

                                for await (const entry of dirHandle.values()) {
                                    if (entry.kind === 'file' && entry.name.endsWith('.json')) {
                                        const file = await entry.getFile();
                                        scannedFiles.value.push({
                                            name: entry.name,
                                            handle: entry,
                                            size: file.size
                                        });
                                    }
                                }
                                showScanModal.value = true;
                            } catch (e) {
                                if (e.name !== 'AbortError') { console.error(e); alert('Erreur: ' + e.message); }
                            }
                        });
                    };

                    const openScannedFile = async (file) => {
                        // GUARDIAN: Vérifier la licence avant d'exécuter
                        await requireLicense(async () => {
                            await loadFromHandle(file.handle, file.name);
                            showScanModal.value = false;
                        });
                    };

                    const formatSize = (bytes) => {
                        if (bytes < 1024) return bytes + ' B';
                        let size = bytes < 1024 * 1024 ? (bytes / 1024).toFixed(1) : (bytes / (1024 * 1024)).toFixed(1);
                        // Convertir les chiffres arabes en chiffres normaux
                        if (currentLang.value === 'ar') {
                            size = size.replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
                        }
                        return size + (bytes < 1024 * 1024 ? ' KB' : ' MB');
                    };

                    // Fallback: charger un fichier via input standard
                    const loadFileFromInput = async (event) => {
                        // GUARDIAN: Vérifier la licence avant d'exécuter
                        await requireLicense(async () => {
                            const file = event.target.files[0];
                            if (!file) return;

                            try {
                                const content = await file.text();
                                const data = JSON.parse(content);
                                if (data.classes && Array.isArray(data.classes)) {
                                    // VÉRIFIER LE PROPRIÉTAIRE AVANT DE CHARGER
                                    if (!validateDataFileOwner(data)) {
                                        const fileOwner = `${data.teacherInfo?.lastname || ''} ${data.teacherInfo?.firstname || ''}`.trim();
                                        alert(`❌ Ce fichier appartient à "${fileOwner}".\n\nVotre licence est enregistrée pour "${licenseOwner.value}".\n\nVeuillez ouvrir un fichier vous appartenant.`);
                                        event.target.value = '';
                                        return;
                                    }

                                    // Migration des données anciennes et initialisation
                                    data.classes.forEach(cls => {
                                        migrateSubjects(cls);
                                    });
                                    db.classes = data.classes;

                                    // Charger les informations de l'enseignant dans db.teacherInfo
                                    if (data.teacherInfo) {
                                        db.teacherInfo.lastname = data.teacherInfo.lastname || '';
                                        db.teacherInfo.firstname = data.teacherInfo.firstname || '';
                                        db.teacherInfo.schoolYear = data.teacherInfo.schoolYear || new Date().getFullYear().toString() + '-' + (new Date().getFullYear() + 1).toString();
                                        db.teacherInfo.mainEstablishment = data.teacherInfo.mainEstablishment || '';
                                        db.teacherInfo.subject = data.teacherInfo.subject || '';
                                        db.teacherInfo.teacherType = data.teacherInfo.teacherType || 'professor';
                                        db.teacherInfo.phone = data.teacherInfo.phone || '';
                                        db.teacherInfo.email = data.teacherInfo.email || '';
                                        db.teacherInfo.fieldRepublic = data.teacherInfo.fieldRepublic || '1- République Algérienne Démocratique et Populaire';
                                        db.teacherInfo.fieldMinistry = data.teacherInfo.fieldMinistry || '2- Ministère de l\'Éducation Nationale';
                                        db.teacherInfo.fieldDirectorate = data.teacherInfo.fieldDirectorate || '3- Direction de l\'Éducation de la Wilaya de Constantine';
                                    }

                                    // Charger les établissements dans db.establishments
                                    if (data.establishments && Array.isArray(data.establishments)) {
                                        db.establishments = data.establishments;
                                    } else if (data.teacherInfo && data.teacherInfo.secondaryEstablishments) {
                                        // Migration des anciens établissements secondaires
                                        db.establishments = data.teacherInfo.secondaryEstablishments.map((est, idx) => ({
                                            ...est,
                                            id: est.id || (Date.now().toString() + '_' + idx)
                                        }));
                                    }

                                    // Sélectionner la première matière par défaut
                                    currentSubjectId.value = db.classes[0]?.subjects?.[0]?.id || null;
                                    fileName.value = file.name;
                                    fileHandle.value = null; // Pas de handle, téléchargement manuel uniquement
                                    isDataLoaded.value = true;
                                    await addToRecent(file.name, file.name, null);
                                } else {
                                    alert('Format de fichier invalide');
                                }
                            } catch (e) {
                                console.error(e);
                                alert('Erreur lors de l\'ouverture: ' + e.message);
                            }
                            event.target.value = '';
                        });
                    };

                    // Drag & Drop
                    const handleDragOver = (e) => {
                        e.preventDefault();
                        const dropZone = document.getElementById('dropZone');
                        if (dropZone) dropZone.classList.add('dragover');
                    };

                    const handleDragLeave = (e) => {
                        e.preventDefault();
                        const dropZone = document.getElementById('dropZone');
                        if (dropZone) dropZone.classList.remove('dragover');
                    };

                    const handleDrop = async (e) => {
                        e.preventDefault();
                        const dropZone = document.getElementById('dropZone');
                        if (dropZone) dropZone.classList.remove('dragover');

                        const file = e.dataTransfer.files[0];
                        if (!file) return;

                        if (!file.name.endsWith('.json')) {
                            alert('Veuillez déposer un fichier .json');
                            return;
                        }

                        try {
                            const content = await file.text();
                            const data = JSON.parse(content);
                            if (data.classes && Array.isArray(data.classes)) {
                                // VÉRIFIER LE PROPRIÉTAIRE AVANT DE CHARGER
                                if (!validateDataFileOwner(data)) {
                                    const fileOwner = `${data.teacherInfo?.lastname || ''} ${data.teacherInfo?.firstname || ''}`.trim();
                                    alert(`❌ Ce fichier appartient à "${fileOwner}".\n\nVotre licence est enregistrée pour "${licenseOwner.value}".\n\nVeuillez ouvrir un fichier vous appartenant.`);
                                    return;
                                }

                                db.classes = data.classes;

                                // Charger les informations de l'enseignant
                                if (data.teacherInfo) {
                                    db.teacherInfo.lastname = data.teacherInfo.lastname || '';
                                    db.teacherInfo.firstname = data.teacherInfo.firstname || '';
                                    db.teacherInfo.schoolYear = data.teacherInfo.schoolYear || new Date().getFullYear().toString() + '-' + (new Date().getFullYear() + 1).toString();
                                    db.teacherInfo.mainEstablishment = data.teacherInfo.mainEstablishment || '';
                                    db.teacherInfo.subject = data.teacherInfo.subject || '';
                                    db.teacherInfo.teacherType = data.teacherInfo.teacherType || 'professor';
                                    db.teacherInfo.phone = data.teacherInfo.phone || '';
                                    db.teacherInfo.email = data.teacherInfo.email || '';
                                }

                                fileName.value = file.name;
                                fileHandle.value = null;
                                isDataLoaded.value = true;
                                await addToRecent(file.name, file.name, null);
                            } else {
                                alert('Format de fichier invalide');
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Erreur lors de l\'ouverture: ' + err.message);
                        }
                    };

                    // ========== FONCTIONS CAPACITOR NATIF (ANDROID) ==========

                    // Scanner les espaces disponibles sur Android
                    const loadSpaces = async () => {
                        if (!window.Capacitor || !window.Capacitor.isNativePlatform()) return;

                        try {
                            // 1. Créer le dossier 'sgc-teachertrack' s'il n'existe pas dans Documents
                            try {
                                await window.Filesystem.mkdir({
                                    path: 'sgc-teachertrack',
                                    directory: window.Directory.Documents,
                                    recursive: true
                                });
                            } catch (e) { }

                            // 2. Lire le contenu
                            const result = await window.Filesystem.readdir({
                                path: 'sgc-teachertrack',
                                directory: window.Directory.Documents
                            });

                            // 3. Filtrer les .json
                            availableSpaces.value = result.files
                                .filter(f => f.name.endsWith('.json'))
                                .map(f => ({
                                    name: f.name.replace('.json', ''),
                                    path: 'sgc-teachertrack/' + f.name
                                }));

                        } catch (e) {
                            console.error("Erreur chargement espaces:", e);
                        }
                    };

                    // Créer un nouvel espace sur Android
                    const createNewSpace = async () => {
                        // Mode Web classique
                        if (!window.Capacitor?.isNativePlatform()) {
                            createNewFile(); // Appel ancienne fonction web
                            return;
                        }

                        // Mode Android
                        const name = prompt("Nom du nouvel espace (ex: Année 2025) :");
                        if (!name) return;

                        // Vérifier qu'une licence valide existe
                        if (!isLicenseValid.value) {
                            alert('Une licence valide est requise pour créer un espace.');
                            return;
                        }

                        const safeName = name.replace(/[^a-z0-9àâçéèêëîïôûùüÿñæœ -]/gi, '_');
                        const fullPath = `sgc-teachertrack/${safeName}.json`;

                        // Extraire le nom et prénom depuis la licence
                        const licenseParts = licenseOwner.value ? licenseOwner.value.split(' ') : [];
                        const teacherLastname = licenseParts.length > 1 ? licenseParts.slice(0, -1).join(' ') : (licenseParts[0] || '');
                        const teacherFirstname = licenseParts.length > 1 ? licenseParts[licenseParts.length - 1] : '';

                        // Structure avec les informations de l'enseignant depuis la licence
                        const emptyDb = {
                            classes: [],
                            teacherInfo: {
                                lastname: teacherLastname,
                                firstname: teacherFirstname
                            },
                            establishments: []
                        };

                        try {
                            await window.Filesystem.writeFile({
                                path: fullPath,
                                data: JSON.stringify(emptyDb, null, 2),
                                directory: window.Directory.Documents,
                                encoding: window.Encoding.UTF8
                            });

                            await loadSpaces(); // Rafraîchir la liste
                            await openSpace(safeName); // Ouvrir direct
                        } catch (e) {
                            alert("Erreur création : " + e.message);
                        }
                    };

                    // Ouvrir un espace existant sur Android
                    const openSpace = async (spaceName) => {
                        // GUARDIAN: Vérifier la licence avant d'exécuter
                        await requireLicense(async () => {
                            try {
                                const contents = await window.Filesystem.readFile({
                                    path: `sgc-teachertrack/${spaceName}.json`,
                                    directory: window.Directory.Documents,
                                    encoding: window.Encoding.UTF8
                                });

                                const data = JSON.parse(contents.data);

                                // VÉRIFIER LE PROPRIÉTAIRE AVANT DE CHARGER
                                if (!validateDataFileOwner(data)) {
                                    const fileOwner = `${data.teacherInfo?.lastname || ''} ${data.teacherInfo?.firstname || ''}`.trim();
                                    alert(`❌ Ce fichier appartient à "${fileOwner}".\n\nVotre licence est enregistrée pour "${licenseOwner.value}".\n\nVeuillez ouvrir un fichier vous appartenant.`);
                                    return;
                                }

                                // Logique de chargement existante
                                if (data.classes) {
                                    if (Array.isArray(data.classes)) data.classes.forEach(cls => migrateSubjects(cls));
                                    db.classes = data.classes;
                                    if (data.teacherInfo) Object.assign(db.teacherInfo, data.teacherInfo);
                                    if (data.establishments) db.establishments = data.establishments;
                                }

                                isDataLoaded.value = true;
                                fileName.value = spaceName;
                            } catch (e) {
                                alert("Impossible d'ouvrir : " + e.message);
                            }
                        });
                    };

                    const createNewFile = async () => {
                        // GUARDIAN: Vérifier la licence avant d'exécuter
                        await requireLicense(async () => {
                            try {
                                if (!window.showSaveFilePicker) {
                                    alert('Votre navigateur ne supporte pas l\'API File System Access.');
                                    return;
                                }

                                // Vérifier qu'une licence valide existe
                                if (!isLicenseValid.value) {
                                    alert('Une licence valide est requise pour créer un fichier.');
                                    return;
                                }

                                const handle = await window.showSaveFilePicker({
                                    suggestedName: 'TeacherTrack_' + new Date().toISOString().slice(0, 10) + '.json',
                                    types: [{ description: 'Fichiers TeacherTrack', accept: { 'application/json': ['.json'] } }]
                                });
                                fileHandle.value = handle;
                                fileName.value = handle.name;

                                // Extraire le nom et prénom depuis la licence
                                const licenseParts = licenseOwner.value ? licenseOwner.value.split(' ') : [];
                                db.teacherInfo.lastname = licenseParts.length > 1 ? licenseParts.slice(0, -1).join(' ') : (licenseParts[0] || '');
                                db.teacherInfo.firstname = licenseParts.length > 1 ? licenseParts[licenseParts.length - 1] : '';

                                db.classes = [];
                                isDataLoaded.value = true;
                                await addToRecent(handle.name, handle.name, handle);
                                // Note: pas de vérification nécessaire - nouveau fichier créé avec les infos de la licence
                            } catch (e) {
                                if (e.name !== 'AbortError') { console.error(e); alert('Erreur: ' + e.message); }
                            }
                        });
                    };

                    const openRecentFile = async (file) => {
                        // GUARDIAN: Vérifier la licence avant d'exécuter
                        await requireLicense(async () => {
                            try {
                                if (file.handle) {
                                    // Tenter de rouvrir avec le handle stocké
                                    await loadFromHandle(file.handle, file.name);
                                } else {
                                    // Fallback: ouvrir via sélecteur
                                    const [handle] = await window.showOpenFilePicker({
                                        types: [{ description: 'Fichiers TeacherTrack', accept: { 'application/json': ['.json'] } }]
                                    });
                                    await loadFromHandle(handle, file.name);
                                }
                            } catch (e) {
                                if (e.name !== 'AbortError') { alert('Erreur: ' + e.message); }
                            }
                        });
                    };

                    const saveFile = async () => {
                        // --- CAS 1 : ANDROID (APK) ---
                        // On écrit silencieusement dans le dossier Documents/sgc-teachertrack
                        if (window.Capacitor?.isNativePlatform()) {
                            try {
                                // Normaliser le nom de fichier (enlever .json si présent, puis rajouter)
                                let baseFileName = fileName.value || 'classe_sans_nom';
                                if (baseFileName.endsWith('.json')) {
                                    baseFileName = baseFileName.slice(0, -5);
                                }
                                const fullPath = `sgc-teachertrack/${baseFileName}.json`;

                                console.log('[SaveFile] Sauvegarde vers:', fullPath);

                                // Créer le dossier s'il n'existe pas
                                try {
                                    await window.Filesystem.mkdir({
                                        path: 'sgc-teachertrack',
                                        directory: window.Directory.Documents,
                                        recursive: true
                                    });
                                } catch (e) { /* Le dossier existe déjà */ }

                                // Sauvegarder les données
                                await window.Filesystem.writeFile({
                                    path: fullPath,
                                    data: JSON.stringify(db, null, 2),
                                    directory: window.Directory.Documents,
                                    encoding: window.Encoding.UTF8
                                });

                                hasUnsavedChanges.value = false;
                                console.log('[SaveFile] Sauvegarde réussie:', fullPath);
                                alert(`Sauvegardé: ${baseFileName}.json`);
                            } catch (e) {
                                console.error('[SaveFile] Erreur:', e);
                                alert("Erreur sauvegarde : " + e.message);
                            }
                            return;
                        }

                        // --- CAS 2 : DESKTOP (Web Moderne - Chrome/Edge) ---
                        // On écrase le fichier ouvert via l'API File System Access
                        if (fileHandle.value) {
                            try {
                                const writable = await fileHandle.value.createWritable();
                                await writable.write(JSON.stringify(db, null, 2));
                                await writable.close();
                                hasUnsavedChanges.value = false;
                                console.log('Sauvegardé sur le PC (Écrasement)');
                            } catch (e) {
                                console.error(e);
                                alert("Erreur PC : " + e.message);
                            }
                            return;
                        }

                        // --- CAS 3 : FALLBACK (Firefox / Safari / Anciens fichiers) ---
                        // On déclenche un téléchargement
                        const data = JSON.stringify(db, null, 2);
                        const blob = new Blob([data], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName.value || 'teachertrack.json';
                        a.click();
                        URL.revokeObjectURL(url);
                        hasUnsavedChanges.value = false;
                    };

                    const closeFile = () => {
                        if (hasUnsavedChanges.value) {
                            const action = confirm('Des modifications n\'ont pas été sauvegardées.\n\nCliquez sur OK pour sauvegarder avant de fermer, ou Annuler pour fermer sans sauvegarder.');
                            if (action) {
                                saveFile();
                            }
                        }
                        if (!hasUnsavedChanges.value || !fileHandle.value) {
                            if (!hasUnsavedChanges.value || confirm('Fermer sans sauvegarder ?')) {
                                isDataLoaded.value = false;
                                db.classes = [];
                                fileHandle.value = null;
                                fileName.value = '';
                                hasUnsavedChanges.value = false;
                            }
                        }
                    };

                    // Classes
                    const addClass = () => {
                        if (!newClassName.value) return;
                        const subjectName = newClassSubject.value.trim() || t('main_subject');
                        // Utiliser l'ID en attente si disponible, sinon générer un nouveau
                        const newClassId = pendingClassIdForEstablishment.value || Date.now().toString();

                        db.classes.push({
                            id: newClassId,
                            name: newClassName.value,
                            subjects: [{
                                id: Date.now().toString() + '_sub',
                                name: subjectName
                            }],
                            students: [],
                            exams: [],
                            attendance: {},
                            planner: []
                        });

                        // Assigner la classe à l'établissement sélectionné
                        if (newClassEstablishmentId.value) {
                            const est = db.establishments.find(e => e.id === newClassEstablishmentId.value);
                            if (est) {
                                if (!est.classes) est.classes = [];
                                if (!est.classes.includes(newClassId)) {
                                    est.classes.push(newClassId);
                                }
                            }
                        }

                        // Réinitialiser le formulaire
                        newClassName.value = '';
                        newClassSubject.value = '';
                        newClassEstablishmentId.value = '';
                        pendingClassIdForEstablishment.value = null;
                        currentClassIndex.value = db.classes.length - 1;
                        // Sélectionner la première matière de la nouvelle classe
                        currentSubjectId.value = db.classes[currentClassIndex.value].subjects[0].id;
                    };

                    // Élèves
                    const resetStudentForm = () => {
                        newStudent.firstname = '';
                        newStudent.lastname = '';
                        newStudent.student_id = '';
                        newStudent.birthdate = '';
                        newStudent.address = '';
                        newStudent.phone = '';
                        newStudent.parent_father = '';
                        newStudent.parent_father_email = '';
                        newStudent.parent_mother = '';
                        newStudent.parent_mother_email = '';
                        newStudent.photo = '';
                    };

                    const addStudent = () => {
                        if (!newStudent.lastname) return;
                        currentClass.value.students.push({
                            id: Date.now().toString(),
                            student_id: newStudent.student_id,
                            firstname: newStudent.firstname,
                            lastname: newStudent.lastname,
                            birthdate: newStudent.birthdate,
                            address: newStudent.address,
                            phone: newStudent.phone,
                            parent_father: newStudent.parent_father,
                            parent_father_email: newStudent.parent_father_email,
                            parent_mother: newStudent.parent_mother,
                            parent_mother_email: newStudent.parent_mother_email,
                            photo: newStudent.photo,
                            grades: {}
                        });
                        resetStudentForm();
                        showStudentModal.value = false;
                    };

                    const deleteStudent = (idx) => {
                        if (confirm(t('confirm_delete_student'))) currentClass.value.students.splice(idx, 1);
                    };

                    // Gestion des photos
                    const handlePhotoUpload = (event) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        // Vérifier le type de fichier
                        if (!file.type.match(/image\/(jpeg|png|jpg)/)) {
                            alert('Veuillez sélectionner une image JPG ou PNG');
                            return;
                        }

                        // Vérifier la taille (2Mo max)
                        if (file.size > 2097152) {
                            alert('L\'image est trop volumineuse. Maximum 2Mo requis.');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            newStudent.photo = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    };

                    const removeStudentPhoto = () => {
                        newStudent.photo = '';
                    };

                    const handleDetailPhotoUpload = (event, student) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        if (!file.type.match(/image\/(jpeg|png|jpg)/)) {
                            alert('Veuillez sélectionner une image JPG ou PNG');
                            return;
                        }

                        if (file.size > 2097152) {
                            alert('L\'image est trop volumineuse. Maximum 2Mo requis.');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            student.photo = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    };

                    const removeDetailPhoto = (student) => {
                        student.photo = '';
                    };

                    const importExcel = (event) => {
                        const file = event.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                                // Utiliser header: 1 pour obtenir des tableaux, pas des objets
                                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                                console.log('Total rows:', rows.length);
                                console.log('First 10 rows:');
                                for (let i = 0; i < Math.min(rows.length, 10); i++) {
                                    console.log(`Row ${i}:`, rows[i]);
                                }

                                // Trouver la ligne avec les données élèves (skip lignes d'en-tête)
                                let dataStartIndex = 0;
                                for (let i = 0; i < Math.min(rows.length, 20); i++) {
                                    const row = rows[i];
                                    // Si la première cellule contient un matricule (numérique)
                                    const firstCell = row && row[0] ? String(row[0]).trim() : '';
                                    console.log(`Row ${i}: firstCell="${firstCell}" isNumeric=${/^\d+$/.test(firstCell)}`);

                                    if (firstCell.length > 10 && /^\d+$/.test(firstCell)) {
                                        dataStartIndex = i;
                                        console.log('Data starts at row', i);
                                        break;
                                    }
                                }

                                let count = 0;
                                for (let i = dataStartIndex; i < rows.length; i++) {
                                    const row = rows[i];
                                    if (!row || row.length < 4) continue;

                                    const matricule = String(row[0] || '').trim();
                                    const lastname = String(row[1] || '').trim();
                                    const firstname = String(row[2] || '').trim();
                                    const birthdate = String(row[3] || '').trim();

                                    console.log(`Row ${i}: mat="${matricule}" nom="${lastname}" prenom="${firstname}"`);

                                    // Skip les lignes d'en-tête et les lignes vides
                                    if (matricule && matricule !== 'matricule' && matricule !== 'رقم التعريف' &&
                                        (lastname || firstname) && lastname !== 'اللقب') {
                                        currentClass.value.students.push({
                                            id: Date.now().toString() + Math.random(),
                                            student_id: matricule,
                                            firstname: firstname,
                                            lastname: lastname,
                                            birthdate: birthdate,
                                            address: '',
                                            phone: '',
                                            parent_father: '',
                                            parent_mother: '',
                                            photo: '',
                                            grades: {}
                                        });
                                        count++;
                                    }
                                }
                                alert(t('import_success', count));
                            } catch (e) { alert('Erreur: ' + e.message); console.error(e); }
                        };
                        reader.readAsArrayBuffer(file);
                    };

                    // Évaluations
                    const addExam = () => {
                        if (!newExam.name) return;
                        // Utiliser la matière active ou la première matière
                        const subjectId = currentSubjectId.value || currentClass.value.subjects?.[0]?.id;
                        // Utiliser le premier trimestre par défaut si aucun sélectionné
                        const trimesterId = newExam.trimesterId || currentClass.value.trimesters?.[0]?.id || 'tri1';
                        currentClass.value.exams.push({
                            id: Date.now().toString(),
                            name: newExam.name,
                            max: newExam.max,
                            coeff: newExam.coeff,
                            subjectId: subjectId,
                            trimesterId: trimesterId
                        });
                        newExam.name = '';
                        newExam.max = 20;
                        newExam.coeff = 1;
                        newExam.subjectId = '';
                        newExam.trimesterId = '';
                        showExamModal.value = false;
                    };

                    // Moyennes
                    const calculateAverage = (student) => {
                        if (!filteredExams.value.length) return '-';
                        let total = 0, coefTotal = 0;
                        filteredExams.value.forEach(exam => {
                            const grade = student.grades[exam.id];
                            if (grade !== undefined && grade !== null && grade !== '') {
                                total += (grade / exam.max) * 10 * exam.coeff;
                                coefTotal += exam.coeff;
                            }
                        });
                        return coefTotal === 0 ? '-' : (total / coefTotal).toFixed(2);
                    };

                    // Moyenne par trimestre
                    const calculateTrimesterAverage = (student, trimesterId) => {
                        const trimesterExams = filteredExams.value.filter(e => e.trimesterId === trimesterId);
                        if (!trimesterExams.length) return '-';

                        let total = 0, coefTotal = 0;
                        trimesterExams.forEach(exam => {
                            const grade = student.grades[exam.id];
                            if (grade !== undefined && grade !== null && grade !== '') {
                                total += (grade / exam.max) * 10 * exam.coeff;
                                coefTotal += exam.coeff;
                            }
                        });
                        return coefTotal === 0 ? '-' : (total / coefTotal).toFixed(2);
                    };

                    // Moyenne annuelle (moyenne des moyennes trimestrielles)
                    const calculateAnnualAverage = (student) => {
                        const trimesters = currentClass.value?.trimesters || [];
                        if (!trimesters.length) return '-';

                        let total = 0, count = 0;
                        trimesters.forEach(tri => {
                            const triAvg = calculateTrimesterAverage(student, tri.id);
                            if (triAvg !== '-') {
                                total += parseFloat(triAvg);
                                count++;
                            }
                        });
                        return count === 0 ? '-' : (total / count).toFixed(2);
                    };

                    // Compter le nombre d'examens pour un trimestre donné
                    const getTrimesterExamCount = (trimesterId) => {
                        return filteredExams.value.filter(e => e.trimesterId === trimesterId).length;
                    };

                    // Observation pour un trimestre
                    const promptObservation = (student, tri) => {
                        const currentObs = getTrimesterObservation(student, tri.id);
                        const newObs = prompt(t('trimester_observation') + ' - ' + tri.name, currentObs);
                        if (newObs !== null) {
                            setTrimesterObservation(student, tri.id, newObs);
                        }
                    };

                    const getGradeBadgeClass = (student) => {
                        const avg = calculateAverage(student);
                        if (avg === '-') return 'bg-slate-100 text-slate-500 px-2 py-1 rounded text-sm font-medium';
                        const n = parseFloat(avg);
                        if (n < 5) return 'bg-red-100 text-red-700 px-2 py-1 rounded text-sm font-medium';
                        if (n < 7) return 'bg-amber-100 text-amber-700 px-2 py-1 rounded text-sm font-medium';
                        return 'bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-sm font-medium';
                    };

                    // Fonctions pour les détails élève
                    const getSubjectName = (subjectId) => {
                        return currentClass.value?.subjects?.find(s => s.id === subjectId)?.name || 'Inconnue';
                    };

                    const getStudentSubjectAverage = (student) => {
                        if (!filteredExams.value.length) return '-';
                        let total = 0, coefTotal = 0;
                        filteredExams.value.forEach(exam => {
                            const grade = student.grades[exam.id];
                            if (grade !== undefined && grade !== null && grade !== '') {
                                total += (grade / exam.max) * 10 * exam.coeff;
                                coefTotal += exam.coeff;
                            }
                        });
                        return coefTotal === 0 ? '-' : (total / coefTotal).toFixed(2);
                    };

                    const getStudentGradeClass = (student, exam) => {
                        const grade = student.grades[exam.id];
                        if (grade === undefined || grade === null || grade === '') return 'text-slate-400';
                        const normalized = grade / exam.max;
                        if (normalized < 0.5) return 'bg-red-100 text-red-700 px-2 py-1 rounded font-medium';
                        if (normalized < 0.7) return 'bg-amber-100 text-amber-700 px-2 py-1 rounded font-medium';
                        return 'bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-medium';
                    };

                    const getStudentAttendance = (student) => {
                        if (!student) return {};
                        const id = typeof student === 'object' ? student.id : student;
                        if (!id) return {};
                        return currentClass.value?.attendance?.[id] || {};
                    };

                    const formatDateShort = (dateStr) => {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        const locale = currentLang.value === 'ar' ? 'ar-EG' : 'fr-FR';
                        let formatted = date.toLocaleDateString(locale, { day: '2-digit', month: '2-digit' });
                        // Convertir les chiffres arabes en chiffres normaux
                        if (currentLang.value === 'ar') {
                            formatted = formatted.replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
                        }
                        return formatted;
                    };

                    const formatDateFull = (dateStr) => {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        const locale = currentLang.value === 'ar' ? 'ar-EG' : 'fr-FR';
                        let formatted = date.toLocaleDateString(locale, { day: '2-digit', month: '2-digit', year: 'numeric' });
                        // Convertir les chiffres arabes en chiffres normaux
                        if (currentLang.value === 'ar') {
                            formatted = formatted.replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
                        }
                        return formatted;
                    };

                    const getAttendanceCount = (student, type) => {
                        if (!student) return 0;
                        const id = typeof student === 'object' ? student.id : student;
                        if (!id) return 0;
                        const att = currentClass.value?.attendance || {};
                        let count = 0;
                        Object.values(att).forEach(day => { if (day[id] === type) count++; });
                        return count;
                    };

                    // Présences
                    const setAttendance = (studentId, status) => {
                        if (!currentClass.value.attendance[attendanceDate.value]) currentClass.value.attendance[attendanceDate.value] = {};
                        const current = currentClass.value.attendance[attendanceDate.value][studentId];
                        if (current === status) delete currentClass.value.attendance[attendanceDate.value][studentId];
                        else currentClass.value.attendance[attendanceDate.value][studentId] = status;
                    };

                    const getAttendanceClass = (studentId, status) => {
                        const current = currentClass.value.attendance[attendanceDate.value]?.[studentId];
                        if (status === 'present') return current === 'present' ? 'text-white border-emerald-600' : 'text-slate-400 border-slate-200';
                        if (status === 'absent') return current === 'absent' ? 'text-white border-red-600' : 'text-slate-400 border-slate-200';
                        if (status === 'late') return current === 'late' ? 'text-white border-amber-600' : 'text-slate-400 border-slate-200';
                        return 'text-slate-400 border-slate-200';
                    };

                    const getAttendanceStyle = (studentId, status) => {
                        const current = currentClass.value.attendance[attendanceDate.value]?.[studentId];
                        if (status === 'present' && current === 'present') return { backgroundColor: '#10b981' };
                        if (status === 'absent' && current === 'absent') return { backgroundColor: '#ef4444' };
                        if (status === 'late' && current === 'late') return { backgroundColor: '#f59e0b' };
                        return { backgroundColor: '#ffffff' };
                    };

                    // Appréciations journalières
                    const setAppreciation = (studentId, type) => {
                        if (!currentClass.value.appreciations) currentClass.value.appreciations = {};
                        if (!currentClass.value.appreciations[attendanceDate.value]) currentClass.value.appreciations[attendanceDate.value] = {};
                        const current = currentClass.value.appreciations[attendanceDate.value][studentId];
                        if (current === type) delete currentClass.value.appreciations[attendanceDate.value][studentId];
                        else currentClass.value.appreciations[attendanceDate.value][studentId] = type;
                    };

                    const getAppreciationCount = (student, type) => {
                        if (!student) return 0;
                        const id = typeof student === 'object' ? student.id : student;
                        if (!id) return 0;
                        const app = currentClass.value?.appreciations || {};
                        let count = 0;
                        Object.values(app).forEach(day => { if (day[id] === type) count++; });
                        return count;
                    };

                    const getAppreciationClass = (studentId, type) => {
                        const current = currentClass.value.appreciations?.[attendanceDate.value]?.[studentId];
                        if (type === 'star') return current === 'star' ? 'text-yellow-500 border-yellow-500 bg-yellow-50' : 'text-slate-300 border-slate-200';
                        if (type === 'stop') return current === 'stop' ? 'text-red-500 border-red-500 bg-red-50' : 'text-slate-300 border-slate-200';
                        return 'text-slate-300 border-slate-200';
                    };

                    const getAppreciationIcon = (studentId, type) => {
                        const current = currentClass.value.appreciations?.[attendanceDate.value]?.[studentId];
                        if (type === 'star') return current === 'star' ? 'fa-star text-yellow-500' : 'fa-star text-slate-300';
                        if (type === 'stop') return current === 'stop' ? 'fa-stop text-red-500' : 'fa-stop text-slate-300';
                        return 'fa-star text-slate-300';
                    };

                    // Planning
                    const addPlannerItem = () => {
                        currentClass.value.planner.push({ date: new Date().toISOString().split('T')[0], title: '', content: '' });
                    };

                    const deletePlannerItem = (idx) => { currentClass.value.planner.splice(idx, 1); };

                    // Export
                    const exportToExcel = () => {
                        if (!currentClass.value) return;
                        const rows = [['Nom', 'Prénom', 'Moyenne']];
                        currentClass.value.exams.forEach(ex => { rows[0].push(ex.name + ' (/' + ex.max + ')'); });
                        currentClass.value.students.forEach(s => {
                            const row = [s.lastname, s.firstname, calculateAverage(s)];
                            currentClass.value.exams.forEach(ex => { row.push(s.grades[ex.id] || ''); });
                            rows.push(row);
                        });
                        const ws = XLSX.utils.aoa_to_sheet(rows);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'Notes');
                        XLSX.writeFile(wb, 'Notes_' + currentClass.value.name + '.xlsx');
                    };

                    // Export format officiel (document de relevé de notes)
                    const exportGradesToExcel = () => {
                        if (!currentClass.value) return;

                        const isRTL = exportFormat.value === 'rtl';
                        const trimestersList = Array.isArray(currentTrimesters.value) ? currentTrimesters.value : [];
                        const selectedTriName = selectedTrimesterExport.value
                            ? trimestersList.find(t => t.id === selectedTrimesterExport.value)?.name || ''
                            : '';
                        const trimesterExams = selectedTrimesterExport.value
                            ? currentClass.value.exams.filter(e => e.trimesterId === selectedTrimesterExport.value)
                            : currentClass.value.exams;

                        let rows = [];

                        // En-têtes officiels - Version Arabe ou Française
                        // Les 2 versions utilisent les valeurs configurables dans "Mes Infos"
                        if (isRTL) {
                            // Version Arabe: Utiliser les valeurs du JSON (éditables dans Mes Infos)
                            // Ligne 1: République (sans le chiffre)
                            rows.push([db.teacherInfo.fieldRepublic ? db.teacherInfo.fieldRepublic.replace(/^\d+-\s*/, '') : '', null, null, null, null, null, null, null, null]);
                            // Ligne 2: Ministère (sans le chiffre)
                            rows.push([db.teacherInfo.fieldMinistry ? db.teacherInfo.fieldMinistry.replace(/^\d+-\s*/, '') : '', null, null, null, null, null, null, null, null]);
                            // Ligne 3: Direction + Wilaya (sans le chiffre)
                            const directionAr = db.teacherInfo.fieldDirectorate ? db.teacherInfo.fieldDirectorate.replace(/^\d+-\s*/, '') : '';
                            rows.push([directionAr, null, null, null, null, null, null, null, null]);

                            // Ligne 4: Établissement
                            const establishmentName = getEstablishmentName(db.teacherInfo.mainEstablishment);
                            rows.push([establishmentName || '', null, null, null, null, null, null, null, null]);

                            // Ligne 5: Titre document + Classe + Matière + Année (Arabe)
                            const classInfo = `وثيقة حجز النقاط الخاصة بـ:${selectedTriName} ${t('school_year')}:${db.teacherInfo.schoolYear || ''} الفوج التربوي :${currentClass.value.name} مادة :${currentSubject?.name || ''}`;
                            rows.push([classInfo, null, null, null, null, null, null, null, null]);

                            // En-têtes colonnes arabes uniquement (ordre inversé pour affichage RTL)
                            const examHeaders = trimesterExams.map(ex => `${ex.name} /${ex.max}`);
                            // En RTL: la première colonne (A) est à DROITE, donc on inverse l'ordre
                            const headerRowAr = ['الملاحظات', ...examHeaders.map(h => h.replace('/', ' /')).reverse(), 'تاريخ الميلاد', 'الاسم', 'اللقب', 'رقم التعريف'].reverse();
                            rows.push(headerRowAr);
                        } else {
                            // Version Française: Utiliser les valeurs de l'utilisateur (éditables)
                            // Ligne 1: République
                            rows.push([db.teacherInfo.fieldRepublic ? db.teacherInfo.fieldRepublic.replace(/^\d+-\s*/, '') : '', null, null, null, null, null, null, null, null]);
                            // Ligne 2: Ministère
                            rows.push([db.teacherInfo.fieldMinistry ? db.teacherInfo.fieldMinistry.replace(/^\d+-\s*/, '') : '', null, null, null, null, null, null, null, null]);
                            // Ligne 3: Direction + Wilaya
                            const directionFr = db.teacherInfo.fieldDirectorate ? db.teacherInfo.fieldDirectorate.replace(/^\d+-\s*/, '') : '';
                            rows.push([directionFr, null, null, null, null, null, null, null, null]);

                            // Ligne 4: Établissement
                            const establishmentName = getEstablishmentName(db.teacherInfo.mainEstablishment);
                            rows.push([establishmentName || '', null, null, null, null, null, null, null, null]);

                            // Ligne 5: Classe + Matière + Année
                            const classInfo = `${currentClass.value.name} - ${currentSubject?.name || ''} - ${t('school_year')}: ${db.teacherInfo.schoolYear || ''}`;
                            rows.push([classInfo, null, null, null, null, null, null, null, null]);

                            // Ligne 6: Titre du document
                            let title = `Relevé de notes - ${selectedTriName || 'Tous'}`;
                            rows.push([title, null, null, null, null, null, null, null, null]);

                            const examHeaders = trimesterExams.map(ex => `${ex.name} /${ex.max}`);
                            const headerRow = ['Matricule', 'Nom', 'Prénom', 'Date de naissance', ...examHeaders, 'Observations'];
                            rows.push(headerRow);
                        }

                        // Données élèves
                        // Pour RTL: inverser l'ordre des élèves pour que le remplissage se fasse de droite à gauche
                        const studentsToExport = isRTL
                            ? [...currentClass.value.students].reverse()
                            : currentClass.value.students;

                        studentsToExport.forEach(s => {
                            let studentRow;

                            if (isRTL) {
                                // Pour RTL: construire la ligne dans l'ordre inverse
                                // Le matricule doit être en premier (colonne A) pour apparaître à DROITE en mode RTL
                                const examGrades = trimesterExams.map(ex => s.grades[ex.id] !== undefined ? s.grades[ex.id] : '');
                                const observation = selectedTrimesterExport.value
                                    ? (s.trimesterObservations?.[selectedTrimesterExport.value] || '')
                                    : '';
                                // Ordre: matricule, nom, prenom, date_n, exam1, exam2, exam3, obs
                                // Avec RTL: A=matricule (droite), H=obs (gauche)
                                studentRow = [
                                    s.student_id || '',
                                    s.lastname || '',
                                    s.firstname || '',
                                    s.birthdate || '',
                                    ...examGrades,
                                    observation
                                ];
                            } else {
                                // Format Occidental
                                studentRow = [s.student_id || '', s.lastname || '', s.firstname || '', s.birthdate || ''];
                                trimesterExams.forEach(ex => {
                                    studentRow.push(s.grades[ex.id] !== undefined ? s.grades[ex.id] : '');
                                });
                                const observation = selectedTrimesterExport.value
                                    ? (s.trimesterObservations?.[selectedTrimesterExport.value] || '')
                                    : '';
                                studentRow.push(observation);
                            }
                            rows.push(studentRow);
                        });

                        // Créer la feuille
                        const ws = XLSX.utils.aoa_to_sheet(rows);

                        // Appliquer le style (gras et centrage) aux 5 premières lignes d'en-tête
                        // Note: js-xlsx free a des limitations pour le style, mais on essaie d'ajouter ce qui est possible
                        const headerRowCount = 5;
                        for (let r = 0; r < headerRowCount; r++) {
                            for (let c = 0; c <= 8; c++) {
                                const cellRef = XLSX.utils.encode_cell({ r: r, c: c });
                                if (ws[cellRef]) {
                                    // Style gras
                                    ws[cellRef].s = {
                                        font: { bold: true },
                                        alignment: { horizontal: 'center', vertical: 'center' }
                                    };
                                }
                            }
                        }

                        // Définir les largeurs de colonnes (l'ordre des largeurs doit correspondre à l'ordre des données)
                        // Pour RTL: les largeurs doivent être dans le même ordre que les données
                        const colWidths = isRTL
                            ? [
                                { wch: 20 }, // matricule (colonne de droite visuellement en RTL)
                                { wch: 15 }, // nom
                                { wch: 15 }, // prenom
                                { wch: 15 }, // date_n
                                ...Array(trimesterExams.length || 3).fill({ wch: 25 }), // examens
                                { wch: 30 }  // obs (colonne de gauche visuellement en RTL)
                            ]
                            : [
                                { wch: 20 }, // matricule
                                { wch: 15 }, // nom
                                { wch: 15 }, // prenom
                                { wch: 15 }, // date_n
                                ...Array(trimesterExams.length || 3).fill({ wch: 25 }), // examens
                                { wch: 30 }  // obs
                            ];
                        ws['!cols'] = colWidths;

                        // Fusionner les cellules des premières lignes d'en-tête officiel
                        // Les 5 premières lignes sont fusionnées horizontalement (A1:I5)
                        // La ligne des en-têtes de colonnes n'est PAS fusionnée
                        const headerRowsToMerge = 5;
                        const merges = [];
                        for (let r = 0; r < headerRowsToMerge; r++) {
                            merges.push({ s: { r: r, c: 0 }, e: { r: r, c: 8 } });
                        }
                        ws['!merges'] = merges;

                        // Pour le format Arabe: appliquer la direction RTL à Excel
                        // Cela inverse l'affichage des colonnes A,B,C... pour qu'elles apparaissent de droite à gauche
                        if (isRTL) {
                            ws['!view'] = { rightToLeft: true };
                        }

                        // Créer le workbook et activer les styles
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'Notes');

                        // Activer les styles si disponible
                        if (wb && !wb.props) wb.props = {};
                        wb.props.cellStyles = true;

                        // Configurer les vues du workbook pour RTL (inverse l'ordre des lettres de colonnes)
                        if (isRTL) {
                            // Définir explicitement les propriétés du workbook pour RTL
                            wb.Workbook = {
                                AppName: 'SheetJS',
                                CreatedDate: new Date(),
                                ModifiedDate: new Date(),
                                Views: [{
                                    RTL: true,
                                    xWindow: 0,
                                    yWindow: 0,
                                    windowWidth: 25600,
                                    windowHeight: 14400,
                                    activeCell: 'A1',
                                    firstSheet: 0,
                                    tabRatio: 600
                                }],
                                WorkbookView: {
                                    RTL: true
                                }
                            };
                        }

                        const formatSuffix = isRTL ? 'Arabe' : 'Occidental';
                        const trimesterName = selectedTrimesterExport.value
                            ? trimestersList.find(t => t.id === selectedTrimesterExport.value)?.name || ''
                            : 'Tous';
                        XLSX.writeFile(wb, `Notes_${currentClass.value.name}_${trimesterName}_${formatSuffix}.xlsx`);

                        // Fermer le modal et réinitialiser
                        showExportModal.value = false;
                        selectedTrimesterExport.value = '';
                        exportFormat.value = 'rtl';
                    };

                    const formatDate = (dateStr) => {
                        const date = new Date(dateStr);
                        const locale = currentLang.value === 'ar' ? 'ar-EG' : 'fr-FR';
                        let formatted = date.toLocaleDateString(locale, { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                        // Convertir les chiffres arabes en chiffres normaux
                        if (currentLang.value === 'ar') {
                            formatted = formatted.replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
                        }
                        return formatted;
                    };

                    // Mettre à jour la matière active quand on change de classe
                    const updateSubjectForClass = () => {
                        if (currentClass.value?.subjects?.length > 0) {
                            // Essayer de garder la même matière si elle existe dans la nouvelle classe
                            const hasCurrentSubject = currentClass.value.subjects.some(s => s.id === currentSubjectId.value);
                            if (!hasCurrentSubject) {
                                currentSubjectId.value = currentClass.value.subjects[0].id;
                            }
                        } else {
                            currentSubjectId.value = null;
                        }
                    };

                    onMounted(async () => {
                        // Petit délai pour laisser le temps au script d'injection de charger Capacitor
                        setTimeout(async () => {

                            // Charger la licence sauvegardée si elle existe
                            const savedLicense = localStorage.getItem('teachertrack_license_v1');
                            if (savedLicense) {
                                await verifyLicense(savedLicense);
                            }

                            // Si pas de licence valide, ouvrir le modal
                            if (!isLicenseValid.value) {
                                showLicenseModal.value = true;
                            }

                            // SI ANDROID : Détecter la plateforme et charger le gestionnaire d'espaces
                            isNative.value = window.Capacitor?.isNativePlatform() || false;

                            if (isNative.value) {
                                await loadSpaces(); // Votre fonction qui scanne le dossier sgc-teachertrack
                            }

                            // SI PC : Charger l'historique classique
                            else {
                                await loadRecentFiles();
                            }

                        }, 100); // 100ms de pause suffisent

                        console.log('TeacherTrack initialisé (Mode Hybride)');
                    });

                    // Watch pour détecter les modifications non sauvegardées
                    watch(() => db.classes, () => {
                        if (isDataLoaded.value) {
                            hasUnsavedChanges.value = true;
                        }
                    }, { deep: true });

                    // Watch pour détecter les modifications des informations de l'enseignant
                    watch(() => db.teacherInfo, () => {
                        if (isDataLoaded.value) {
                            hasUnsavedChanges.value = true;
                        }
                    }, { deep: true });

                    // Watch pour détecter les modifications des établissements
                    watch(() => db.establishments, () => {
                        if (isDataLoaded.value) {
                            hasUnsavedChanges.value = true;
                        }
                    }, { deep: true });

                    // Watch pour changer de matière quand on change de classe
                    watch(currentClassIndex, updateSubjectForClass);

                    // NOTE: Le watch sur isLicenseValid a été supprimé
                    // La validation du propriétaire du fichier est maintenant faite AVANT le chargement
                    // via validateDataFileOwner(), ce qui empêche le chargement de fichiers non autorisés
                    // sans invalider la licence de l'utilisateur

                    return {
                        isDataLoaded, db, currentClassIndex, currentTab, fileName,
                        showStudentModal, showExamModal, showClassModal, showSubjectModal, showScanModal, showTrimesterModal, showEstablishmentModal, showClassEstablishmentModal, showExportModal,
                        newStudent, newExam, newTrimester, newClassName, newClassSubject, newClassEstablishmentId, newSubjectName, attendanceDate, newEstablishment, selectedTrimesterExport, exportFormat,
                        currentSubjectId, selectedStudent,
                        recentFiles, scannedFiles, tabs, availableSpaces, isNative,
                        currentClass, currentSubjects, currentSubject, filteredExams, sortedPlanner, classStats, getCurrentClassEstablishment,
                        openFilePicker, loadFileFromInput, createNewFile, createNewSpace, openSpace, openRecentFile, saveFile, closeFile,
                        scanFolder, openScannedFile, formatSize, loadSpaces,
                        handleDragOver, handleDragLeave, handleDrop,
                        addToRecent, removeFromRecent, clearRecentFiles,
                        addClass, addStudent, deleteStudent, importExcel, resetStudentForm,
                        addExam, calculateAverage, calculateTrimesterAverage, calculateAnnualAverage, getTrimesterExamCount, getGradeBadgeClass, promptObservation,
                        setAttendance, getAttendanceClass, getAttendanceStyle, getAttendanceCount,
                        setAppreciation, getAppreciationCount, getAppreciationClass, getAppreciationIcon,
                        addPlannerItem, deletePlannerItem,
                        addSubject, deleteSubject, selectSubject, assignClassToEstablishment,
                        currentTrimesters,
                        editTrimester, deleteTrimester, saveTrimester, resetTrimesterForm,
                        getTrimesterObservation, setTrimesterObservation,
                        getSubjectName, getStudentSubjectAverage, getStudentGradeClass, getStudentAttendance, formatDateShort, formatDateFull,
                        exportToExcel, formatDate, hasUnsavedChanges,
                        exportGradesToExcel,
                        currentLang, setLang, t,
                        handlePhotoUpload, removeStudentPhoto, handleDetailPhotoUpload, removeDetailPhoto,
                        searchQuery, searchPlanningQuery, filteredStudents, filteredPlanner,
                        openEstablishmentModal, saveEstablishment, deleteEstablishment, resetEstablishmentForm, getEstablishmentClasses,
                        getEstablishmentName,
                        // Licence
                        showLicenseModal, licenseInput, licenseError, isLicenseValid, licenseOwner, isChangingLicense,
                        verifyLicense, verifyUserMatchWithLicense, cancelLicenseModal, importLicenseFile, openLicenseModalWithWarning
                    };
                }
            }).mount('#app');
        } // Fin de initApp()

        // Enregistrement du Service Worker PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('./sw.js')
                    .then(function (registration) {
                        console.log('[PWA] Service Worker enregistré avec succès:', registration.scope);

                        // Demander la persistance du stockage pour éviter que le navigateur efface les données
                        if (navigator.storage && navigator.storage.persist) {
                            navigator.storage.persist().then(function (granted) {
                                if (granted) {
                                    console.log('[PWA] ✅ Stockage persistant activé - Les données ne seront pas effacées');
                                } else {
                                    console.log('[PWA] ⚠️ Stockage persistant refusé par le navigateur');
                                }
                            });
                        }

                        // Afficher l'estimation du quota de stockage
                        if (navigator.storage && navigator.storage.estimate) {
                            navigator.storage.estimate().then(function (estimate) {
                                const usedMB = (estimate.usage / (1024 * 1024)).toFixed(2);
                                const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(0);
                                console.log('[PWA] 💾 Stockage utilisé: ' + usedMB + ' MB / ' + quotaMB + ' MB');
                            });
                        }
                    })
                    .catch(function (error) {
                        console.log('[PWA] Échec de l\'enregistrement du Service Worker:', error);
                    });
            });
        }
    </script>

</body>

</html>