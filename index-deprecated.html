<!DOCTYPE html>
<html lang="fr" dir="ltr" :class="{ 'font-ar': currentLang === 'ar', 'font-fr': currentLang === 'fr' }">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="TeacherTrack - Gestion de classe, suivi des √©l√®ves et des notes">
    <meta name="theme-color" content="#0f766e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SGC-TeacherTrack">
    <title>SGC-TeacherTrack - Gestion de Classe</title>

    <!-- Polices Google (Fran√ßais + Arabe) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Script de secours pour charger les ressources (d√©fini AVANT les CSS pour √™tre disponible) -->
    <script>
        // Fonction pour basculer vers le CDN en cas d'√©chec de chargement du fichier local
        function loadCDN(type, cdnUrl) {
            const element = document.getElementById(type + '-local');
            if (element) {
                console.log('‚ö†Ô∏è Fichier local ' + type + ' non trouv√©, basculement vers CDN...');
                element.setAttribute('href', cdnUrl);
            }
        }

        // Fonction pour charger les scripts JavaScript avec secours
        function loadScriptWithFallback(id, localPath, cdnUrl, callback) {
            // V√©rifier si le script est d√©j√† charg√©
            const existing = document.getElementById(id);
            if (existing && existing.getAttribute('data-loaded') === 'true') {
                console.log('‚úì Script ' + id + ' d√©j√† charg√©');
                if (callback) callback();
                return;
            }

            const script = document.createElement('script');
            script.id = id;
            script.src = localPath;
            script.onload = function () {
                console.log('‚úì Fichier local ' + id + ' charg√© avec succ√®s');
                script.setAttribute('data-loaded', 'true');
                if (callback) callback();
            };
            script.onerror = function () {
                console.log('‚ö†Ô∏è Fichier local ' + id + ' non trouv√©, basculement vers CDN...');
                script.src = cdnUrl;
                script.onload = function () {
                    console.log('‚úì CDN ' + id + ' charg√© avec succ√®s');
                    script.setAttribute('data-loaded', 'true');
                    if (callback) callback();
                };
                script.onerror = function () {
                    console.error('‚úó √âchec du chargement de ' + id + ' depuis le CDN √©galement');
                };
            };
            document.head.appendChild(script);
        }
    </script>

    <!-- Styles avec m√©canisme de secours (local ‚Üí CDN) -->
    <link id="fontawesome-local" rel="stylesheet" href="fontawesome.min.css"
        onerror="loadCDN('fontawesome', 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css')">
    <!-- Tailwind CSS via script CDN (toujours charg√©, pas de fallback fichier local pour le script JS Tailwind) -->
    <link rel="stylesheet" href="tailwind.css">

    <!-- Manifest PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- Ic√¥nes PWA -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

    <!-- Styles critiques anti-flash -->
    <style>
        /* Masque les √©l√©ments Vue non compil√©s */
        [v-cloak] {
            display: none !important;
        }

        /* Styles de base */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
        }

        /* Police arabe */
        .font-ar {
            font-family: 'Cairo', sans-serif !important;
        }

        .font-fr {
            font-family: 'Inter', system-ui, -apple-system, sans-serif !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Zone drag-and-drop */
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }

        .drop-zone.dragover {
            border-color: #6366f1;
            background-color: #eef2ff;
        }

        /* Force buttons background colors */
        .bg-emerald-600 {
            background-color: #059669 !important;
        }

        .bg-emerald-600:hover {
            background-color: #047857 !important;
        }

        /* Modal background */
        .bg-white {
            background-color: #ffffff !important;
        }
    </style>

    <script>
        (function () {
            // D√©tection : Si le protocole n'est PAS 'file:', on est probablement dans l'APK (http://localhost)
            const isApp = window.location.protocol !== 'file:';

            if (isApp) {
                console.log("üì± Mode APK d√©tect√© : Chargement de Capacitor...");
                // Les modules Capacitor seront charg√©s via le script en bas de page
            } else {
                console.log("üíª Mode Desktop d√©tect√© : Capacitor d√©sactiv√© (Utilisation File System API).");
                // Marquer comme d√©j√† pr√™t pour √©viter l'attente
                window.CapacitorReady = true;
            }
        })();
    </script>
</head>

<body>

    <!-- Application Vue -->
    <div id="app" v-cloak class="min-h-screen flex flex-col">

        <!-- ==================== -->
        <!-- √âCRAN D'ACCUEIL -->
        <!-- ==================== -->
        <div v-if="!isDataLoaded" class="min-h-screen bg-slate-900 p-4 overflow-auto">
            <!-- Banni√®re Licence -->
            <div v-if="isLicenseValid"
                class="mb-4 p-3 bg-emerald-600 text-white rounded-lg flex justify-between items-center shadow-lg">
                <span class="font-bold text-sm"><i class="fas fa-certificate text-yellow-400 mr-1"></i> {{
                    t('license_active') }}</span>
                <span class="font-mono text-xs">{{ licenseOwner }}</span>
            </div>
            <div v-else @click="showLicenseModal = true"
                class="mb-4 p-3 bg-red-600 text-white rounded-lg text-center font-bold cursor-pointer hover:bg-red-700 transition shadow-lg animate-pulse">
                <i class="fas fa-lock mr-1"></i> {{ t('license_not_activated') }}
            </div>

            <!-- S√©lecteur de langue (coin sup√©rieur droit) -->
            <div class="flex justify-end mb-4">
                <div class="flex items-center bg-slate-800 rounded-lg p-1">
                    <button @click="setLang('fr')"
                        :class="['px-3 py-1.5 rounded text-sm font-medium transition', currentLang === 'fr' ? 'bg-white text-indigo-600' : 'text-slate-400 hover:text-white']">
                        FR
                    </button>
                    <button @click="setLang('en')"
                        :class="['px-3 py-1.5 rounded text-sm font-medium transition', currentLang === 'en' ? 'bg-white text-indigo-600' : 'text-slate-400 hover:text-white']">
                        EN
                    </button>
                    <button @click="setLang('ar')"
                        :class="['px-3 py-1.5 rounded text-sm font-medium transition', currentLang === 'ar' ? 'bg-white text-indigo-600' : 'text-slate-400 hover:text-white']">
                        AR
                    </button>
                </div>
            </div>

            <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
                <!-- En-t√™te -->
                <div class="bg-indigo-600 p-6 text-center">
                    <div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-graduation-cap text-2xl text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-white">{{ t('app_title') }}</h1>
                    <p class="text-indigo-200 text-sm mt-1">{{ t('app_subtitle') }}</p>
                    <p class="text-indigo-300 text-xs mt-0.5 font-medium">{{ t('sgc_meaning') }}</p>
                </div>

                <!-- Contenu -->
                <div class="p-5 space-y-3">
                    <!-- Bouton Ouvrir avec File Picker -->
                    <button @click="openFilePicker" :disabled="!isLicenseValid"
                        :class="['w-full flex items-center p-4 rounded-xl border transition group', !isLicenseValid ? 'bg-slate-100 opacity-50 cursor-not-allowed' : 'bg-slate-50 hover:bg-slate-100 border-slate-200']">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ms-3"
                            :class="!isLicenseValid ? 'bg-slate-200' : 'bg-indigo-100 group-hover:bg-indigo-600'">
                            <i class="fas fa-folder-open"
                                :class="!isLicenseValid ? 'text-slate-400' : 'text-indigo-600 group-hover:text-white transition'"></i>
                        </div>
                        <div class="text-start">
                            <div class="font-semibold text-slate-800 text-sm">{{ t('btn_open_file') }}</div>
                            <div class="text-xs text-slate-500">{{ t('btn_explorer') }}</div>
                        </div>
                    </button>

                    <!-- Bouton Scanner Dossier -->
                    <button @click="scanFolder" :disabled="!isLicenseValid"
                        :class="['w-full flex items-center p-4 rounded-xl border transition group', !isLicenseValid ? 'bg-slate-100 opacity-50 cursor-not-allowed' : 'bg-slate-50 hover:bg-slate-100 border-slate-200']">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ms-3"
                            :class="!isLicenseValid ? 'bg-slate-200' : 'bg-purple-100 group-hover:bg-purple-600'">
                            <i class="fas fa-folder"
                                :class="!isLicenseValid ? 'text-slate-400' : 'text-purple-600 group-hover:text-white transition'"></i>
                        </div>
                        <div class="text-start">
                            <div class="font-semibold text-slate-800 text-sm">{{ t('btn_scan_folder') }}</div>
                            <div class="text-xs text-slate-500">{{ t('btn_detect_json') }}</div>
                        </div>
                    </button>

                    <!-- Bouton Nouveau -->
                    <button @click="createNewSpace" :disabled="!isLicenseValid"
                        :class="['w-full flex items-center p-4 rounded-xl border transition group', !isLicenseValid ? 'bg-slate-100 opacity-50 cursor-not-allowed' : 'bg-slate-50 hover:bg-slate-100 border-slate-200']">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ms-3"
                            :class="!isLicenseValid ? 'bg-slate-200' : 'bg-emerald-100 group-hover:bg-emerald-600'">
                            <i class="fas fa-plus"
                                :class="!isLicenseValid ? 'text-slate-400' : 'text-emerald-600 group-hover:text-white transition'"></i>
                        </div>
                        <div class="text-start">
                            <div class="font-semibold text-slate-800 text-sm">{{ t('btn_new_space') }}</div>
                            <div class="text-xs text-slate-500">{{ t('btn_create_json') }}</div>
                        </div>
                    </button>

                    <!-- Zone Drag & Drop -->
                    <div id="dropZone"
                        :class="['drop-zone rounded-xl p-4 text-center', !isLicenseValid ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer']"
                        :style="!isLicenseValid ? 'pointer-events: none;' : ''" @dragover.prevent="handleDragOver"
                        @dragleave.prevent="handleDragLeave" @drop.prevent="handleDrop"
                        @click="isLicenseValid && document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt text-2xl text-slate-300 mb-2"></i>
                        <p class="text-xs text-slate-500">{{ t('drop_zone_text') }}</p>
                        <p class="text-xs text-slate-400 mt-1">{{ t('drop_zone_click') }}</p>
                    </div>

                    <!-- Input fichier cach√© (fallback) -->
                    <input type="file" id="fileInput" @change="loadFileFromInput" accept=".json" class="hidden"
                        :disabled="!isLicenseValid">

                    <!-- Message s√©curit√© -->
                    <div class="p-2.5 bg-amber-50 border border-amber-200 rounded-xl">
                        <p class="text-xs text-amber-700">
                            <i class="fas fa-info-circle ms-1"></i>
                            {{ t('security_note') }}
                        </p>
                    </div>

                    <!-- Gestion des Espaces (Mode Natif) -->
                    <div class="mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                {{ isNative ? 'Mes Espaces (Dossier sgc-teachertrack)' : 'Fichiers R√©cents' }}
                            </h3>
                            <button v-if="isNative" @click="loadSpaces" class="text-xs text-indigo-600">
                                <i class="fas fa-sync"></i> Actualiser
                            </button>
                        </div>

                        <div v-if="isNative">
                            <div v-if="availableSpaces.length > 0" class="space-y-2">
                                <button v-for="space in availableSpaces" :key="space.path"
                                    @click="openSpace(space.name)"
                                    class="w-full flex items-center p-3 bg-white border border-slate-200 rounded-lg hover:border-indigo-500 transition">
                                    <div
                                        class="w-10 h-10 bg-indigo-50 rounded text-indigo-600 flex items-center justify-center">
                                        <i class="fas fa-database"></i>
                                    </div>
                                    <div class="ms-3 text-start flex-1">
                                        <div class="font-semibold text-slate-700">{{ space.name }}</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-slate-300"></i>
                                </button>
                            </div>
                            <div v-else class="p-6 text-center border-dashed border-2 border-slate-200 rounded-xl mb-3">
                                <p class="text-slate-400">Aucun espace trouv√©.</p>
                            </div>

                            <button @click="createNewSpace"
                                class="w-full mt-2 py-3 bg-indigo-600 text-white rounded-xl font-medium shadow hover:bg-indigo-700 transition">
                                <i class="fas fa-plus-circle me-2"></i> Cr√©er un nouvel espace
                            </button>
                        </div>

                        <div v-else>
                            <!-- Mode Web : Afficher les fichiers r√©cents -->
                            <div v-if="recentFiles.length > 0" class="space-y-1.5 max-h-40 overflow-y-auto">
                                <button v-for="file in recentFiles" :key="file.path" @click="openRecentFile(file)"
                                    class="w-full flex items-center p-2.5 bg-slate-50 hover:bg-slate-100 rounded-lg transition text-start">
                                    <i class="fas fa-file-code text-indigo-400 ms-2"></i>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-slate-700 text-sm truncate">{{ file.name }}</div>
                                        <div class="text-xs text-slate-400">{{ formatDate(file.date) }}</div>
                                    </div>
                                    <button @click.stop="removeFromRecent(file.path)"
                                        class="text-slate-400 hover:text-red-500 p-1">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </button>
                            </div>

                            <!-- Message quand aucun fichier r√©cent (mode web) -->
                            <div v-if="recentFiles.length === 0"
                                class="p-3 bg-slate-50 rounded-xl border border-slate-200 text-center">
                                <i class="fas fa-history text-slate-300 text-xl mb-1"></i>
                                <p class="text-xs text-slate-500">{{ t('no_recent') }}</p>
                                <p class="text-xs text-slate-400 mt-0.5">{{ t('recent_appear') }}</p>
                            </div>

                            <button v-if="recentFiles.length === 0" @click="clearRecentFiles"
                                class="hidden text-xs text-slate-400 hover:text-slate-600">{{ t('clear_recent')
                                }}</button>
                        </div>
                    </div>
                </div>

                <!-- Pied de page -->
                <div class="bg-slate-50 px-4 py-3 border-t border-slate-100">
                    <p class="text-xs text-slate-400 text-center">
                        <i class="fas fa-shield-alt ms-1"></i>
                        {{ t('local_note') }}
                    </p>
                </div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- APPLICATION PRINCIPALE -->
        <!-- ==================== -->
        <div v-if="isDataLoaded" class="flex flex-col min-h-screen">

            <!-- En-t√™te -->
            <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
                <div class="px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <h1 class="text-lg font-semibold text-slate-800">
                            <i class="fas fa-graduation-cap text-indigo-600 ms-2"></i>
                            {{ t('app_title') }}
                        </h1>
                        <span v-if="fileName" class="text-sm text-slate-500 bg-slate-100 px-2 py-1 rounded">{{ fileName
                            }}</span>
                        <!-- Indicateur de sauvegarde -->
                        <span v-if="hasUnsavedChanges"
                            class="text-sm px-3 py-1 rounded-full bg-red-100 text-red-700 flex items-center gap-1.5 font-medium">
                            <i class="fas fa-circle text-xs animate-pulse"></i>
                            {{ t('unsaved') }}
                        </span>
                        <span v-else-if="fileName"
                            class="text-sm px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 flex items-center gap-1.5 font-medium">
                            <i class="fas fa-check-circle"></i>
                            {{ t('saved') }}
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- S√©lecteur de langue -->
                        <div class="flex items-center bg-slate-100 rounded-lg p-1">
                            <button @click="setLang('fr')"
                                :class="['px-2 py-1 rounded text-xs font-medium transition', currentLang === 'fr' ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700']">
                                FR
                            </button>
                            <button @click="setLang('en')"
                                :class="['px-2 py-1 rounded text-xs font-medium transition', currentLang === 'en' ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700']">
                                EN
                            </button>
                            <button @click="setLang('ar')"
                                :class="['px-2 py-1 rounded text-xs font-medium transition', currentLang === 'ar' ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700']">
                                AR
                            </button>
                        </div>
                        <button @click="closeFile"
                            class="px-3 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">
                            <i class="fas fa-times ms-1"></i>
                            <span class="hidden sm:inline">{{ t('close') }}</span>
                        </button>
                        <button @click="saveFile"
                            class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center">
                            <i class="fas fa-save ms-1"></i>
                            <span class="hidden sm:inline">{{ t('save') }}</span>
                        </button>
                    </div>
                </div>

                <!-- Navigation par onglets -->
                <div class="px-4 flex gap-1 overflow-x-auto border-t border-slate-100 pb-2">
                    <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                        :class="['px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap',
                                 currentTab === tab.id ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-100']">
                        <i :class="tab.icon + ' ms-2'"></i>
                        <span class="hidden md:inline">{{ tab.name }}</span>
                    </button>

                    <!-- S√©lecteur de classe avec bouton d'ajout (visible si classes existent) -->
                    <div v-if="db.classes.length > 0" class="ms-auto flex items-center gap-2">
                        <button @click="showClassModal = true"
                            class="p-2 bg-indigo-100 text-indigo-600 rounded-lg hover:bg-indigo-200 transition"
                            :title="t('add_class')">
                            <i class="fas fa-plus"></i>
                        </button>
                        <select v-model="currentClassIndex"
                            class="px-3 py-2 bg-slate-100 border-0 rounded-lg text-sm font-medium text-slate-700 focus:ring-2 focus:ring-indigo-500">
                            <option v-for="(cls, idx) in db.classes" :key="idx" :value="idx">{{ cls.name }}</option>
                        </select>

                        <!-- S√©lecteur de mati√®res -->
                        <div class="flex items-center gap-1">
                            <i class="fas fa-book text-slate-400 text-xs"></i>
                            <select v-model="currentSubjectId"
                                class="px-2 py-1 bg-purple-50 border border-purple-200 rounded text-sm text-purple-700 focus:ring-2 focus:ring-purple-500">
                                <option :value="null">{{ t('all_subjects') }}</option>
                                <option v-for="subject in currentSubjects" :key="subject.id" :value="subject.id">
                                    {{ subject.name }}
                                </option>
                            </select>
                            <button @click="showSubjectModal = true"
                                class="p-1 bg-purple-100 text-purple-600 rounded hover:bg-purple-200 transition"
                                :title="t('manage_subjects')">
                                <i class="fas fa-cog text-xs"></i>
                            </button>
                        </div>

                        <!-- Affichage √©tablissement li√© √† la classe -->
                        <div v-if="getCurrentClassEstablishment"
                            class="flex items-center gap-1 px-2 py-1 bg-emerald-50 border border-emerald-200 rounded text-xs text-emerald-700 cursor-pointer hover:bg-emerald-100 transition"
                            @click="showClassEstablishmentModal = true" :title="t('click_to_change_establishment')">
                            <i class="fas fa-building text-[10px]"></i>
                            <span class="truncate max-w-[120px]">{{ getCurrentClassEstablishment.name }}</span>
                            <i class="fas fa-pencil-alt text-[10px] ml-1 opacity-60"></i>
                        </div>

                        <!-- Gestion des trimestres -->
                        <button @click="resetTrimesterForm(); showTrimesterModal = true"
                            class="px-2 py-1 bg-amber-100 text-amber-700 rounded hover:bg-amber-200 transition text-xs"
                            :title="t('manage_trimesters')">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                    </div>

                    <!-- Bouton ajouter classe si aucune classe n'existe -->
                    <div v-else class="ms-auto">
                        <button @click="showClassModal = true"
                            class="px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition text-sm font-medium">
                            <i class="fas fa-plus ms-1"></i> {{ t('add_class') }}
                        </button>
                    </div>
                </div>
            </header>

            <!-- Contenu principal -->
            <main class="flex-1 p-4 overflow-auto">

                <!-- CARTE INFORMATIONS ENSEIGNANT (toujours visible) -->
                <div class="bg-blue-950 rounded-xl shadow-lg p-4 mb-4 border border-blue-800"
                    style="background: linear-gradient(to right, #0f172a, #1e3a5f, #0f172a);">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-14 h-14 bg-blue-900/80 rounded-full flex items-center justify-center ring-2 ring-blue-700/50 shadow-lg">
                                <i class="fas fa-user-tie text-2xl text-blue-200"></i>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-white drop-shadow-md">
                                    <span class="opacity-80">{{ t('teacher_label') }}</span> {{ db.teacherInfo.lastname
                                    }} {{ db.teacherInfo.firstname }}
                                </div>
                                <div class="flex items-center gap-4 mt-1">
                                    <span v-if="db.teacherInfo.teacherType"
                                        class="flex items-center gap-1 text-blue-300 text-sm font-semibold drop-shadow">
                                        <i class="fas fa-briefcase text-xs text-blue-400"></i>
                                        <span v-if="db.teacherInfo.teacherType === 'professor'">{{ t('type_professor')
                                            }}</span>
                                        <span v-else-if="db.teacherInfo.teacherType === 'institute'">{{
                                            t('type_institute') }}</span>
                                        <span v-else-if="db.teacherInfo.teacherType === 'supeur'">{{ t('type_supeur')
                                            }}</span>
                                        <span v-else class="text-blue-300">{{ db.teacherInfo.teacherType }}</span>
                                    </span>
                                    <span v-if="db.teacherInfo.schoolYear"
                                        class="flex items-center gap-1 text-blue-300 text-sm font-semibold drop-shadow">
                                        <i class="fas fa-calendar-alt text-xs text-blue-400"></i>
                                        <span>{{ db.teacherInfo.schoolYear }}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-3 text-sm">
                            <div v-if="getEstablishmentName(db.teacherInfo.mainEstablishment)"
                                class="flex items-center gap-2 bg-blue-900/80 px-3 py-1.5 rounded-lg text-white border border-blue-700 shadow">
                                <i class="fas fa-building text-blue-300"></i>
                                <span class="font-medium">{{ getEstablishmentName(db.teacherInfo.mainEstablishment)
                                    }}</span>
                            </div>
                            <div v-if="db.teacherInfo.phone"
                                class="flex items-center gap-2 bg-blue-900/80 px-3 py-1.5 rounded-lg text-white border border-blue-700 shadow">
                                <i class="fas fa-phone text-blue-300"></i>
                                <span>{{ db.teacherInfo.phone }}</span>
                            </div>
                            <div v-if="db.teacherInfo.email"
                                class="flex items-center gap-2 bg-blue-900/80 px-3 py-1.5 rounded-lg text-white border border-blue-700 shadow">
                                <i class="fas fa-envelope text-blue-300"></i>
                                <span class="truncate max-w-[150px]">{{ db.teacherInfo.email }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AUCUNE CLASSE - Banni√®re d'information (non bloquante) -->
                <div v-if="db.classes.length === 0" class="w-full mb-4">
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-3 text-center">
                        <div class="flex items-center justify-center gap-2 mb-2">
                            <i class="fas fa-school text-amber-500"></i>
                            <h2 class="text-base font-semibold text-amber-800">{{ t('welcome_title') }}</h2>
                        </div>
                        <p class="text-amber-700 text-sm mb-2">{{ t('create_first_class_hint') }}</p>
                        <button @click="showClassModal = true"
                            class="px-4 py-1.5 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition text-sm">
                            <i class="fas fa-plus ms-1"></i> {{ t('create_class') }}
                        </button>
                    </div>
                </div>

                <!-- VUE DES √âL√àVES -->
                <div v-if="currentTab === 'students'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div
                            class="p-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <div class="flex-1">
                                <h2 class="text-lg font-semibold text-slate-800">
                                    {{ t('students_title') }} <span class="text-sm font-normal text-slate-500">({{
                                        filteredStudents.length }})</span>
                                </h2>
                            </div>
                            <div class="flex flex-wrap gap-2 items-center">
                                <!-- Champ de recherche -->
                                <div class="relative">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input v-model="searchQuery" type="text" :placeholder="t('search_placeholder')"
                                        class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none w-48">
                                </div>
                                <label
                                    class="px-3 py-2 bg-emerald-50 text-emerald-700 rounded-lg cursor-pointer hover:bg-emerald-100 transition text-sm font-medium">
                                    <i class="fas fa-file-excel ms-1"></i> {{ t('import') }}
                                    <input type="file" @change="importExcel" accept=".xlsx" class="hidden">
                                </label>
                                <button @click="showStudentModal = true"
                                    class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                                    <i class="fas fa-plus ms-1"></i> {{ t('add') }}
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50">
                                    <tr class="text-start text-sm font-medium text-slate-600">
                                        <th class="px-4 py-3">{{ t('lastname') }}</th>
                                        <th class="px-4 py-3">{{ t('firstname') }}</th>
                                        <th class="px-4 py-3 text-center">{{ t('average') }}</th>
                                        <th class="px-4 py-3 text-end">{{ t('actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr v-for="(student, idx) in filteredStudents" :key="student.id"
                                        class="hover:bg-slate-50 transition">
                                        <td class="px-4 py-3 font-medium text-slate-800">{{ student.lastname }}</td>
                                        <td class="px-4 py-3 text-slate-600">{{ student.firstname }}</td>
                                        <td class="px-4 py-3 text-center">
                                            <span :class="getGradeBadgeClass(student)">{{ calculateAverage(student)
                                                }}</span>
                                        </td>
                                        <td class="px-4 py-3 text-end">
                                            <button @click="deleteStudent(idx)"
                                                class="text-slate-400 hover:text-red-500 transition p-1">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="filteredStudents.length === 0">
                                        <td colspan="4" class="px-4 py-8 text-center text-slate-400">
                                            {{ searchQuery ? t('no_results') : t('no_students') }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VUE LISTE DES √âL√àVES -->
                <div v-if="currentTab === 'eleves'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div
                            class="p-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <h2 class="text-lg font-semibold text-slate-800">
                                {{ t('students_list_title') }}
                                <span v-if="currentSubject" class="text-sm font-normal text-purple-600 ms-2">
                                    <i class="fas fa-book ms-1"></i>{{ currentSubject.name }}
                                </span>
                                <span v-else-if="currentSubjectId === null"
                                    class="text-sm font-normal text-slate-400 ms-2">
                                    <i class="fas fa-layer-group ms-1"></i>{{ t('all_subjects') }}
                                </span>
                            </h2>
                            <div class="flex flex-wrap gap-2 items-center">
                                <!-- Champ de recherche -->
                                <div class="relative">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input v-model="searchQuery" type="text" :placeholder="t('search_placeholder')"
                                        class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none w-48">
                                </div>
                                <label
                                    class="px-3 py-2 bg-emerald-50 text-emerald-700 rounded-lg cursor-pointer hover:bg-emerald-100 transition text-sm font-medium">
                                    <i class="fas fa-file-excel ms-1"></i> {{ t('import') }}
                                    <input type="file" @change="importExcel" accept=".xlsx" class="hidden">
                                </label>
                                <button @click="showStudentModal = true"
                                    class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                                    <i class="fas fa-plus ms-1"></i> {{ t('add') }}
                                </button>
                            </div>
                        </div>

                        <div v-if="filteredStudents.length === 0" class="p-8 text-center text-slate-400">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <p>{{ searchQuery ? t('no_results') : t('no_students_list_msg') }}</p>
                            <p v-if="!searchQuery" class="text-sm mt-2">{{ t('add_student_hint') }}</p>
                        </div>

                        <div v-else class="grid gap-3 p-4 sm:grid-cols-2 lg:grid-cols-3">
                            <div v-for="student in filteredStudents" :key="student.id"
                                @click="selectedStudent = student"
                                class="border border-slate-200 rounded-xl p-4 hover:shadow-md hover:border-indigo-300 cursor-pointer transition bg-white">
                                <div class="flex items-start gap-3">
                                    <div
                                        class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                                        <img v-if="student.photo" :src="student.photo"
                                            class="w-full h-full object-cover">
                                        <i v-else class="fas fa-user text-indigo-600"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-semibold text-slate-800 truncate">{{ student.lastname }} {{
                                            student.firstname }}</div>
                                        <div v-if="student.student_id" class="text-xs text-slate-400 mt-0.5">{{
                                            student.student_id }}</div>
                                        <div class="text-sm text-slate-500 mt-1">
                                            <span class="inline-flex items-center gap-1">
                                                <i class="fas fa-chart-line text-xs"></i>
                                                {{ t('mean') }} {{ calculateAverage(student) }}
                                            </span>
                                        </div>
                                        <div class="text-xs text-slate-400 mt-1 flex flex-wrap gap-2">
                                            <span class="text-red-500">{{ getAttendanceCount(student.id, 'absent') }} {{
                                                t('absent_count') }}</span>
                                            <span class="text-amber-500">{{ getAttendanceCount(student.id, 'late') }} {{
                                                t('late_count') }}</span>
                                            <span class="text-yellow-500">{{ getAppreciationCount(student.id, 'star') }}
                                                <i class="fas fa-star text-[10px]"></i></span>
                                            <span class="text-red-500">{{ getAppreciationCount(student.id, 'stop') }} <i
                                                    class="fas fa-stop text-[10px]"></i></span>
                                        </div>
                                        <div v-if="student.phone" class="text-xs text-slate-400 mt-1">
                                            <i class="fas fa-phone text-xs mr-1"></i>{{ student.phone }}
                                        </div>
                                        <div v-if="student.birthdate" class="text-xs text-slate-400 mt-1">
                                            <i class="fas fa-calendar text-xs mr-1"></i>{{
                                            formatDateFull(student.birthdate) }}
                                        </div>
                                        <div v-if="student.parent_father_email" class="text-xs text-slate-400 mt-1">
                                            <i class="fas fa-envelope text-xs mr-1 text-blue-400"></i>
                                            <a :href="'mailto:' + student.parent_father_email"
                                                class="text-blue-600 hover:text-blue-800" @click.stop>{{
                                                student.parent_father_email }}</a>
                                        </div>
                                        <div v-if="student.parent_mother_email" class="text-xs text-slate-400 mt-1">
                                            <i class="fas fa-envelope text-xs mr-1 text-purple-400"></i>
                                            <a :href="'mailto:' + student.parent_mother_email"
                                                class="text-purple-600 hover:text-purple-800" @click.stop>{{
                                                student.parent_mother_email }}</a>
                                        </div>
                                    </div>
                                    <div class="text-slate-400 hover:text-slate-600">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE DES NOTES -->
                <div v-if="currentTab === 'grades'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div
                            class="p-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <h2 class="text-lg font-semibold text-slate-800">
                                {{ t('grades_title') }}
                                <span v-if="currentSubject" class="text-sm font-normal text-purple-600 ms-2">
                                    <i class="fas fa-book ms-1"></i>{{ currentSubject.name }}
                                </span>
                                <span v-else-if="currentSubjectId === null"
                                    class="text-sm font-normal text-slate-400 ms-2">
                                    <i class="fas fa-layer-group ms-1"></i>{{ t('all_subjects') }}
                                </span>
                            </h2>
                            <div class="flex flex-wrap gap-2 items-center">
                                <!-- Champ de recherche -->
                                <div class="relative">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input v-model="searchQuery" type="text" :placeholder="t('search_placeholder')"
                                        class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none w-48">
                                </div>
                                <button @click="showExamModal = true"
                                    class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                                    <i class="fas fa-plus ms-1"></i> {{ t('new_evaluation') }}
                                </button>
                                <button @click="showExportModal = true"
                                    class="px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition text-sm font-medium">
                                    <i class="fas fa-file-excel ms-1"></i> {{ t('export_grades') }}
                                </button>
                            </div>
                        </div>

                        <!-- Tableau des notes -->
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50">
                                    <!-- Ligne 1: En-t√™tes des trimestres -->
                                    <tr class="text-left text-sm font-medium text-slate-600 border-b border-slate-200">
                                        <th class="px-4 py-3 sticky left-0 bg-slate-50 min-w-[150px] z-20 shadow-sm">{{
                                            t('tab_students') }}</th>
                                        <template v-for="(tri, triIdx) in currentTrimesters" :key="tri.id">
                                            <template v-if="getTrimesterExamCount(tri.id) > 0">
                                                <th :colspan="getTrimesterExamCount(tri.id) + 2"
                                                    class="px-4 py-3 text-center bg-amber-50 text-amber-800 border-x border-amber-100 min-w-[180px]">
                                                    {{ tri.name }}
                                                </th>
                                            </template>
                                        </template>
                                        <!-- Colonne pour nouvelle √©valuation -->
                                        <th
                                            class="px-4 py-3 text-center min-w-[100px] bg-indigo-50 border-l border-indigo-100 z-10">
                                            <button @click="showExamModal = true"
                                                class="flex items-center justify-center gap-1 text-indigo-600 hover:text-indigo-800 transition"
                                                :title="t('new_evaluation')">
                                                <i class="fas fa-plus-circle"></i>
                                                <span class="text-sm">{{ t('new_evaluation') }}</span>
                                            </button>
                                        </th>
                                        <!-- Moyenne annuelle -->
                                        <th v-if="currentTrimesters.length > 0"
                                            class="px-4 py-3 text-center min-w-[80px] bg-emerald-50 text-emerald-700 border-l border-emerald-100">
                                            {{ t('annual_average') }}
                                        </th>
                                    </tr>
                                    <!-- Ligne 2: En-t√™tes des examens -->
                                    <tr class="text-left text-xs font-medium text-slate-500 border-b border-slate-200">
                                        <th class="px-4 py-2 sticky left-0 bg-slate-50 min-w-[150px] z-10"></th>
                                        <template v-for="(tri, triIdx) in currentTrimesters" :key="tri.id">
                                            <template
                                                v-for="(exam, examIdx) in filteredExams.filter(e => e.trimesterId === tri.id)"
                                                :key="exam.id">
                                                <th class="px-2 py-2 text-center min-w-[80px]">
                                                    <span class="text-indigo-700">{{ exam.name }}</span>
                                                    <span class="text-slate-400 block text-[10px]">{{ exam.max }}/{{
                                                        exam.coeff }}</span>
                                                </th>
                                            </template>
                                            <!-- En-t√™te moyenne trimestre -->
                                            <template v-if="getTrimesterExamCount(tri.id) > 0">
                                                <th
                                                    class="px-2 py-2 text-center min-w-[60px] bg-amber-50 text-amber-700">
                                                    {{ t('trimester_average') }}
                                                </th>
                                                <th
                                                    class="px-2 py-2 text-center min-w-[40px] bg-amber-50 text-amber-700">
                                                    <i class="fas fa-comment-alt text-xs"></i>
                                                </th>
                                            </template>
                                        </template>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <template v-for="student in filteredStudents" :key="student.id">
                                        <tr class="hover:bg-slate-50">
                                            <!-- Info √©l√®ve -->
                                            <td
                                                class="px-4 py-3 font-medium text-slate-800 sticky left-0 bg-white z-10 border-r border-slate-100">
                                                <div class="flex items-center gap-2">
                                                    <div
                                                        class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                                                        <img v-if="student.photo" :src="student.photo"
                                                            class="w-full h-full object-cover">
                                                        <i v-else class="fas fa-user text-indigo-600 text-xs"></i>
                                                    </div>
                                                    <div>
                                                        <div>{{ student.lastname }} {{ student.firstname }}</div>
                                                        <div v-if="student.student_id" class="text-xs text-slate-400">{{
                                                            student.student_id }}</div>
                                                    </div>
                                                </div>
                                            </td>

                                            <!-- √âvaluations et donn√©es par trimestre -->
                                            <template v-for="(tri, triIdx) in currentTrimesters" :key="tri.id">
                                                <!-- √âvaluations du trimestre -->
                                                <td v-for="exam in filteredExams.filter(e => e.trimesterId === tri.id)"
                                                    :key="exam.id" class="px-0">
                                                    <input type="number" v-model.number="student.grades[exam.id]"
                                                        class="w-full px-4 py-3 text-center bg-transparent focus:bg-indigo-50 focus:outline-none"
                                                        placeholder="-" :min="0" :max="exam.max">
                                                </td>
                                                <!-- Moyenne du trimestre -->
                                                <template v-if="getTrimesterExamCount(tri.id) > 0">
                                                    <td class="px-2 py-3 text-center bg-amber-50 min-w-[60px]">
                                                        <span
                                                            :class="['font-bold text-sm', 
                                                        calculateTrimesterAverage(student, tri.id) !== '-' && parseFloat(calculateTrimesterAverage(student, tri.id)) < 5 ? 'text-red-600' : 'text-amber-700']">
                                                            {{ calculateTrimesterAverage(student, tri.id) }}
                                                        </span>
                                                    </td>
                                                    <!-- Observation du trimestre -->
                                                    <td class="px-2 py-3 text-center bg-amber-50 min-w-[40px]">
                                                        <button @click="promptObservation(student, tri)"
                                                            class="p-1.5 rounded hover:bg-amber-200 transition"
                                                            :title="t('trimester_observation')">
                                                            <i
                                                                :class="['fas text-sm', getTrimesterObservation(student, tri.id) ? 'fa-comment text-amber-600' : 'fa-comment-alt text-slate-300']"></i>
                                                        </button>
                                                    </td>
                                                </template>
                                            </template>

                                            <!-- Colonne vide pour le bouton "Nouvelle √©valuation" -->
                                            <td class="bg-indigo-50/30 border-l border-indigo-100"></td>

                                            <!-- Moyenne annuelle -->
                                            <td v-if="currentTrimesters.length > 0"
                                                class="px-4 py-3 text-center font-bold text-emerald-700 bg-emerald-50 min-w-[80px] text-sm">
                                                {{ calculateAnnualAverage(student) }}
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <!-- Message si aucun √©l√®ve -->
                        <div v-if="currentClass.students.length === 0" class="p-8 text-center text-slate-400">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <p>{{ t('no_students') }}</p>
                        </div>
                    </div>
                </div>

                <!-- VUE DES PR√âSENCES -->
                <div v-if="currentTab === 'attendance'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div
                            class="p-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <h2 class="text-lg font-semibold text-slate-800">{{ t('attendance_title') }}</h2>
                            <div class="flex flex-wrap gap-2 items-center">
                                <!-- Champ de recherche -->
                                <div class="relative">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input v-model="searchQuery" type="text" :placeholder="t('search_placeholder')"
                                        class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none w-48">
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-calendar-alt text-slate-400"></i>
                                    <input type="date" v-model="attendanceDate"
                                        class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                        </div>

                        <div v-if="filteredStudents.length === 0" class="p-8 text-center text-slate-400">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <p>{{ searchQuery ? t('no_results') : t('no_students') }}</p>
                        </div>

                        <div v-else class="p-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                            <div v-for="student in filteredStudents" :key="student.id"
                                class="border border-slate-200 rounded-xl p-4 hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="font-semibold text-slate-800">{{ student.lastname }}</div>
                                        <div class="text-sm text-slate-500">{{ student.firstname }}</div>
                                    </div>
                                    <div class="text-xs text-slate-400 text-end">
                                        <div class="text-red-500">{{ getAttendanceCount(student.id, 'absent') }} {{
                                            t('absent_count') }}</div>
                                        <div class="text-amber-500">{{ getAttendanceCount(student.id, 'late') }} {{
                                            t('late_count') }}</div>
                                        <div class="text-yellow-500">{{ getAppreciationCount(student.id, 'star') }} <i
                                                class="fas fa-star text-[10px]"></i></div>
                                        <div class="text-red-500">{{ getAppreciationCount(student.id, 'stop') }} <i
                                                class="fas fa-stop text-[10px]"></i></div>
                                    </div>
                                </div>
                                <!-- Boutons de pr√©sence -->
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <button @click="setAttendance(student.id, 'present')"
                                        :style="getAttendanceStyle(student.id, 'present')"
                                        :class="['py-2 rounded-lg text-sm font-medium transition border', getAttendanceClass(student.id, 'present')]">
                                        {{ t('present') }}
                                    </button>
                                    <button @click="setAttendance(student.id, 'absent')"
                                        :style="getAttendanceStyle(student.id, 'absent')"
                                        :class="['py-2 rounded-lg text-sm font-medium transition border', getAttendanceClass(student.id, 'absent')]">
                                        {{ t('absent') }}
                                    </button>
                                    <button @click="setAttendance(student.id, 'late')"
                                        :style="getAttendanceStyle(student.id, 'late')"
                                        :class="['py-2 rounded-lg text-sm font-medium transition border', getAttendanceClass(student.id, 'late')]">
                                        {{ t('late_word') }}
                                    </button>
                                </div>
                                <!-- Boutons d'appr√©ciation -->
                                <div class="grid grid-cols-2 gap-2">
                                    <button @click="setAppreciation(student.id, 'star')"
                                        :class="['py-2 rounded-lg text-sm font-medium transition border', getAppreciationClass(student.id, 'star')]"
                                        :title="t('good_appreciation')">
                                        <i :class="['fas', getAppreciationIcon(student.id, 'star')]"></i>
                                    </button>
                                    <button @click="setAppreciation(student.id, 'stop')"
                                        :class="['py-2 rounded-lg text-sm font-medium transition border', getAppreciationClass(student.id, 'stop')]"
                                        :title="t('bad_appreciation')">
                                        <i :class="['fas', getAppreciationIcon(student.id, 'stop')]"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE DU PLANNING -->
                <div v-if="currentTab === 'planner'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div
                            class="p-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <h2 class="text-lg font-semibold text-slate-800">{{ t('planning_title') }}</h2>
                            <div class="flex flex-wrap gap-2 items-center">
                                <!-- Champ de recherche pour le planning -->
                                <div class="relative">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input v-model="searchPlanningQuery" type="text" :placeholder="t('search_planning')"
                                        class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none w-48">
                                </div>
                                <button @click="addPlannerItem"
                                    class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                                    <i class="fas fa-plus ms-1"></i> {{ t('add_planning') }}
                                </button>
                            </div>
                        </div>

                        <div class="p-4 space-y-3">
                            <div v-for="(item, idx) in filteredPlanner" :key="idx"
                                class="border border-slate-200 border-l-4 border-l-indigo-500 rounded-lg p-4 hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-1">
                                        <input type="date" v-model="item.date"
                                            class="text-sm font-medium text-indigo-600 bg-indigo-50 px-2 py-1 rounded ms-2">
                                        <input type="text" v-model="item.title"
                                            :placeholder="t('planning_session_title')"
                                            class="font-semibold text-slate-800 border-b border-transparent hover:border-slate-300 focus:border-indigo-500 focus:outline-none">
                                    </div>
                                    <button @click="deletePlannerItem(idx)"
                                        class="text-slate-400 hover:text-red-500 transition">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                <textarea v-model="item.content" :placeholder="t('planning_content')"
                                    class="w-full mt-2 p-3 bg-slate-50 rounded-lg text-sm text-slate-600 resize-none focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-200"
                                    rows="2"></textarea>
                            </div>

                            <div v-if="filteredPlanner.length === 0" class="p-8 text-center text-slate-400">
                                {{ searchPlanningQuery ? t('no_results') : t('no_planning') }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE INFORMATIONS ENSEIGNANT -->
                <div v-if="currentTab === 'teacher'">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div class="p-4 border-b border-slate-200">
                            <h2 class="text-lg font-semibold text-slate-800">{{ t('teacher_info_title') }}</h2>
                        </div>

                        <div class="p-6 space-y-6">
                            <!-- Informations personnelles -->
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('teacher_name')
                                        }}</label>
                                    <input v-model="db.teacherInfo.lastname" type="text" disabled
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-slate-50 cursor-not-allowed"
                                        :placeholder="t('teacher_name')">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{
                                        t('teacher_firstname') }}</label>
                                    <input v-model="db.teacherInfo.firstname" type="text" disabled
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-slate-50 cursor-not-allowed"
                                        :placeholder="t('teacher_firstname')">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('phone')
                                        }}</label>
                                    <input v-model="db.teacherInfo.phone" type="tel"
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                        :placeholder="t('phone')">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('email')
                                        }}</label>
                                    <input v-model="db.teacherInfo.email" type="email"
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                        :placeholder="t('email')">
                                </div>
                            </div>

                            <!-- Ann√©e scolaire et type d'enseignant -->
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('school_year')
                                        }}</label>
                                    <input v-model="db.teacherInfo.schoolYear" type="text"
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                        :placeholder="t('school_year')">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('teacher_type')
                                        }}</label>
                                    <select v-model="db.teacherInfo.teacherType"
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">{{ t('select_establishment') }}</option>
                                        <option value="professor">{{ t('type_professor') }}</option>
                                        <option value="institute">{{ t('type_institute') }}</option>
                                        <option value="supeur">{{ t('type_supeur') }}</option>
                                        <option value="other">{{ t('type_other') }}</option>
                                    </select>
                                </div>
                            </div>

                            <!-- √âtablissement principal -->
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('main_establishment')
                                    }}</label>
                                <select v-model="db.teacherInfo.mainEstablishment"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">{{ t('select_establishment') }}</option>
                                    <option v-for="est in db.establishments" :key="est.id" :value="est.id">
                                        {{ est.name }}
                                    </option>
                                </select>
                            </div>

                            <!-- Champs officiels pour les documents -->
                            <div>
                                <h3 class="text-sm font-medium text-slate-600 mb-3">{{ t('official_header_fields') }}
                                </h3>
                                <div class="grid gap-4 sm:grid-cols-3">
                                    <div>
                                        <input v-model="db.teacherInfo.fieldRepublic" type="text"
                                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            :placeholder="t('field_republic')">
                                    </div>
                                    <div>
                                        <input v-model="db.teacherInfo.fieldMinistry" type="text"
                                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            :placeholder="t('field_ministry')">
                                    </div>
                                    <div>
                                        <input v-model="db.teacherInfo.fieldDirectorate" type="text"
                                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            :placeholder="t('field_directorate') + ' ...'">
                                    </div>
                                </div>
                            </div>

                            <!-- √âtablissements secondaires -->
                            <div>
                                <div class="flex items-center justify-between mb-3">
                                    <label class="block text-sm font-medium text-slate-600">{{
                                        t('secondary_establishments') }}</label>
                                    <button @click="showEstablishmentModal = true"
                                        class="px-3 py-1 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition">
                                        <i class="fas fa-plus ms-1"></i>{{ t('add_establishment') }}
                                    </button>
                                </div>

                                <div v-if="db.establishments.length === 0"
                                    class="p-6 text-center text-slate-400 bg-slate-50 rounded-lg">
                                    <i class="fas fa-building text-3xl mb-2"></i>
                                    <p>{{ t('no_establishments') }}</p>
                                </div>

                                <div v-else class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                                    <div v-for="est in db.establishments" :key="est.id"
                                        class="p-4 border border-slate-200 rounded-lg hover:shadow-md transition">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <h4 class="font-medium text-slate-800">{{ est.name }}</h4>
                                                <p v-if="est.address" class="text-sm text-slate-500 mt-1">{{ est.address
                                                    }}</p>
                                                <p v-if="est.phone" class="text-sm text-slate-500">{{ est.phone }}</p>
                                                <!-- Classes li√©es -->
                                                <div v-if="getEstablishmentClasses(est).length > 0"
                                                    class="mt-2 flex flex-wrap gap-1">
                                                    <span v-for="(clsName, idx) in getEstablishmentClasses(est)"
                                                        :key="idx"
                                                        class="px-2 py-0.5 bg-indigo-50 text-indigo-700 text-xs rounded">
                                                        {{ clsName }}
                                                    </span>
                                                </div>
                                                <div v-else class="mt-2 text-xs text-slate-400">
                                                    {{ t('no_classes_linked') }}
                                                </div>
                                            </div>
                                            <div class="flex gap-1">
                                                <button @click="openEstablishmentModal(est)"
                                                    class="text-slate-400 hover:text-indigo-500 transition p-1"
                                                    :title="t('edit_establishment')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button @click="deleteEstablishment(est.id)"
                                                    class="text-slate-400 hover:text-red-500 transition p-1"
                                                    :title="t('delete_establishment')">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE DES RAPPORTS -->
                <div v-if="currentTab === 'reports'">
                    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                        <!-- Statistiques -->
                        <div
                            class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 sm:col-span-2 lg:col-span-2">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('stats_title') }}</h3>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div class="p-4 bg-indigo-50 rounded-xl">
                                    <div class="text-3xl font-bold text-indigo-600">{{ classStats.average }}</div>
                                    <div class="text-sm text-indigo-600 font-medium">{{ t('class_average') }}</div>
                                </div>
                                <div class="p-4 bg-emerald-50 rounded-xl">
                                    <div class="text-3xl font-bold text-emerald-600">{{ classStats.highest }}</div>
                                    <div class="text-sm text-emerald-600 font-medium">{{ t('highest_grade') }}</div>
                                </div>
                                <div class="p-4 bg-red-50 rounded-xl">
                                    <div class="text-3xl font-bold text-red-600">{{ classStats.lowest }}</div>
                                    <div class="text-sm text-red-600 font-medium">{{ t('lowest_grade') }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Export -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('export') }}</h3>
                            <button @click="exportToExcel"
                                class="w-full py-3 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition flex items-center justify-center">
                                <i class="fas fa-file-excel ms-2"></i>
                                {{ t('export_excel') }}
                            </button>
                            <p class="text-xs text-slate-500 mt-3 text-center">
                                {{ t('export_desc') }}
                            </p>
                        </div>
                    </div>
                </div>

            </main>
        </div>

        <!-- ==================== -->
        <!-- MODALS -->
        <!-- ==================== -->

        <!-- Modal √âl√®ve -->
        <div v-if="showStudentModal"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 mx-auto relative">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('modal_new_student') }}</h3>
                <div class="space-y-3">
                    <!-- Photo upload -->
                    <div class="flex flex-col items-center mb-4">
                        <div
                            class="w-20 h-20 rounded-full overflow-hidden bg-slate-100 border-2 border-slate-200 flex items-center justify-center">
                            <img v-if="newStudent.photo" :src="newStudent.photo" class="w-full h-full object-cover">
                            <i v-else class="fas fa-user text-3xl text-slate-300"></i>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <label
                                class="px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg cursor-pointer hover:bg-indigo-100 transition text-xs font-medium">
                                <i class="fas fa-camera ms-1"></i> {{ t('upload_photo') }}
                                <input type="file" @change="handlePhotoUpload" accept="image/*" class="hidden">
                            </label>
                            <button v-if="newStudent.photo" @click="removeStudentPhoto"
                                class="px-3 py-1.5 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition text-xs font-medium">
                                <i class="fas fa-times ms-1"></i> {{ t('remove_photo') }}
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">{{ t('photo_hint') }}</p>
                    </div>

                    <!-- ID field -->
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('student_id') }}</label>
                        <input v-model="newStudent.student_id" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('student_id')">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('lastname') }}</label>
                            <input v-model="newStudent.lastname" type="text"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('lastname')" autofocus>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('firstname') }}</label>
                            <input v-model="newStudent.firstname" type="text"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('firstname')">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('birthdate') }}</label>
                        <input v-model="newStudent.birthdate" type="date"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('address') }}</label>
                        <textarea v-model="newStudent.address"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 resize-none"
                            :placeholder="t('address')" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('phone_parents') }}</label>
                        <input v-model="newStudent.phone" type="tel"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            placeholder="01 23 45 67 89">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('father') }}</label>
                            <input v-model="newStudent.parent_father" type="text"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('father')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('father_email') }}</label>
                            <input v-model="newStudent.parent_father_email" type="email"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('father_email')">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('mother') }}</label>
                            <input v-model="newStudent.parent_mother" type="text"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('mother')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('mother_email') }}</label>
                            <input v-model="newStudent.parent_mother_email" type="email"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('mother_email')">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showStudentModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button @click="addStudent"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">{{
                        t('add_student_btn') }}</button>
                </div>
            </div>
        </div>

        <!-- Modal √âvaluation -->
        <div v-if="showExamModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('modal_new_evaluation') }}</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('evaluation_subject')
                            }}</label>
                        <select v-model="newExam.subjectId"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option v-for="subject in currentSubjects" :key="subject.id" :value="subject.id">
                                {{ subject.name }}
                            </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('evaluation_trimester')
                            }}</label>
                        <select v-model="newExam.trimesterId"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option v-for="tri in currentTrimesters" :key="tri.id" :value="tri.id">
                                {{ tri.name }}
                            </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('evaluation_name') }}</label>
                        <input v-model="newExam.name" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('evaluation_name')" autofocus>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('evaluation_max')
                                }}</label>
                            <input v-model.number="newExam.max" type="number"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('evaluation_coeff')
                                }}</label>
                            <input v-model.number="newExam.coeff" type="number"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="1" min="1">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showExamModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button @click="addExam"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">{{
                        t('create') }}</button>
                </div>
            </div>
        </div>

        <!-- Modal Gestion des Mati√®res -->
        <div v-if="showSubjectModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('modal_subjects') }}</h3>
                <p class="text-sm text-slate-500 mb-4">{{ t('class_subject') }} {{ currentClass?.name }}</p>

                <!-- Liste des mati√®res -->
                <div class="max-h-48 overflow-y-auto space-y-2 mb-4">
                    <div v-for="subject in currentSubjects" :key="subject.id"
                        class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <span class="font-medium text-slate-700">{{ subject.name }}</span>
                        <button @click="deleteSubject(subject.id)"
                            class="text-slate-400 hover:text-red-500 transition p-1" :title="t('delete_subject')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div v-if="currentSubjects.length === 0" class="p-4 text-center text-slate-400">
                        <i class="fas fa-book text-2xl mb-2"></i>
                        <p>{{ t('no_subject') }}</p>
                    </div>
                </div>

                <!-- Ajouter une mati√®re -->
                <div class="flex gap-2">
                    <input v-model="newSubjectName" type="text" @keyup.enter="addSubject"
                        class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        :placeholder="t('add_subject')">
                    <button @click="addSubject"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showSubjectModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('close')
                        }}</button>
                </div>
            </div>
        </div>

        <!-- Modal Gestion des Trimestres -->
        <div v-if="showTrimesterModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('manage_trimesters') }}</h3>
                <p class="text-sm text-slate-500 mb-4">{{ t('class_subject') }} {{ currentClass?.name }}</p>

                <!-- Liste des trimestres -->
                <div class="max-h-48 overflow-y-auto space-y-2 mb-4">
                    <div v-for="tri in currentTrimesters" :key="tri.id"
                        class="flex items-center justify-between p-3 bg-amber-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium text-slate-700">{{ tri.name }}</span>
                            <div v-if="tri.observation" class="text-xs text-slate-500 mt-1 truncate">{{ tri.observation
                                }}</div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button @click="editTrimester(tri)"
                                class="p-1.5 text-slate-400 hover:text-indigo-600 transition rounded"
                                :title="t('edit')">
                                <i class="fas fa-edit text-xs"></i>
                            </button>
                            <button @click="deleteTrimester(tri.id)"
                                class="p-1.5 text-slate-400 hover:text-red-500 transition rounded" :title="t('delete')">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div v-if="currentTrimesters.length === 0" class="p-4 text-center text-slate-400">
                        <i class="fas fa-calendar-alt text-2xl mb-2"></i>
                        <p>{{ t('no_trimesters') }}</p>
                    </div>
                </div>

                <!-- Formulaire -->
                <div class="border-t border-slate-200 pt-4">
                    <input v-model="newTrimester.name" type="text"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 mb-3"
                        :placeholder="t('trimester_name')">
                    <textarea v-model="newTrimester.observation"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 mb-3"
                        :placeholder="t('trimester_observation_hint')" rows="2"></textarea>
                </div>

                <div class="flex justify-end gap-2 mt-4">
                    <button @click="showTrimesterModal = false; resetTrimesterForm()"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button @click="saveTrimester"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">{{
                        t('save') }}</button>
                </div>
            </div>
        </div>

        <!-- Modal D√©tails √âl√®ve -->
        <div v-if="selectedStudent"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl mx-auto relative">

                <!-- En-t√™te -->
                <div class="sticky top-0 bg-white border-b border-slate-200 p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center overflow-hidden">
                            <img v-if="selectedStudent.photo" :src="selectedStudent.photo"
                                class="w-full h-full object-cover">
                            <i v-else class="fas fa-user text-indigo-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-slate-800">{{ selectedStudent.lastname }} {{
                                selectedStudent.firstname }}</h3>
                            <p v-if="selectedStudent.student_id" class="text-sm text-slate-500">{{
                                selectedStudent.student_id }}</p>
                            <p v-else class="text-sm text-slate-500">{{ currentClass?.name }}</p>
                        </div>
                    </div>
                    <button @click="selectedStudent = null" class="text-slate-400 hover:text-slate-600 p-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Contenu -->
                <div class="p-4 space-y-4 overflow-y-auto" style="max-height: 70vh;">

                    <!-- Photo et ID -->
                    <div class="flex items-center gap-4 bg-slate-50 rounded-lg p-4">
                        <div
                            class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center overflow-hidden flex-shrink-0">
                            <img v-if="selectedStudent.photo" :src="selectedStudent.photo"
                                class="w-full h-full object-cover">
                            <i v-else class="fas fa-user text-2xl text-indigo-600"></i>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('student_id') }}</label>
                            <input v-model="selectedStudent.student_id" type="text"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                :placeholder="t('student_id')">
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <label
                                class="px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg cursor-pointer hover:bg-indigo-100 transition text-xs font-medium">
                                <i class="fas fa-camera ms-1"></i> {{ t('upload_photo') }}
                                <input type="file" @change="(e) => handleDetailPhotoUpload(e, selectedStudent)"
                                    accept="image/*" class="hidden">
                            </label>
                            <button v-if="selectedStudent.photo" @click="removeDetailPhoto(selectedStudent)"
                                class="px-3 py-1.5 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition text-xs font-medium">
                                <i class="fas fa-times ms-1"></i> {{ t('remove_photo') }}
                            </button>
                        </div>
                    </div>

                    <!-- Informations personnelles -->
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2 text-sm">{{ t('personal_info') }}</h4>
                        <div class="bg-slate-50 rounded-lg p-3 space-y-2">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-slate-500">{{ t('lastname') }}</label>
                                    <input v-model="selectedStudent.lastname" type="text"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">{{ t('firstname') }}</label>
                                    <input v-model="selectedStudent.firstname" type="text"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500">{{ t('birthdate') }}</label>
                                <input v-model="selectedStudent.birthdate" type="date"
                                    class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="text-xs text-slate-500">Adresse</label>
                                <textarea v-model="selectedStudent.address"
                                    class="w-full px-2 py-1 border rounded text-sm resize-none" rows="2"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-slate-500">T√©l√©phone</label>
                                    <input v-model="selectedStudent.phone" type="tel"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">P√®re / Tuteur</label>
                                    <input v-model="selectedStudent.parent_father" type="text"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">Email P√®re</label>
                                    <input v-model="selectedStudent.parent_father_email" type="email"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">M√®re / Tutrice</label>
                                    <input v-model="selectedStudent.parent_mother" type="text"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">Email M√®re</label>
                                    <input v-model="selectedStudent.parent_mother_email" type="email"
                                        class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques -->
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-indigo-50 rounded-lg p-2 text-center">
                            <div class="text-lg font-bold text-indigo-600">{{ calculateAverage(selectedStudent) }}</div>
                            <div class="text-xs text-indigo-500">Moyenne</div>
                        </div>
                        <div class="bg-emerald-50 rounded-lg p-2 text-center">
                            <div class="text-lg font-bold text-emerald-600">{{ getStudentSubjectAverage(selectedStudent)
                                }}</div>
                            <div class="text-xs text-emerald-500">Mati√®re</div>
                        </div>
                        <div class="bg-amber-50 rounded-lg p-2 text-center">
                            <div class="text-lg font-bold text-amber-500">{{ getAttendanceCount(selectedStudent,
                                'absent') }}</div>
                            <div class="text-xs text-amber-500">Absences</div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2 text-sm">Notes</h4>
                        <div class="bg-slate-50 rounded-lg overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-100">
                                    <tr class="text-left text-xs">
                                        <th class="px-2 py-1">√âvaluation</th>
                                        <th class="px-2 py-1">Note</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="exam in filteredExams" :key="exam.id" class="border-t">
                                        <td class="px-2 py-1">{{ exam.name }}</td>
                                        <td class="px-2 py-1">
                                            <span :class="getStudentGradeClass(selectedStudent, exam)">
                                                {{ selectedStudent.grades[exam.id] || '-' }}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr v-if="filteredExams.length === 0">
                                        <td colspan="2" class="px-2 py-2 text-center text-slate-400 text-xs">
                                            Aucune √©valuation
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pr√©sences -->
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2 text-sm">Pr√©sences</h4>
                        <div class="flex flex-wrap gap-1">
                            <span v-for="(status, date) in getStudentAttendance(selectedStudent)" :key="date" :class="['px-2 py-0.5 rounded text-xs', 
                                   status === 'present' ? 'bg-emerald-100 text-emerald-700' :
                                   status === 'absent' ? 'bg-red-100 text-red-700' :
                                   'bg-amber-100 text-amber-700']">
                                {{ formatDateShort(date) }}
                            </span>
                            <span v-if="Object.keys(getStudentAttendance(selectedStudent)).length === 0"
                                class="text-xs text-slate-400">
                                Aucune
                            </span>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal Nouvelle Classe -->
        <div v-if="showClassModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('modal_new_class') }}</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('class_name_label') }}</label>
                        <input v-model="newClassName" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('class_name')" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('subject_label') }}</label>
                        <input v-model="newClassSubject" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('subject_name')">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('establishment_label')
                            }}</label>
                        <div class="flex gap-2">
                            <select v-model="newClassEstablishmentId"
                                class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">{{ t('no_establishment') }}</option>
                                <option v-for="est in db.establishments" :key="est.id" :value="est.id">
                                    {{ est.name }}
                                </option>
                            </select>
                            <button
                                @click="pendingClassIdForEstablishment = Date.now().toString(); openEstablishmentModal(null, true)"
                                class="px-3 py-2 bg-emerald-100 text-emerald-700 rounded-lg hover:bg-emerald-200 transition"
                                :title="t('add_establishment')">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showClassModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button @click="addClass"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">{{
                        t('create') }}</button>
                </div>
            </div>
        </div>

        <!-- Modal Scanner Dossier -->
        <div v-if="showScanModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('modal_scan') }}</h3>
                <p class="text-sm text-slate-500 mb-4">{{ t('select_file') }}</p>

                <div class="max-h-64 overflow-y-auto space-y-2">
                    <button v-for="file in scannedFiles" :key="file.name" @click="openScannedFile(file)"
                        class="w-full flex items-center p-3 bg-slate-50 hover:bg-indigo-50 rounded-lg transition text-start">
                        <i class="fas fa-file-code text-indigo-400 ms-3"></i>
                        <div class="flex-1">
                            <div class="font-medium text-slate-700">{{ file.name }}</div>
                            <div class="text-xs text-slate-400">{{ formatSize(file.size) }}</div>
                        </div>
                    </button>
                    <div v-if="scannedFiles.length === 0" class="p-4 text-center text-slate-400">
                        <i class="fas fa-folder-open text-3xl mb-2"></i>
                        <p>{{ t('no_json_found') }}</p>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showScanModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('close')
                        }}</button>
                </div>
            </div>
        </div>

        <!-- Modal Nouvel √âtablissement -->
        <div v-if="showEstablishmentModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">
                    {{ editingEstablishment ? t('edit_establishment') : t('add_establishment') }}
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('establishment_name')
                            }}</label>
                        <input v-model="newEstablishment.name" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('establishment_name')" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('establishment_address')
                            }}</label>
                        <input v-model="newEstablishment.address" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('establishment_address')">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('establishment_phone')
                            }}</label>
                        <input v-model="newEstablishment.phone" type="tel"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            :placeholder="t('establishment_phone')">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">{{ t('establishment_classes')
                            }}</label>
                        <div class="max-h-32 overflow-y-auto border border-slate-300 rounded-lg p-2 space-y-1">
                            <label v-for="cls in db.classes" :key="cls.id"
                                class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-50 p-1 rounded">
                                <input type="checkbox" :value="cls.id" v-model="newEstablishment.classes"
                                    class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="text-slate-700">{{ cls.name }}</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button @click="resetEstablishmentForm(); showEstablishmentModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button @click="saveEstablishment"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">{{
                        t('save_establishment') }}</button>
                </div>
            </div>
        </div>

        <!-- Modal √âtablissement de la Classe -->
        <div v-if="showClassEstablishmentModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('select_class_establishment') }}</h3>
                <p class="text-sm text-slate-500 mb-4">
                    {{ t('class') }}: <span class="font-medium text-slate-700">{{ currentClass?.name }}</span>
                </p>
                <div class="space-y-2 max-h-48 overflow-y-auto border border-slate-200 rounded-lg p-2">
                    <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-50 p-2 rounded">
                        <input type="radio" :value="''" :checked="!getCurrentClassEstablishment"
                            @change="assignClassToEstablishment('')"
                            class="border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-slate-700">{{ t('no_establishment') }}</span>
                    </label>
                    <label v-for="est in db.establishments" :key="est.id"
                        class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-50 p-2 rounded">
                        <input type="radio" :value="est.id" :checked="getCurrentClassEstablishment?.id === est.id"
                            @change="assignClassToEstablishment(est.id)"
                            class="border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-slate-700">{{ est.name }}</span>
                    </label>
                    <div v-if="db.establishments.length === 0" class="p-4 text-center text-slate-400 text-sm">
                        {{ t('no_establishments') }}
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showClassEstablishmentModal = false"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        {{ t('close') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Export Trimestre -->
        <div v-if="showExportModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ t('export_grades_title') }}</h3>

                <div v-if="currentClass?.students?.length === 0" class="p-4 text-center text-slate-400">
                    <i class="fas fa-users text-3xl mb-2"></i>
                    <p>{{ t('no_students_to_export') }}</p>
                </div>

                <div v-else class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">{{ t('select_trimester_export')
                            }}</label>
                        <select v-model="selectedTrimesterExport"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">{{ t('all_trimesters') }}</option>
                            <option v-for="tri in currentTrimesters" :key="tri.id" :value="tri.id">
                                {{ tri.name }}
                            </option>
                        </select>
                    </div>

                    <div v-if="selectedTrimesterExport && getTrimesterExamCount(selectedTrimesterExport) === 0"
                        class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-700">
                        <i class="fas fa-exclamation-triangle ms-1"></i>
                        {{ t('no_exams_for_trimester') }}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">{{ t('select_layout_format')
                            }}</label>
                        <select v-model="exportFormat"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="rtl">{{ t('format_arabic') }}</option>
                            <option value="ltr">{{ t('format_western') }}</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button @click="showExportModal = false"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">{{ t('cancel')
                        }}</button>
                    <button v-if="currentClass?.students?.length > 0" @click="exportGradesToExcel"
                        class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                        <i class="fas fa-file-excel ms-1"></i> {{ t('export_button') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Licence (affich√© au-dessus de tout) -->
        <div v-if="showLicenseModal" style="display: flex;"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4">
                    <i class="fas fa-key text-indigo-600 ms-1"></i> {{ t('license_activation_title') }}
                </h3>

                <div v-if="isLicenseValid" class="text-center py-4">
                    <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-check text-3xl text-emerald-600"></i>
                    </div>
                    <p class="font-bold text-emerald-700 text-lg mb-2">{{ t('license_active') }}</p>
                    <p class="text-slate-600">{{ t('license_owner_label') }}: <span class="font-semibold">{{
                            licenseOwner }}</span></p>
                    <button @click="cancelLicenseModal"
                        class="mt-4 px-6 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition">
                        {{ t('close') }}
                    </button>
                </div>

                <div v-else class="space-y-4">
                    <p class="text-sm text-slate-600">{{ t('license_enter_key') }}</p>

                    <!-- Option 1: Saisie manuelle -->
                    <div class="border border-slate-200 rounded-xl p-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-keyboard ms-1 text-indigo-500"></i> {{ t('license_manual_entry') || 'Entrer la cle manuellement' }}
                        </label>
                        <input v-model="licenseInput" type="text" :placeholder="t('license_placeholder')"
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg text-center font-mono text-sm tracking-wider uppercase focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" />
                        <button @click="verifyLicense(licenseInput)" :disabled="licenseInput.length < 16"
                            class="w-full mt-3 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-unlock ms-1"></i> {{ t('license_activate') }}
                        </button>
                    </div>

                    <!-- Separateur OU -->
                    <div class="flex items-center gap-3">
                        <div class="flex-1 border-t border-slate-200"></div>
                        <span class="text-sm text-slate-400 font-medium">{{ t('or') || 'OU' }}</span>
                        <div class="flex-1 border-t border-slate-200"></div>
                    </div>

                    <!-- Option 2: Selection fichier .txt -->
                    <div class="border border-slate-200 rounded-xl p-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-file-alt ms-1 text-purple-500"></i> {{ t('license_select_file') || 'Selectionner le fichier licence (.txt)' }}
                        </label>
                        <label
                            class="block w-full px-4 py-3 bg-purple-50 border-2 border-dashed border-purple-200 rounded-lg text-center cursor-pointer hover:border-purple-400 hover:bg-purple-100 transition">
                            <i class="fas fa-folder-open text-purple-500 ms-2"></i>
                            <span class="text-purple-700 font-medium">{{ t('browse') || 'Parcourir...' }}</span>
                            <input type="file" @change="importLicenseFile" accept=".txt" class="hidden">
                        </label>
                        <p class="text-xs text-slate-400 mt-2 text-center">{{ t('license_file_hint') || 'Le fichier licence vous a ete envoye par email' }}</p>
                    </div>

                    <div v-if="licenseError" class="p-3 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-sm text-red-600"><i class="fas fa-exclamation-triangle ms-1"></i> {{ licenseError
                            }}</p>
                    </div>

                    <button @click="cancelLicenseModal"
                        class="w-full px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">
                        {{ t('cancel') }}
                    </button>

                    <div class="p-3 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-500 text-center">
                            <i class="fas fa-info-circle ms-1"></i> {{ t('license_get_key') }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts avec m√©canisme de secours (local ‚Üí CDN) -->
    <script>
        // Charger Vue.js avec secours
        loadScriptWithFallback('vue-js', 'vue.global.js', 'https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js', function () {
            console.log('‚úì Vue.js pr√™t, initialisation de l\'application...');
            initApp();
        });

        // Charger SheetJS avec secours
        loadScriptWithFallback('xlsx-js', 'xlsx.full.min.js', 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js');
    </script>

    <script>
        // Fonction principale d'initialisation (appel√©e apr√®s le chargement de Vue)
        function initApp() {
            // V√©rification que Vue est bien disponible
            if (typeof Vue === 'undefined') {
                document.body.innerHTML = '<div style="padding: 50px; text-align: center; color: red;"><h1>Erreur: Vue.js non charg√©</h1><p>V√©rifiez que vue.global.js existe dans le dossier.</p></div>';
                throw new Error('Vue.js non charg√©');
            }
            console.log('TeacherTrack - D√©marrage...');

            const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

            // ==================== INDEXEDDB HELPERS ====================
            const DB_NAME = 'TeacherTrackDB';
            const DB_VERSION = 1;
            const STORE_NAME = 'recentFiles';

            const initDB = () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'path' });
                        }
                    };
                });
            };

            const saveRecentToDB = async (files) => {
                try {
                    const db = await initDB();
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    store.clear();
                    files.forEach(f => {
                        // Stocker seulement les m√©tadonn√©es (pas le handle qui n'est pas clonable)
                        store.put({ path: f.path, name: f.name, date: f.date });
                    });
                    await tx.complete;
                } catch (e) { console.error('Erreur IndexedDB:', e); }
            };

            const loadRecentFromDB = async () => {
                try {
                    const db = await initDB();
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    return new Promise((resolve) => {
                        const request = store.getAll();
                        request.onsuccess = () => {
                            // Sort by date desc
                            const files = request.result.sort((a, b) => new Date(b.date) - new Date(a.date));
                            resolve(files.slice(0, 5)); // Max 5 files
                        };
                        request.onerror = () => resolve([]);
                    });
                } catch (e) { console.error('Erreur IndexedDB:', e); return []; }
            };

            const removeFromDB = async (path) => {
                try {
                    const db = await initDB();
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).delete(path);
                    await tx.complete;
                } catch (e) { console.error('Erreur IndexedDB:', e); }
            };

            const clearDB = async () => {
                try {
                    const db = await initDB();
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).clear();
                    await tx.complete;
                } catch (e) { console.error('Erreur IndexedDB:', e); }
            };

            // ==================== TRADUCTIONS ====================
            const translations = {
                fr: {
                    // Accueil
                    app_title: "TeacherTrack",
                    app_subtitle: "Gestion de classe simple et locale",
                    sgc_meaning: "SGC = Syst√®me de Gestion de Classe",
                    btn_open_file: "Ouvrir un fichier",
                    btn_explorer: "S√©lectionner via l'explorateur syst√®me",
                    btn_scan_folder: "Scanner un dossier",
                    btn_detect_json: "D√©tecter les fichiers .json pr√©sents",
                    btn_new_space: "Nouvel espace",
                    btn_create_json: "Cr√©er un nouveau fichier .json",
                    drop_zone_text: "Glissez-d√©posez un fichier .json ici",
                    drop_zone_click: "ou cliquez pour s√©lectionner",
                    security_note: "Note : Pour des raisons de s√©curit√©, les navigateurs ne peuvent pas acc√©der automatiquement au dossier du projet. Utilisez les boutons ci-dessus ou glissez-d√©posez un fichier.",
                    recent_files: "Fichiers r√©cents",
                    clear_recent: "Effacer",
                    no_recent: "Aucun fichier r√©cent",
                    recent_appear: "Vos fichiers r√©cents appara√Ætront ici",
                    local_note: "100% local - Aucune donn√©e n'est envoy√©e sur internet",

                    // Licence
                    license_title: "Licence",
                    license_placeholder: "XXXX-XXXX-XXXX-XXXX",
                    license_activate: "Activer la licence",
                    license_invalid: "Licence invalide",
                    license_expired: "Licence expir√©e",
                    license_wrong_user: "Cette licence appartient √† un autre utilisateur",
                    license_success: "Licence activ√©e avec succ√®s",
                    license_owner: "Propri√©taire",
                    license_get: "Obtenez votre cl√© aupr√®s de votre revendeur",
                    license_active: "LICENCE PRO",
                    license_not_activated: "VERSION NON ACTIV√âE",
                    license_activation_title: "Activation Licence",
                    license_owner_label: "Propri√©taire",
                    license_enter_key: "Entrez votre cl√© de licence pour activer l'application.",
                    license_get_key: "Obtenez votre cl√© aupr√®s de votre revendeur",

                    // En-t√™te
                    close: "Fermer",
                    save: "Sauvegarder",
                    unsaved: "Non sauvegard√©",
                    saved: "Sauvegard√©",

                    // Messages d'accueil
                    welcome_title: "Bienvenue dans TeacherTrack",
                    create_first_class_hint: "Cr√©ez votre premi√®re classe pour g√©rer vos √©l√®ves",
                    class_name: "Nom de la classe (ex: 3√®me B)",
                    subject_name: "Mati√®re (ex: Math√©matiques)",
                    create_class: "Cr√©er ma premi√®re classe",
                    main_subject: "Mati√®re principale",

                    // Onglets
                    tab_students: "√âl√®ves",
                    tab_list: "Liste √âl√®ves",
                    tab_grades: "Notes",
                    tab_attendance: "Pr√©sences",
                    tab_planning: "Planning",
                    tab_reports: "Rapports",

                    // Page √âl√®ves
                    students_title: "√âl√®ves",
                    students_count: "√âl√®ves",
                    import: "Importer depuis Excel",
                    import_students: "Importer √©l√®ves",
                    add: "Ajouter",
                    lastname: "Nom",
                    firstname: "Pr√©nom",
                    average: "Moyenne",
                    actions: "Actions",
                    delete: "Supprimer",
                    no_students: "Aucun √©l√®ve. Cliquez sur \"Ajouter\" pour en cr√©er un.",

                    // Page Liste √âl√®ves
                    students_list_title: "Liste des √âl√®ves",
                    all_subjects: "Toutes les mati√®res",
                    phone: "T√©l√©phone",
                    absent: "A",
                    late: "R",
                    no_students_list: "Aucun √©l√®ve dans cette classe",
                    add_student_list: "Cliquez sur \"Ajouter\" pour cr√©er un √©l√®ve",
                    tab_teacher: "Mes Infos",
                    tab_teacher_icon: "fas fa-user-tie",

                    // Page Notes
                    grades_title: "Carnet de Notes",
                    new_evaluation: "Nouvelle √âvaluation",
                    no_evaluations: "Aucune √©valuation pour cette mati√®re",
                    create_eval: "Cr√©ez une √©valuation ou s√©lectionnez \"Toutes\" pour voir toutes les mati√®res",
                    evaluation_name: "Nom",
                    evaluation_subject: "Mati√®re",
                    evaluation_trimester: "Trimestre/P√©riode",
                    evaluation_max: "Note sur",
                    evaluation_coeff: "Coefficient",

                    // Page Pr√©sences
                    attendance_title: "Pr√©sences",
                    present: "Pr√©sent",
                    absent: "Absent",
                    late_word: "Retard",
                    good_appreciation: "Appr√©ciation positive",
                    bad_appreciation: "Appr√©ciation n√©gative",

                    // Page Planning
                    planning_title: "Planification",
                    add_planning: "Ajouter",
                    planning_session_title: "Titre de la s√©ance",
                    planning_content: "Contenu du cours, devoirs...",
                    no_planning: "Aucune s√©ance planifi√©e. Cliquez sur \"Ajouter\" pour cr√©er une entr√©e.",

                    // Page Rapports
                    stats_title: "Statistiques de la classe",
                    class_average: "Moyenne classe",
                    highest_grade: "Meilleure note",
                    lowest_grade: "Note la plus basse",
                    export: "Export",
                    export_excel: "Exporter Excel",
                    export_desc: "T√©l√©charge un fichier .xlsx avec toutes les donn√©es",

                    // Modals
                    modal_new_student: "Nouvel √âl√®ve",
                    student_id: "Num√©ro d'identification",
                    photo: "Photo",
                    upload_photo: "T√©l√©charger une photo",
                    remove_photo: "Supprimer la photo",
                    photo_hint: "JPG, PNG (max 2Mo)",
                    birthdate: "Date de naissance",
                    address: "Adresse",
                    phone_parents: "T√©l√©phone (parents)",
                    father: "Nom du p√®re/tuteur",
                    father_email: "Email du p√®re",
                    mother: "Nom de la m√®re/tutrice",
                    mother_email: "Email de la m√®re",
                    cancel: "Annuler",
                    add_student_btn: "Ajouter",
                    search_placeholder: "Rechercher un √©l√®ve...",
                    search_planning: "Rechercher une s√©ance...",
                    no_results: "Aucun r√©sultat trouv√©",

                    modal_new_evaluation: "Nouvelle √âvaluation",
                    create: "Cr√©er",
                    evaluation_name: "Nom",
                    evaluation_subject: "Mati√®re",
                    evaluation_trimester: "Trimestre/P√©riode",
                    evaluation_max: "Note sur",
                    evaluation_coeff: "Coefficient",

                    modal_subjects: "Gestion des Mati√®res",
                    class_subject: "de la classe",
                    add_subject: "Nouvelle mati√®re",
                    no_subject: "Aucune mati√®re",
                    subject_list: "Liste des mati√®res",
                    delete_subject: "Supprimer",
                    close: "Fermer",

                    modal_student_details: "D√©tails √âl√®ve",
                    personal_info: "Informations personnelles",
                    subject_average: "Moyenne mati√®re",
                    absences: "Absences",
                    grades_by_eval: "Notes par √©valuation",
                    attendance_history: "Historique des pr√©sences",
                    no_evaluations_grade: "Aucune √©valuation pour cette mati√®re",
                    no_attendance: "Aucune pr√©sence enregistr√©e",
                    general_average: "Moyenne g√©n√©rale",

                    // Teacher Info
                    teacher_info_title: "Informations de l'Enseignant",
                    teacher_name: "Nom",
                    teacher_firstname: "Pr√©nom",
                    school_year: "Ann√©e Scolaire",
                    main_establishment: "√âtablissement Principal",
                    secondary_establishments: "√âtablissements Secondaires",
                    // Nouveaux champs pour l'ent√™te officiel
                    field_republic: "1- R√©publique Alg√©rienne D√©mocratique et Populaire",
                    field_ministry: "2- Minist√®re de l'√âducation Nationale",
                    field_directorate: "3- Direction de l'√âducation de la Wilaya de",
                    official_header_fields: "Champs officiels pour les documents (√©ditables)",
                    add_establishment: "Ajouter un √©tablissement",
                    establishment_name: "Nom de l'√©tablissement",
                    establishment_classes: "Classes li√©es",
                    subject_taught: "Mati√®re enseign√©e",
                    teacher_type: "Type d'enseignant",
                    type_professor: "Professeur",
                    type_institute: "Instituteur",
                    type_supeur: "Surveillant",
                    type_other: "Autre",
                    teacher_label: "Professeur",
                    phone: "T√©l√©phone",
                    email: "Email",
                    no_establishments: "Aucun √©tablissement ajout√©",
                    select_establishment: "S√©lectionner un √©tablissement",
                    establishment_address: "Adresse de l'√©tablissement",
                    establishment_phone: "T√©l√©phone de l'√©tablissement",
                    delete_establishment: "Supprimer l'√©tablissement",
                    confirm_delete_establishment: "√ätes-vous s√ªr de vouloir supprimer cet √©tablissement?",
                    edit_establishment: "Modifier l'√©tablissement",
                    save_establishment: "Enregistrer l'√©tablissement",
                    no_classes_linked: "Aucune classe li√©e",
                    select_class_establishment: "√âtablissement de la classe",
                    class: "Classe",
                    no_establishment: "Aucun √©tablissement",
                    click_to_change_establishment: "Cliquez pour changer l'√©tablissement",

                    modal_new_class: "Nouvelle Classe",
                    class_name_label: "Nom de la classe",
                    subject_label: "Mati√®re",
                    establishment_label: "√âtablissement (optionnel)",

                    // Trimestres
                    manage_trimesters: "Gestion des Trimestres",
                    no_trimesters: "Aucun trimestre d√©fini",
                    trimester_name: "Nom du trimestre (ex: Trimestre 1)",
                    trimester_observation_hint: "Observation pour ce trimestre...",
                    trimester_observation: "Observation",
                    edit: "Modifier",
                    save: "Sauvegarder",
                    annual_average: "Moyenne Annuelle",
                    trimester_average: "Moyenne",

                    modal_scan: "Fichiers d√©tect√©s",
                    select_file: "S√©lectionnez un fichier TeacherTrack √† ouvrir :",
                    no_json_found: "Aucun fichier .json trouv√© dans ce dossier",

                    // Messages
                    confirm_delete_student: "Supprimer cet √©l√®ve?",
                    file_modified: "Le fichier a √©t√© modifi√© depuis la derni√®re lecture.",
                    confirm_close: "Fermer ce fichier?",
                    unsaved_changes: "Des modifications n'ont pas √©t√© sauvegard√©es.",
                    save_before_close: "Cliquez sur OK pour sauvegarder avant de fermer, ou Annuler pour fermer sans sauvegarder.",
                    close_without_save: "Fermer sans sauvegarder ?",
                    confirm_delete_subject: "Cette mati√®re contient √©valuation(s). Voulez-vous vraiment la supprimer ?",
                    exam_count: (count) => count === 1 ? `${count} √©valuation` : `${count} √©valuations`,
                    import_success: (count) => `${count} √©l√®ve(s) import√©(s)`,
                    error_file_format: "Format de fichier invalide",
                    error_opening: "Erreur lors de l'ouverture:",
                    browser_not_supported: "Votre navigateur ne supporte pas l'API File System Access. Utilisez Chrome, Edge ou Opera.",

                    // Details √©l√®ve
                    general_average: "Moyenne g√©n√©rale",

                    // Pr√©sences
                    attendance_date: "Date",

                    // Header
                    add_class: "Ajouter une classe",
                    all_subjects: "Toutes",
                    manage_subjects: "G√©rer les mati√®res",

                    // Students list
                    no_students_list_msg: "Aucun √©l√®ve dans cette classe",
                    add_student_hint: "Cliquez sur \"Ajouter\" pour cr√©er un √©l√®ve",
                    mean: "Moy:",
                    absent_count: "A",
                    late_count: "R",

                    // Export
                    export_grades: "Exporter les notes",
                    export_grades_title: "Exporter document de relev√© de notes",
                    select_trimester_export: "S√©lectionner le trimestre √† exporter",
                    export_button: "Exporter",
                    no_students_to_export: "Aucun √©l√®ve √† exporter",
                    all_trimesters: "Tous les trimestres",
                    no_exams_for_trimester: "Aucune √©valuation pour ce trimestre",
                    select_layout_format: "S√©lectionner le format de mise en page",
                    format_arabic: "Arabe (de droite √† gauche)",
                    format_western: "Occidental (de gauche √† droite)",

                    // Grades
                    exam: (exam) => `/${exam.max} ‚Ä¢ Coef ${exam.coeff}`,
                },
                ar: {
                    // Accueil
                    app_title: "TeacherTrack",
                    app_subtitle: "ÿ•ÿØÿßÿ±ÿ© ŸÅÿµŸàŸÑ ÿ®ÿ≥Ÿäÿ∑ÿ© ŸàŸÖÿ≠ŸÑŸäÿ©",
                    sgc_meaning: "ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ",
                    btn_open_file: "ŸÅÿ™ÿ≠ ŸÖŸÑŸÅ",
                    btn_explorer: "ÿ™ÿ≠ÿØŸäÿØ ÿπÿ®ÿ± ŸÖÿ≥ÿ™ŸÉÿ¥ŸÅ ÿßŸÑŸÜÿ∏ÿßŸÖ",
                    btn_scan_folder: "ŸÅÿ≠ÿµ ŸÖÿ¨ŸÑÿØ",
                    btn_detect_json: "ÿßŸÉÿ™ÿ¥ÿßŸÅ ŸÖŸÑŸÅÿßÿ™ .json ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©",
                    btn_new_space: "ŸÖÿ≥ÿßÿ≠ÿ© ÿ¨ÿØŸäÿØÿ©",
                    btn_create_json: "ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ .json ÿ¨ÿØŸäÿØ",
                    drop_zone_text: "ÿßÿ≥ÿ≠ÿ® Ÿàÿ£ŸÅŸÑÿ™ ŸÖŸÑŸÅ .json ŸáŸÜÿß",
                    drop_zone_click: "ÿ£Ÿà ÿßŸÜŸÇÿ± ŸÑŸÑÿ™ÿ≠ÿØŸäÿØ",
                    security_note: "ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ŸÑÿ£ÿ≥ÿ®ÿßÿ® ÿ£ŸÖŸÜŸäÿ©ÿå ŸÑÿß ŸäŸÖŸÉŸÜ ŸÑŸÑŸÖÿ™ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑŸàÿµŸàŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß ÿ•ŸÑŸâ ŸÖÿ¨ŸÑÿØ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ. ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿ£ÿπŸÑÿßŸá ÿ£Ÿà ÿßÿ≥ÿ≠ÿ® Ÿàÿ£ŸÅŸÑÿ™ ŸÖŸÑŸÅŸãÿß.",
                    recent_files: "ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©",
                    clear_recent: "ŸÖÿ≥ÿ≠",
                    no_recent: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ ÿ≠ÿØŸäÿ´ÿ©",
                    recent_appear: "ÿ≥ÿ™ÿ∏Ÿáÿ± ŸÖŸÑŸÅÿßÿ™ŸÉ ÿßŸÑÿ≠ÿØŸäÿ´ÿ© ŸáŸÜÿß",
                    local_note: "100Ÿ™ ŸÖÿ≠ŸÑŸä - ŸÑÿß Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ£Ÿä ÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™",

                    // Licence
                    license_title: "ÿßŸÑÿ™ÿ±ÿÆŸäÿµ",
                    license_placeholder: "XXXX-XXXX-XXXX-XXXX",
                    license_activate: "ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ",
                    license_invalid: "ÿ™ÿ±ÿÆŸäÿµ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠",
                    license_expired: "ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿ±ÿÆŸäÿµ",
                    license_wrong_user: "Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ±ÿÆŸäÿµ ŸäÿÆÿµ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¢ÿÆÿ±",
                    license_success: "ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ ÿ®ŸÜÿ¨ÿßÿ≠",
                    license_owner: "ÿßŸÑŸÖÿßŸÑŸÉ",
                    license_get: "ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ŸÖŸÜ ÿßŸÑÿ®ÿßÿ¶ÿπ",
                    license_active: "ÿ™ÿ±ÿÆŸäÿµ ŸÖÿ≠ÿ™ÿ±ŸÅ",
                    license_not_activated: "ÿßŸÑÿ•ÿµÿØÿßÿ± ÿ∫Ÿäÿ± ŸÖŸèŸÅÿπŸéŸëŸÑ",
                    license_activation_title: "ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ",
                    license_owner_label: "ÿßŸÑŸÖÿßŸÑŸÉ",
                    license_enter_key: "ÿ£ÿØÿÆŸÑ ŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ ŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ",
                    license_get_key: "ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ŸÖŸÜ ÿßŸÑÿ®ÿßÿ¶ÿπ",

                    // En-t√™te
                    close: "ÿ•ÿ∫ŸÑÿßŸÇ",
                    save: "ÿ≠ŸÅÿ∏",
                    unsaved: "ÿ∫Ÿäÿ± ŸÖÿ≠ŸÅŸàÿ∏",
                    saved: "ŸÖÿ≠ŸÅŸàÿ∏",

                    // Messages d'accueil
                    welcome_title: "ŸÖÿ±ÿ≠ÿ®Ÿãÿß ÿ®ŸÉŸÖ ŸÅŸä TeacherTrack",
                    create_first_class_hint: "ÿ£ŸÜÿ¥ÿ¶ ŸÅÿµŸÑŸÉ ÿßŸÑÿ£ŸàŸÑ ŸÑÿ•ÿØÿßÿ±ÿ© ÿ∑ŸÑÿßÿ®ŸÉ",
                    create_first_class: "ÿ£ŸÜÿ¥ÿ¶ ÿµŸÅŸÉ ÿßŸÑÿ£ŸàŸÑ ŸÑŸÑÿ®ÿØÿ°",
                    class_name: "ÿßÿ≥ŸÖ ÿßŸÑÿµŸÅ (ŸÖÿ´ÿßŸÑ: ÿßŸÑÿ´ÿßŸÑÿ´ ÿ®)",
                    subject_name: "ÿßŸÑŸÖÿßÿØÿ© (ŸÖÿ´ÿßŸÑ: ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™)",
                    create_class: "ÿ•ŸÜÿ¥ÿßÿ¶Ÿä ÿßŸÑÿ£ŸàŸÑ ÿµŸÅ",

                    // Onglets
                    tab_students: "ÿßŸÑÿ∑ŸÑÿßÿ®",
                    tab_list: "ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ŸÑÿßÿ®",
                    tab_grades: "ÿßŸÑÿØÿ±ÿ¨ÿßÿ™",
                    tab_attendance: "ÿßŸÑÿ≠ÿ∂Ÿàÿ±",
                    tab_planning: "ÿßŸÑÿ¨ÿØŸàŸÑ",
                    tab_reports: "ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±",

                    // Page √âl√®ves
                    students_title: "ÿßŸÑÿ∑ŸÑÿßÿ®",
                    students_count: "ÿ∑ŸÑÿßÿ®",
                    import: "ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜ ÿ•ŸÉÿ≥ŸÑ",
                    import_students: "ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ∑ŸÑÿßÿ®",
                    add: "ÿ•ÿ∂ÿßŸÅÿ©",
                    lastname: "ÿßŸÑÿßÿ≥ŸÖ",
                    firstname: "ÿßŸÑŸÑŸÇÿ®",
                    average: "ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑",
                    actions: "ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™",
                    delete: "ÿ≠ÿ∞ŸÅ",
                    no_students: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∑ŸÑÿßÿ®. ÿßŸÜŸÇÿ± ÿπŸÑŸâ \"ÿ•ÿ∂ÿßŸÅÿ©\" ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ∑ÿßŸÑÿ®.",

                    // Page Liste √âl√®ves
                    students_list_title: "ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ŸÑÿßÿ®",
                    all_subjects: "ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿßÿØ",
                    phone: "ÿßŸÑŸáÿßÿ™ŸÅ",
                    absent: "ÿ∫",
                    late: "ÿ™",
                    no_students_list: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∑ŸÑÿßÿ® ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿµŸÅ",
                    add_student_list: "ÿßŸÜŸÇÿ± ÿπŸÑŸâ \"ÿ•ÿ∂ÿßŸÅÿ©\" ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ∑ÿßŸÑÿ®",

                    // Page Notes
                    grades_title: "ÿ≥ÿ¨ŸÑ ÿßŸÑÿØÿ±ÿ¨ÿßÿ™",
                    new_evaluation: "ÿ™ŸÇŸäŸäŸÖ ÿ¨ÿØŸäÿØ",
                    no_evaluations: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÇŸäŸäŸÖÿßÿ™ ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿßÿØÿ©",
                    create_eval: "ÿ£ŸÜÿ¥ÿ¶ ÿ™ŸÇŸäŸäŸÖŸãÿß ÿ£Ÿà ÿ≠ÿØÿØ \"ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿßÿØ\" ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ¨ŸÖŸäÿπ",
                    evaluation_name: "ÿßŸÑÿßÿ≥ŸÖ",
                    evaluation_subject: "ÿßŸÑŸÖÿßÿØÿ©",
                    evaluation_trimester: "ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©",
                    evaluation_max: "ÿßŸÑÿØÿ±ÿ¨ÿ© ŸÖŸÜ",
                    evaluation_coeff: "ÿßŸÑŸÖÿπÿßŸÖŸÑ",

                    // Page Pr√©sences
                    attendance_title: "ÿßŸÑÿ≠ÿ∂Ÿàÿ±",
                    present: "ÿ≠ÿßÿ∂ÿ±",
                    absent: "ÿ∫ÿßÿ¶ÿ®",
                    late_word: "ŸÖÿ™ÿ£ÿÆÿ±",
                    good_appreciation: "ÿ™ŸÇÿØŸäÿ± ÿ¨ŸäÿØ",
                    bad_appreciation: "ÿ™ŸÇÿØŸäÿ± ÿ∂ÿπŸäŸÅ",

                    // Page Planning
                    planning_title: "ÿßŸÑÿ¨ÿØŸàŸÑ",
                    add_planning: "ÿ•ÿ∂ÿßŸÅÿ©",
                    planning_session_title: "ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ≠ÿµÿ©",
                    planning_content: "ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿØÿ±ÿ≥ÿå Ÿàÿßÿ¨ÿ®ÿßÿ™...",
                    no_planning: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≠ÿµÿµ ŸÖÿ¨ÿØŸàŸÑÿ©. ÿßŸÜŸÇÿ± ÿπŸÑŸâ \"ÿ•ÿ∂ÿßŸÅÿ©\" ŸÑÿ•ŸÜÿ¥ÿßÿ° ŸÖÿØÿÆŸÑÿ©.",

                    // Page Rapports
                    stats_title: "ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿµŸÅ",
                    class_average: "ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÅÿµŸÑ",
                    highest_grade: "ÿ£ÿπŸÑŸâ ÿØÿ±ÿ¨ÿ©",
                    lowest_grade: "ÿ£ÿØŸÜŸâ ÿØÿ±ÿ¨ÿ©",
                    export: "ÿ™ÿµÿØŸäÿ±",
                    export_excel: "ÿ™ÿµÿØŸäÿ± Excel",
                    export_desc: "ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ .xlsx ÿ®ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",

                    // Modals
                    modal_new_student: "ÿ∑ÿßŸÑÿ® ÿ¨ÿØŸäÿØ",
                    student_id: "ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ",
                    photo: "ÿßŸÑÿµŸàÿ±ÿ©",
                    upload_photo: "ÿ™ÿ≠ŸÖŸäŸÑ ÿµŸàÿ±ÿ©",
                    remove_photo: "ÿ≠ÿ∞ŸÅ ÿßŸÑÿµŸàÿ±ÿ©",
                    photo_hint: "JPG, PNG (ÿ®ÿ≠ÿØ ÿ£ŸÇÿµŸâ 2Mo)",
                    birthdate: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ",
                    address: "ÿßŸÑÿπŸÜŸàÿßŸÜ",
                    phone_parents: "Ÿáÿßÿ™ŸÅ ÿßŸÑÿ£ŸàŸÑŸäÿßÿ°",
                    father: "ÿßÿ≥ŸÖ ÿßŸÑÿ£ÿ®/ÿßŸÑŸàÿµŸä",
                    father_email: "ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑŸÑÿ£ÿ®",
                    mother: "ÿßÿ≥ŸÖ ÿßŸÑÿ£ŸÖ/ÿßŸÑŸàÿµŸäÿ©",
                    mother_email: "ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑŸÑÿ£ŸÖ",
                    cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
                    add_student_btn: "ÿ•ÿ∂ÿßŸÅÿ©",

                    modal_new_evaluation: "ÿ™ŸÇŸäŸäŸÖ ÿ¨ÿØŸäÿØ",
                    create: "ÿ•ŸÜÿ¥ÿßÿ°",
                    evaluation_name: "ÿßŸÑÿßÿ≥ŸÖ",
                    evaluation_subject: "ÿßŸÑŸÖÿßÿØÿ©",
                    evaluation_trimester: "ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©",
                    evaluation_max: "ÿßŸÑÿØÿ±ÿ¨ÿ© ŸÖŸÜ",
                    evaluation_coeff: "ÿßŸÑŸÖÿπÿßŸÖŸÑ",

                    modal_subjects: "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿßÿØ",
                    class_subject: "ÿßŸÑÿµŸÅ",
                    add_subject: "ŸÖÿßÿØÿ© ÿ¨ÿØŸäÿØÿ©",
                    no_subject: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿßÿØÿ©",
                    subject_list: "ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿßÿØ",
                    delete_subject: "ÿ≠ÿ∞ŸÅ",
                    close: "ÿ•ÿ∫ŸÑÿßŸÇ",

                    modal_student_details: "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ÿßŸÑÿ®",
                    personal_info: "ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ©",
                    subject_average: "ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿßÿØÿ©",
                    absences: "ÿßŸÑÿ∫Ÿäÿßÿ®ÿßÿ™",
                    grades_by_eval: "ÿßŸÑÿØÿ±ÿ¨ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ŸÇŸäŸäŸÖ",
                    attendance_history: "ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ±",
                    no_evaluations_grade: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÇŸäŸäŸÖÿßÿ™ ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿßÿØÿ©",
                    no_attendance: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≠ÿ∂Ÿàÿ± ŸÖÿ≥ÿ¨ŸÑ",
                    general_average: "ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿπÿßŸÖ",
                    search_placeholder: "ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ∑ÿßŸÑÿ®...",
                    search_planning: "ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ≠ÿµÿ©...",
                    no_results: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜÿ™ÿßÿ¶ÿ¨",
                    tab_teacher: "ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿä",

                    // Teacher Info
                    teacher_info_title: "ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÖ",
                    teacher_name: "ÿßŸÑŸÑŸÇÿ®",
                    teacher_firstname: "ÿßŸÑÿßÿ≥ŸÖ",
                    school_year: "ÿßŸÑÿ≥ŸÜÿ© ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©",
                    main_establishment: "ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
                    secondary_establishments: "ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿßÿ™ ÿßŸÑÿ´ÿßŸÜŸàŸäÿ©",
                    // Nouveaux champs pour l'ent√™te officiel
                    field_republic: "1- ÿßŸÑÿ¨ŸÖŸáŸàÿ±Ÿäÿ© ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±Ÿäÿ© ÿßŸÑÿØŸäŸÖŸÇÿ±ÿßÿ∑Ÿäÿ© ÿßŸÑÿ¥ÿπÿ®Ÿäÿ©",
                    field_ministry: "2- Ÿàÿ≤ÿßÿ±ÿ© ÿßŸÑÿ™ÿ±ÿ®Ÿäÿ© ÿßŸÑŸàÿ∑ŸÜŸäÿ©",
                    field_directorate: "3- ÿßŸÑŸÖÿØŸäÿ±Ÿäÿ© ÿßŸÑÿ™ÿ±ÿ®Ÿäÿ© ŸÑŸàŸÑÿßŸäÿ©",
                    official_header_fields: "ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ±ÿ≥ŸÖŸäÿ© ŸÑŸÑŸàÿ´ÿßÿ¶ŸÇ (ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿπÿØŸäŸÑ)",
                    add_establishment: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ§ÿ≥ÿ≥ÿ©",
                    establishment_name: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©",
                    establishment_classes: "ÿßŸÑÿµŸÅŸàŸÅ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©",
                    subject_taught: "ÿßŸÑŸÖÿßÿØÿ© ÿßŸÑŸÖŸèÿπŸÑŸéŸëŸÖÿ©",
                    teacher_type: "ŸÜŸàÿπ ÿßŸÑŸÖÿπŸÑŸÖ",
                    type_professor: "ÿ£ÿ≥ÿ™ÿßÿ∞",
                    type_institute: "ŸÖÿπŸÑŸÖ",
                    type_supeur: "ŸÖÿ¥ÿ±ŸÅ",
                    type_other: "ÿ¢ÿÆÿ±",
                    teacher_label: "ÿ£ÿ≥ÿ™ÿßÿ∞",
                    phone: "ÿßŸÑŸáÿßÿ™ŸÅ",
                    email: "ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
                    no_establishments: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ£Ÿä ŸÖÿ§ÿ≥ÿ≥ÿ©",
                    select_establishment: "ÿßÿÆÿ™ÿ± ŸÖÿ§ÿ≥ÿ≥ÿ©",
                    establishment_address: "ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©",
                    establishment_phone: "Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©",
                    delete_establishment: "ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©",
                    confirm_delete_establishment: "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©ÿü",
                    edit_establishment: "ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©",
                    save_establishment: "ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©",
                    no_classes_linked: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿ±ÿ®ÿ∑ ÿ£Ÿä ÿµŸÅ",
                    select_class_establishment: "ŸÖÿ§ÿ≥ÿ≥ÿ© ÿßŸÑÿµŸÅ",
                    class: "ÿßŸÑÿµŸÅ",
                    no_establishment: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ§ÿ≥ÿ≥ÿ©",
                    click_to_change_establishment: "ÿßŸÜŸÇÿ± ŸÑÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©",

                    modal_new_class: "ÿµŸÅ ÿ¨ÿØŸäÿØ",
                    class_name_label: "ÿßÿ≥ŸÖ ÿßŸÑÿµŸÅ",
                    subject_label: "ÿßŸÑŸÖÿßÿØÿ©",
                    establishment_label: "ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",

                    // Trimestres
                    manage_trimesters: "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©",
                    no_trimesters: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ£Ÿä ŸÅÿ™ÿ±ÿ© ÿØÿ±ÿßÿ≥Ÿäÿ©",
                    trimester_name: "ÿßÿ≥ŸÖ ÿßŸÑŸÅÿ™ÿ±ÿ© (ŸÖÿ´ŸÑ: ÿßŸÑŸÅÿµŸÑ ÿßŸÑÿ£ŸàŸÑ)",
                    trimester_observation_hint: "ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÑŸáÿ∞Ÿá ÿßŸÑŸÅÿ™ÿ±ÿ©...",
                    trimester_observation: "ŸÖŸÑÿßÿ≠ÿ∏ÿ©",
                    edit: "ÿ™ÿπÿØŸäŸÑ",
                    save: "ÿ≠ŸÅÿ∏",
                    annual_average: "ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ≥ŸÜŸàŸä",
                    trimester_average: "ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑",

                    modal_scan: "ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖŸÉÿ™ÿ¥ŸÅÿ©",
                    select_file: "ÿ≠ÿØÿØ ŸÖŸÑŸÅ TeacherTrack ŸÑŸÑŸÅÿ™ÿ≠:",
                    no_json_found: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸÑŸÅÿßÿ™ .json ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¨ŸÑÿØ",

                    // Messages
                    confirm_delete_student: "ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ∑ÿßŸÑÿ®ÿü",
                    file_modified: "ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ŸÖŸÜÿ∞ ÿ¢ÿÆÿ± ŸÇÿ±ÿßÿ°ÿ©.",
                    confirm_close: "ÿ•ÿ∫ŸÑÿßŸÇ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÑŸÅÿü",
                    unsaved_changes: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ÿπÿ∂ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™.",
                    save_before_close: "ÿßŸÜŸÇÿ± ŸÅŸàŸÇ \"ŸÖŸàÿßŸÅŸÇ\" ŸÑŸÑÿ≠ŸÅÿ∏ ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇÿå ÿ£Ÿà \"ÿ•ŸÑÿ∫ÿßÿ°\" ŸÑŸÑÿ•ÿ∫ŸÑÿßŸÇ ÿØŸàŸÜ ÿ≠ŸÅÿ∏.",
                    close_without_save: "ÿ•ÿ∫ŸÑÿßŸÇ ÿØŸàŸÜ ÿ≠ŸÅÿ∏ÿü",
                    confirm_delete_subject: "ÿ™ÿ≠ÿ™ŸàŸä Ÿáÿ∞Ÿá ÿßŸÑŸÖÿßÿØÿ© ÿπŸÑŸâ ÿ™ŸÇŸäŸäŸÖ. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅŸáÿß ÿ≠ŸÇŸãÿßÿü",
                    no_subject: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿßÿØÿ©",
                    exam_count: (count) => count === 1 ? `${count} ÿ™ŸÇŸäŸäŸÖ` : `${count} ÿ™ŸÇŸäŸäŸÖÿßÿ™`,
                    import_success: (count) => `${count} ÿ∑ÿßŸÑÿ®(ÿ©) ŸÖÿ≥ÿ™Ÿàÿ±ÿØ(ŸàŸÜ)`,
                    error_file_format: "ÿµŸäÿ∫ÿ© ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©",
                    error_opening: "ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÅÿ™ÿ≠:",
                    browser_not_supported: "ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸÑÿß ŸäÿØÿπŸÖ Ÿàÿßÿ¨Ÿáÿ© ÿ®ÿ±ŸÖÿ¨ÿ© ÿ™ÿ∑ÿ®ŸäŸÇÿßÿ™ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™. ÿßÿ≥ÿ™ÿÆÿØŸÖ Chrome ÿ£Ÿà Edge ÿ£Ÿà Opera.",

                    // Details √©l√®ve
                    general_average: "ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿπÿßŸÖ",

                    // Pr√©sences
                    attendance_date: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ",

                    // Header
                    add_class: "ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅ",
                    all_subjects: "ÿßŸÑŸÉŸÑ",
                    manage_subjects: "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿßÿØ",

                    // Students list
                    no_students_list_msg: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∑ŸÑÿßÿ® ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿµŸÅ",
                    add_student_hint: "ÿßŸÜŸÇÿ± ÿπŸÑŸâ \"ÿ•ÿ∂ÿßŸÅÿ©\" ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ∑ÿßŸÑÿ®",
                    mean: "ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑:",
                    absent_count: "ÿ∫",
                    late_count: "ÿ™",

                    // Export
                    export_grades: "ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜŸÇÿßÿ∑",
                    export_grades_title: "ÿ™ÿµÿØŸäÿ± Ÿàÿ´ŸäŸÇÿ© ÿ≠ÿ¨ÿ≤ ÿßŸÑŸÜŸÇÿßÿ∑",
                    select_trimester_export: "ÿßÿÆÿ™ÿ± ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©",
                    export_button: "ÿ™ÿµÿØŸäÿ±",
                    no_students_to_export: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∑ŸÑÿßÿ® ŸÑŸÑÿ™ÿµÿØŸäÿ±",
                    all_trimesters: "ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™",
                    no_exams_for_trimester: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÇŸäŸäŸÖÿßÿ™ ŸÑŸáÿ∞Ÿá ÿßŸÑŸÅÿ™ÿ±ÿ©",
                    select_layout_format: "ÿßÿÆÿ™ÿ± ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑",
                    format_arabic: "ÿπÿ±ÿ®Ÿä (ŸÖŸÜ ÿßŸÑŸäŸÖŸäŸÜ ŸÑŸÑŸäÿ≥ÿßÿ±)",
                    format_western: "ÿ∫ÿ±ÿ®Ÿä (ŸÖŸÜ ÿßŸÑŸäÿ≥ÿßÿ± ŸÑŸÑŸäŸÖŸäŸÜ)",

                    // Grades
                    exam: (exam) => `/ ${exam.max} ‚Ä¢ ŸÖÿπ ${exam.coeff}`,
                },

                // ==================== ANGLAIS ====================
                en: {
                    // Home
                    app_title: "TeacherTrack",
                    app_subtitle: "Simple and local class management",
                    sgc_meaning: "SGC = Smart Grade Control",
                    btn_open_file: "Open file",
                    btn_explorer: "Select via system explorer",
                    btn_scan_folder: "Scan folder",
                    btn_detect_json: "Detect existing .json files",
                    btn_new_space: "New space",
                    btn_create_json: "Create new .json file",
                    drop_zone_text: "Drag and drop a .json file here",
                    drop_zone_click: "or click to select",
                    security_note: "Note: For security reasons, browsers cannot automatically access the project folder. Use the buttons above or drag and drop a file.",
                    recent_files: "Recent files",
                    clear_recent: "Clear",
                    no_recent: "No recent files",
                    recent_appear: "Your recent files will appear here",
                    local_note: "100% local - No data is sent to the internet",

                    // Licence
                    license_title: "License",
                    license_placeholder: "XXXX-XXXX-XXXX-XXXX",
                    license_activate: "Activate license",
                    license_invalid: "Invalid license",
                    license_expired: "License expired",
                    license_wrong_user: "This license belongs to another user",
                    license_success: "License activated successfully",
                    license_owner: "Owner",
                    license_get: "Get your key from your reseller",
                    license_active: "PRO LICENSE",
                    license_not_activated: "VERSION NOT ACTIVATED",
                    license_activation_title: "License Activation",
                    license_owner_label: "Owner",
                    license_enter_key: "Enter your license key to activate the application.",
                    license_get_key: "Get your key from your reseller",

                    // Header
                    close: "Close",
                    save: "Save",
                    unsaved: "Unsaved",
                    saved: "Saved",

                    // Welcome messages
                    welcome_title: "Welcome to TeacherTrack",
                    create_first_class_hint: "Create your first class to manage your students",
                    create_first_class: "Create your first class to get started",
                    class_name: "Class name (e.g., 3rd Grade B)",
                    subject_name: "Subject (e.g., Mathematics)",
                    create_class: "Create my first class",
                    main_subject: "Main subject",

                    // Tabs
                    tab_students: "Students",
                    tab_list: "Student List",
                    tab_grades: "Grades",
                    tab_attendance: "Attendance",
                    tab_planning: "Planning",
                    tab_reports: "Reports",

                    // Students page
                    students_title: "Students",
                    students_count: "Students",
                    import: "Import from Excel",
                    import_students: "Import students",
                    add: "Add",
                    lastname: "Last name",
                    firstname: "First name",
                    average: "Average",
                    actions: "Actions",
                    delete: "Delete",
                    no_students: "No students. Click \"Add\" to create one.",

                    // Student list page
                    students_list_title: "Student List",
                    all_subjects: "All subjects",
                    phone: "Phone",
                    absent: "A",
                    late: "L",
                    no_students_list: "No students in this class",
                    add_student_list: "Click \"Add\" to create a student",

                    // Grades page
                    grades_title: "Grade Book",
                    new_evaluation: "New Evaluation",
                    no_evaluations: "No evaluations for this subject",
                    create_eval: "Create an evaluation or select \"All\" to see all subjects",
                    evaluation_name: "Name",
                    evaluation_subject: "Subject",
                    evaluation_trimester: "Period",
                    evaluation_max: "Grade out of",
                    evaluation_coeff: "Coefficient",

                    // Attendance page
                    attendance_title: "Attendance",
                    present: "Present",
                    absent: "Absent",
                    late_word: "Late",
                    good_appreciation: "Good appreciation",
                    bad_appreciation: "Poor appreciation",

                    // Planning page
                    planning_title: "Planning",
                    add_planning: "Add",
                    planning_session_title: "Session title",
                    planning_content: "Lesson content, homework...",
                    no_planning: "No scheduled sessions. Click \"Add\" to create an entry.",

                    // Reports page
                    stats_title: "Class Statistics",
                    class_average: "Class Average",
                    highest_grade: "Highest Grade",
                    lowest_grade: "Lowest Grade",
                    export: "Export",
                    export_excel: "Export Excel",
                    export_desc: "Download a .xlsx file with all data",

                    // Modals
                    modal_new_student: "New Student",
                    student_id: "Identification Number",
                    photo: "Photo",
                    upload_photo: "Upload photo",
                    remove_photo: "Remove photo",
                    photo_hint: "JPG, PNG (max 2Mo)",
                    birthdate: "Date of birth",
                    address: "Address",
                    phone_parents: "Phone (parents)",
                    father: "Father's name",
                    mother: "Mother's name",
                    parent_email: "Parent's email",

                    // Teacher info
                    tab_teacher: "My Info",
                    teacher_name: "Last name",
                    teacher_firstname: "First name",
                    school_year: "School Year",
                    main_establishment: "Main Establishment",
                    secondary_establishments: "Secondary Establishments",
                    add_establishment: "Add establishment",
                    establishment_name: "Establishment name",
                    establishment_classes: "Linked classes",
                    subject_taught: "Subject taught",
                    teacher_type: "Teacher type",
                    type_professor: "Professor",
                    type_institute: "Teacher",
                    type_supeur: "Supervisor",
                    type_other: "Other",
                    teacher_label: "Teacher",
                    phone: "Phone",
                    email: "Email",
                    no_establishments: "No establishments added",
                    select_establishment: "Select an establishment",
                    establishment_address: "Establishment address",
                    establishment_phone: "Establishment phone",
                    delete_establishment: "Delete establishment",
                    confirm_delete_establishment: "Are you sure you want to delete this establishment?",
                    edit_establishment: "Edit establishment",
                    save_establishment: "Save establishment",
                    no_classes_linked: "No linked classes",
                    select_class_establishment: "Class establishment",
                    class: "Class",
                    no_establishment: "No establishment",
                    click_to_change_establishment: "Click to change establishment",

                    modal_new_class: "New Class",
                    class_name_label: "Class name",
                    subject_label: "Subject",
                    establishment_label: "Establishment (optional)",

                    // Trimesters
                    manage_trimesters: "Manage Trimesters",
                    no_trimesters: "No trimester defined",
                    trimester_name: "Trimester name (e.g., Trimester 1)",
                    trimester_observation_hint: "Observation for this trimester...",
                    trimester_observation: "Observation",
                    edit: "Edit",
                    save: "Save",
                    annual_average: "Annual Average",
                    trimester_average: "Average",

                    modal_scan: "Detected files",
                    select_file: "Select a TeacherTrack file to open:",
                    no_json_found: "No .json files found in this folder",

                    // Messages
                    confirm_delete_student: "Delete this student?",
                    file_modified: "The file has been modified since last read.",
                    confirm_close: "Close this file?",
                    unsaved_changes: "Some changes have not been saved.",
                    save_before_close: "Click OK to save before closing, or Cancel to close without saving.",
                    close_without_save: "Close without saving?",
                    confirm_delete_subject: "This subject contains evaluations. Are you sure you want to delete it?",
                    no_subject: "No subject",
                    exam_count: (count) => count === 1 ? `${count} evaluation` : `${count} evaluations`,
                    import_success: (count) => `${count} student(s) imported`,
                    error_file_format: "Invalid file format",
                    error_opening: "Error opening:",
                    browser_not_supported: "Your browser does not support the File System Access API. Use Chrome, Edge, or Opera.",

                    // Student details
                    general_average: "General Average",

                    // Attendance
                    attendance_date: "Date",

                    // Header
                    add_class: "Add class",
                    all_subjects: "All",
                    manage_subjects: "Manage subjects",

                    // Students list
                    no_students_list_msg: "No students in this class",
                    add_student_hint: "Click \"Add\" to create a student",
                    mean: "Average:",
                    absent_count: "A",
                    late_count: "L",

                    // Export
                    export_grades: "Export Grades",
                    export_grades_title: "Export grade document",
                    select_trimester_export: "Select the period",
                    export_button: "Export",
                    no_students_to_export: "No students to export",
                    all_trimesters: "All periods",
                    no_exams_for_trimester: "No evaluations for this period",
                    select_layout_format: "Select layout format",
                    format_arabic: "Arabic (Right to Left)",
                    format_western: "Western (Left to Right)",

                    // Grades
                    exam: (exam) => `/ ${exam.max} ‚Ä¢ Coeff ${exam.coeff}`,

                    // New fields for official header
                    field_republic: "1- People's Democratic Republic of Algeria",
                    field_ministry: "2- Ministry of National Education",
                    field_directorate: "3- Directorate of Education of Wilaya of",
                    official_header_fields: "Official fields for documents (editable)",
                }
            };

            const currentLang = ref(localStorage.getItem('teacherTrack_lang') || 'fr');

            const t = (key, ...args) => {
                const dict = translations[currentLang.value];
                if (dict && dict[key]) {
                    const value = dict[key];
                    if (typeof value === 'function') {
                        return value(...args);
                    }
                    return value;
                }
                // Fallback vers fran√ßais si traduction manquante
                const frDict = translations['fr'];
                const frValue = frDict[key] || key;
                if (typeof frValue === 'function') {
                    return frValue(...args);
                }
                return frValue;
            };

            const setLang = (lang) => {
                currentLang.value = lang;
                localStorage.setItem('teacherTrack_lang', lang);
                document.documentElement.lang = lang;
                // RTL for Arabic only, LTR for French and English
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            };

            createApp({
                setup() {
                    // √âtats principaux
                    const isDataLoaded = ref(false);
                    const db = reactive({
                        classes: [],
                        teacherInfo: {
                            lastname: '',
                            firstname: '',
                            schoolYear: new Date().getFullYear().toString() + '-' + (new Date().getFullYear() + 1).toString(),
                            mainEstablishment: '',
                            subject: '',
                            teacherType: 'professor',
                            phone: '',
                            email: '',
                            fieldRepublic: '1- R√©publique Alg√©rienne D√©mocratique et Populaire',
                            fieldMinistry: '2- Minist√®re de l\'√âducation Nationale',
                            fieldDirectorate: '3- Direction de l\'√âducation de la Wilaya de Constantine'
                        },
                        establishments: []
                    });
                    const currentClassIndex = ref(0);
                    const currentTab = ref('teacher');
                    const fileName = ref('');
                    const fileHandle = ref(null);
                    const hasUnsavedChanges = ref(false);

                    // Modals
                    const showStudentModal = ref(false);
                    const showExamModal = ref(false);
                    const showClassModal = ref(false);
                    const showSubjectModal = ref(false);
                    const showScanModal = ref(false);
                    const showTrimesterModal = ref(false);
                    const showEstablishmentModal = ref(false);
                    const showClassEstablishmentModal = ref(false); // Pour assigner un √©tablissement √† la classe
                    const editingEstablishment = ref(null); // Pour l'√©dition d'√©tablissement
                    const showExportModal = ref(false); // Pour l'export des notes
                    const selectedTrimesterExport = ref(''); // Trimestre s√©lectionn√© pour l'export
                    const exportFormat = ref('rtl'); // Format d'export: 'rtl' (arabe) ou 'ltr' (occidental)

                    // Gestion des espaces (Capacitor Android)
                    const availableSpaces = ref([]); // Liste des espaces (fichiers JSON)
                    const isNative = ref(false); // D√©tection plateforme native (√©vite erreur template)

                    // Licence RSA
                    const showLicenseModal = ref(false);
                    const licenseInput = ref('');
                    const licenseError = ref('');
                    const isLicenseValid = ref(false);
                    const licenseOwner = ref('');
                    const licenseFilePath = ref(''); // Chemin du fichier licence detecte

                    // ============================================================
                    // SYST√àME DE LICENCE S√âCURIS√â (RSA-PSS)
                    // ============================================================
                    // Cl√© publique RSA pour la v√©rification des licences (algorithme PS256)
                    // NOTE: La cl√© priv√©e est stock√©e s√©par√©ment dans admin-keygen.html pour la g√©n√©ration des licences

                    const PUBLIC_KEY = { "alg": "PS256", "e": "AQAB", "ext": true, "key_ops": ["verify"], "kty": "RSA", "n": "yeAKJ28Va45Nl4dHQlYimbGn_L5j57MWLkT1ClMlwIqe1DqGuYhgFfk-faxFALDB9av64yBhcXgawMEei_433HZyl51xuvDmRMKe4pCJT-ax5Lz99LjbKEFTrp4E6H3mzE_BP0FDRk1nnO86jsfpgP_5iW2wBVxq26G5ykvWmvChRZamSqkc-TUgyT4mc-moizTqp2BF30KTzXG0Fg2V8-mjKMGcqfpZbUdAF48gtzyWwi8gGvTOHh_9V4N8FIn2B2vIS-uBTftKHp0J8EA_c3Tnj82gSNdt9QKXOuKtgNxiRHtrX2tbPF1KexSdWw2GyYFE4ArxNrF6mjKjOxRNhQ" };

                    // Scanner le dossier sgc-teachertrack pour trouver un fichier licence .txt valide
                    const scanForLicenseFile = async () => {
                        // Mode Desktop: Utiliser localStorage
                        if (!window.Capacitor?.isNativePlatform()) {
                            const savedLicense = localStorage.getItem('teachertrack_license_v1');
                            if (savedLicense) {
                                return savedLicense;
                            }
                            return null;
                        }

                        // Mode Android: Scanner le dossier sgc-teachertrack/ pour *.txt
                        try {
                            // Creer le dossier s'il n'existe pas
                            try {
                                await window.Filesystem.mkdir({
                                    path: 'sgc-teachertrack',
                                    directory: window.Directory.Documents,
                                    recursive: true
                                });
                            } catch (e) { /* Dossier existe deja */ }

                            const result = await window.Filesystem.readdir({
                                path: 'sgc-teachertrack',
                                directory: window.Directory.Documents
                            });

                            const txtFiles = result.files.filter(f => f.name.endsWith('.txt'));
                            console.log(`üìÇ Fichiers .txt trouves: ${txtFiles.length}`);

                            for (const file of txtFiles) {
                                try {
                                    const content = await window.Filesystem.readFile({
                                        path: `sgc-teachertrack/${file.name}`,
                                        directory: window.Directory.Documents,
                                        encoding: window.Encoding.UTF8
                                    });

                                    // Extraire le code base64 du fichier (peut etre formate avec instructions)
                                    let licenseCode = null;
                                    const lines = content.data.split('\n');
                                    for (const line of lines) {
                                        const trimmed = line.trim();
                                        if (trimmed.startsWith('eyJ') && trimmed.length > 50) {
                                            licenseCode = trimmed;
                                            break;
                                        }
                                    }
                                    // Fallback: si pas trouv√©, essayer le contenu entier
                                    if (!licenseCode && content.data.trim().startsWith('eyJ')) {
                                        licenseCode = content.data.trim();
                                    }

                                    if (!licenseCode) continue; // Pas de code valide dans ce fichier

                                    // Verifier si c'est une licence valide
                                    const isValid = await verifyLicenseContent(licenseCode);
                                    if (isValid) {
                                        console.log(`‚úÖ Licence valide trouvee: ${file.name}`);
                                        licenseFilePath.value = file.name;
                                        return licenseCode;
                                    }
                                } catch (readErr) {
                                    console.warn(`Impossible de lire ${file.name}:`, readErr);
                                }
                            }
                        } catch (e) {
                            console.error('Erreur scan licence:', e);
                        }
                        return null;
                    };

                    // Verifier le contenu d'une licence (sans modifier l'etat)
                    const verifyLicenseContent = async (inputCode) => {
                        if (!inputCode) return false;
                        try {
                            // Decoder l'enveloppe
                            const jsonRaw = decodeURIComponent(atob(inputCode).split('').map(function (c) {
                                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                            }).join(''));
                            const licObj = JSON.parse(jsonRaw);

                            if (Object.keys(PUBLIC_KEY).length === 0) return true; // Mode dev

                            // Import Cle Publique
                            const key = await window.crypto.subtle.importKey("jwk", PUBLIC_KEY, { name: "RSA-PSS", hash: "SHA-256" }, false, ["verify"]);

                            // Preparer donnees
                            const sig = Uint8Array.from(atob(licObj.sig), c => c.charCodeAt(0));
                            const data = new TextEncoder().encode(licObj.owner);

                            // Verifier signature
                            const valid = await window.crypto.subtle.verify({ name: "RSA-PSS", saltLength: 32 }, key, sig, data);
                            return valid;
                        } catch (e) {
                            return false;
                        }
                    };

                    // Importer un fichier licence via file picker
                    const importLicenseFile = async (event) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        licenseError.value = '';

                        try {
                            const content = await file.text();

                            // Extraire le code de licence du fichier
                            // Le fichier peut contenir du texte format√© avec instructions
                            // Le vrai code de licence est une cha√Æne base64 commen√ßant par 'eyJ'
                            let licenseCode = null;

                            // M√©thode 1: Chercher une ligne commen√ßant par 'eyJ' (base64 JSON)
                            const lines = content.split('\n');
                            for (const line of lines) {
                                const trimmed = line.trim();
                                if (trimmed.startsWith('eyJ') && trimmed.length > 50) {
                                    licenseCode = trimmed;
                                    break;
                                }
                            }

                            // M√©thode 2: Si pas trouv√©, essayer le contenu entier (fichier raw)
                            if (!licenseCode) {
                                const trimmedContent = content.trim();
                                if (trimmedContent.startsWith('eyJ')) {
                                    licenseCode = trimmedContent;
                                }
                            }

                            if (!licenseCode) {
                                console.error('Aucun code licence trouv√© dans le fichier');
                                licenseError.value = t('license_file_invalid') || 'Fichier licence invalide. Aucun code de licence trouv√©.';
                                event.target.value = '';
                                return;
                            }

                            console.log('üìÑ Code licence extrait:', licenseCode.substring(0, 50) + '...');

                            // Verifier la validite de la licence
                            const isValid = await verifyLicenseContent(licenseCode);

                            if (isValid) {
                                // Activer la licence (verifyLicense s'occupe aussi de la sauvegarde)
                                await verifyLicense(licenseCode);

                                // Feedback succ√®s si la licence est maintenant valide
                                if (isLicenseValid.value) {
                                    console.log('‚úÖ Licence import√©e et activ√©e avec succ√®s');
                                }
                            } else {
                                licenseError.value = t('license_file_invalid') || 'Fichier licence invalide. Signature incorrecte.';
                            }
                        } catch (e) {
                            console.error('Erreur import licence:', e);
                            licenseError.value = 'Erreur de lecture du fichier.';
                        }

                        event.target.value = '';
                    };

                    // Valider que le fichier de donnees appartient au proprietaire de la licence
                    // RETOURNE: true si OK, false si rejete
                    const validateDataFileOwner = (data) => {
                        console.log('üîê validateDataFileOwner appel√©e');
                        console.log('  - isLicenseValid:', isLicenseValid.value);
                        console.log('  - licenseOwner:', licenseOwner.value);
                        console.log('  - data.teacherInfo:', data?.teacherInfo);

                        // Si pas de licence valide, pas de verification
                        if (!isLicenseValid.value || !licenseOwner.value) {
                            console.log('  ‚Üí Pas de licence ou proprietaire vide, acceptation automatique');
                            return true;
                        }

                        // Si le fichier n'a pas d'info enseignant, on accepte (nouveau fichier)
                        if (!data.teacherInfo || (!data.teacherInfo.lastname && !data.teacherInfo.firstname)) {
                            console.log('  ‚Üí Pas d\'info enseignant dans le fichier, acceptation');
                            return true;
                        }

                        // Normaliser les noms
                        const fileOwner = `${data.teacherInfo.lastname || ''} ${data.teacherInfo.firstname || ''}`.trim().toLowerCase();
                        const licenseOwnerNorm = licenseOwner.value.trim().toLowerCase();

                        console.log('  - fileOwner normalis√©:', fileOwner);
                        console.log('  - licenseOwner normalis√©:', licenseOwnerNorm);

                        // Comparer
                        if (fileOwner && fileOwner !== licenseOwnerNorm) {
                            const fileOwnerDisplay = `${data.teacherInfo.lastname || ''} ${data.teacherInfo.firstname || ''}`.trim();
                            console.log('  ‚Üí REJET: proprietaire diff√©rent!');
                            alert(`‚ùå Ce fichier appartient a "${fileOwnerDisplay}".\n\nVotre licence est enregistree pour "${licenseOwner.value}".\n\nVeuillez ouvrir un fichier vous appartenant.`);
                            return false; // REJETER LE FICHIER
                        }

                        console.log('  ‚Üí OK: proprietaire correspondant');
                        return true; // OK
                    };

                    // Annuler le modal de licence et fermer le fichier pour prot√©ger les donn√©es
                    const cancelLicenseModal = () => {
                        showLicenseModal.value = false;
                        closeFile();
                    };

                    // ANCIENNE FONCTION remplacee par validateDataFileOwner
                    // Conservee pour compatibilite mais ne fait plus rien
                    const verifyUserMatchWithLicense = async () => {
                        // Cette fonction est remplacee par validateDataFileOwner
                        // Elle ne fait plus rien car la logique est inversee:
                        // On rejette le fichier, pas la licence
                        return true;
                    };

                    // V√©rification et activation de licence
                    const verifyLicense = async (inputCode) => {
                        licenseError.value = ''; // Reset error
                        if (!inputCode) return;
                        try {
                            // 1. D√©coder l'enveloppe (Compatible UTF-8 / Arabe)
                            const jsonRaw = decodeURIComponent(atob(inputCode).split('').map(function (c) {
                                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                            }).join(''));
                            const licObj = JSON.parse(jsonRaw);

                            // 2. V√©rifier si cl√© publique est configur√©e
                            if (Object.keys(PUBLIC_KEY).length === 0) {
                                console.warn("ERREUR DEV: Cl√© Publique non configur√©e dans index.html!");
                                // En mode dev, on autorise quand m√™me sans v√©rification cryptographique
                                isLicenseValid.value = true;
                                licenseOwner.value = licObj.owner || "D√©veloppeur";
                                licenseInput.value = '';
                                showLicenseModal.value = false;
                                return;
                            }

                            // 3. Import Cl√© Publique
                            const key = await window.crypto.subtle.importKey("jwk", PUBLIC_KEY, { name: "RSA-PSS", hash: "SHA-256" }, false, ["verify"]);

                            // 4. Pr√©parer donn√©es
                            const sig = Uint8Array.from(atob(licObj.sig), c => c.charCodeAt(0));
                            const data = new TextEncoder().encode(licObj.owner);

                            // 5. V√âRIFIER SIGNATURE
                            const valid = await window.crypto.subtle.verify({ name: "RSA-PSS", saltLength: 32 }, key, sig, data);

                            if (valid) {
                                // 6. Nettoyer les anciennes donn√©es de licence avant d'activer la nouvelle
                                localStorage.removeItem('teachertrack_user_info');

                                // 7. Activer la licence
                                isLicenseValid.value = true;
                                licenseOwner.value = licObj.owner; // "NOM Pr√©nom"
                                licenseInput.value = '';
                                showLicenseModal.value = false;

                                // 8. Sauvegarde Persistante de la licence
                                // NOTE: La validation du propri√©taire se fait via validateDataFileOwner()
                                // lors du chargement d'un fichier de donn√©es, pas ici.
                                const storeKey = 'teachertrack_license_v1';
                                if (window.Capacitor?.isNativePlatform()) {
                                    // Android: Sauvegarde dans le syst√®me de fichiers (coh√©rent avec scanForLicenseFile)
                                    try {
                                        await window.Filesystem.writeFile({
                                            path: 'sgc-teachertrack/license.txt',
                                            data: inputCode,
                                            directory: window.Directory.Documents,
                                            encoding: window.Encoding.UTF8
                                        });
                                        console.log('üìÑ Licence sauvegard√©e dans sgc-teachertrack/license.txt');
                                    } catch (writeErr) {
                                        console.warn('Erreur sauvegarde licence Android:', writeErr);
                                    }
                                } else {
                                    // Desktop: localStorage
                                    localStorage.setItem(storeKey, inputCode);
                                }

                                console.log(`‚úÖ Licence activ√©e pour: ${licObj.owner}`);
                            } else {
                                licenseError.value = t('license_invalid');
                            }
                        } catch (e) {
                            console.error("Erreur licence:", e);
                            licenseError.value = t('license_invalid');
                            isLicenseValid.value = false;
                            licenseOwner.value = "";
                        }
                    };

                    // Injecter l'identit√© de la licence dans les donn√©es
                    const applyLicenseIdentity = () => {
                        if (isLicenseValid.value && licenseOwner.value) {
                            const parts = licenseOwner.value.split(' ');
                            db.teacherInfo.lastname = parts[0] || '';
                            db.teacherInfo.firstname = parts.slice(1).join(' ') || '';
                        }
                    };

                    // GARDIEN (Wrapper) - Bloque les actions si pas de licence
                    const requireLicense = async (actionFn) => {
                        let code = "";
                        if (window.Capacitor?.isNativePlatform()) {
                            const ret = await window.Preferences.get({ key: 'teachertrack_license_v1' });
                            code = ret.value;
                        } else {
                            code = localStorage.getItem('teachertrack_license_v1');
                        }

                        if (!code) {
                            showLicenseModal.value = true;
                            return; // Stop - affiche le modal
                        }

                        // Si licence pas encore valid√©e, on v√©rifie
                        if (!isLicenseValid.value) {
                            await verifyLicense(code);
                        }

                        // Si apr√®s v√©rification c'est bon, on ex√©cute
                        if (isLicenseValid.value) {
                            actionFn();
                        } else {
                            showLicenseModal.value = true;
                        }
                    };

                    // Donn√©es de l'enseignant
                    const teacherInfo = reactive({
                        lastname: '',
                        firstname: '',
                        schoolYear: new Date().getFullYear().toString() + '-' + (new Date().getFullYear() + 1).toString(),
                        mainEstablishment: '',
                        secondaryEstablishments: [],
                        subject: '',
                        teacherType: 'professor',
                        phone: '',
                        email: ''
                    });

                    // Nouvel √©tablissement
                    const newEstablishment = reactive({ name: '', address: '', phone: '', classes: [] });

                    // Donn√©es temporaires
                    const newTrimester = reactive({ id: '', name: '', observation: '' });

                    // Donn√©es temporaires
                    const newStudent = reactive({
                        firstname: '',
                        lastname: '',
                        student_id: '',
                        birthdate: '',
                        address: '',
                        phone: '',
                        parent_father: '',
                        parent_father_email: '',
                        parent_mother: '',
                        parent_mother_email: '',
                        photo: ''
                    });
                    const newExam = reactive({ name: '', max: 20, coeff: 1, subjectId: '', trimesterId: '' });
                    const newClassName = ref('');
                    const newClassSubject = ref('');
                    const newClassEstablishmentId = ref(''); // √âtablissement pour la nouvelle classe
                    const pendingClassIdForEstablishment = ref(null); // ID temporaire pour lier la classe √† l'√©tablissement lors de sa cr√©ation
                    const newSubjectName = ref('');
                    const attendanceDate = ref(new Date().toISOString().split('T')[0]);
                    const searchQuery = ref('');
                    const searchPlanningQuery = ref('');

                    // Mati√®re active (s√©lectionn√©e dans le dropdown)
                    const currentSubjectId = ref(null);

                    // √âl√®ve s√©lectionn√© pour les d√©tails
                    const selectedStudent = ref(null);

                    // Historique
                    const recentFiles = ref([]);
                    const scannedFiles = ref([]);
                    const maxRecentFiles = 5;

                    // Onglets
                    const tabs = computed(() => [
                        { id: 'teacher', name: t('tab_teacher'), icon: 'fas fa-user-tie' },
                        { id: 'students', name: t('tab_students'), icon: 'fas fa-users' },
                        { id: 'eleves', name: t('tab_list'), icon: 'fas fa-list' },
                        { id: 'grades', name: t('tab_grades'), icon: 'fas fa-clipboard-list' },
                        { id: 'attendance', name: t('tab_attendance'), icon: 'fas fa-calendar-check' },
                        { id: 'planner', name: t('tab_planning'), icon: 'fas fa-calendar-alt' },
                        { id: 'reports', name: t('tab_reports'), icon: 'fas fa-chart-bar' }
                    ]);

                    // === GESTION DES MATI√àRES ===

                    // Migration des donn√©es anciennes (sujet unique ‚Üí tableau de mati√®res)
                    const migrateSubjects = (cls) => {
                        if (typeof cls.subject === 'string' && cls.subject) {
                            // Ancien format : une seule mati√®re
                            cls.subjects = [{
                                id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                                name: cls.subject
                            }];
                            delete cls.subject;
                        } else if (!cls.subjects || !Array.isArray(cls.subjects)) {
                            // Pas de mati√®res du tout, cr√©er une mati√®re par d√©faut
                            cls.subjects = [{
                                id: Date.now().toString() + '_default',
                                name: t('main_subject')
                            }];
                        }

                        // Migration des trimestres (si inexistant)
                        if (!cls.trimesters || !Array.isArray(cls.trimesters)) {
                            cls.trimesters = [
                                { id: 'tri1', name: 'Trimestre 1', observation: '' },
                                { id: 'tri2', name: 'Trimestre 2', observation: '' },
                                { id: 'tri3', name: 'Trimestre 3', observation: '' }
                            ];
                        }

                        // Migration des exams pour ajouter trimesterId (si inexistant)
                        if (cls.exams && Array.isArray(cls.exams)) {
                            cls.exams.forEach(exam => {
                                if (!exam.trimesterId) exam.trimesterId = 'tri1';
                            });
                        }

                        // Migration des √©l√®ves pour ajouter les nouveaux champs et observations par trimestre
                        if (cls.students && Array.isArray(cls.students)) {
                            cls.students.forEach(student => {
                                if (!student.hasOwnProperty('student_id')) student.student_id = '';
                                if (!student.hasOwnProperty('birthdate')) student.birthdate = '';
                                if (!student.hasOwnProperty('address')) student.address = '';
                                if (!student.hasOwnProperty('phone')) student.phone = '';
                                if (!student.hasOwnProperty('parent_father')) student.parent_father = '';
                                if (!student.hasOwnProperty('parent_father_email')) student.parent_father_email = '';
                                if (!student.hasOwnProperty('parent_mother')) student.parent_mother = '';
                                if (!student.hasOwnProperty('parent_mother_email')) student.parent_mother_email = '';
                                if (!student.grades) student.grades = {};
                                if (!student.photo) student.photo = '';
                                // Observations par trimestre
                                if (!student.trimesterObservations) student.trimesterObservations = {};
                            });
                        }
                    };

                    // Mati√®res de la classe courante
                    const currentSubjects = computed(() => currentClass.value?.subjects || []);

                    // Mati√®re active s√©lectionn√©e
                    const currentSubject = computed(() => {
                        if (!currentClass.value?.subjects) return null;
                        if (currentSubjectId.value) {
                            return currentClass.value.subjects.find(s => s.id === currentSubjectId.value);
                        }
                        // Par d√©faut, premi√®re mati√®re
                        return currentClass.value.subjects[0] || null;
                    });

                    // Examens filtr√©s par mati√®re active
                    const filteredExams = computed(() => {
                        if (!currentClass.value?.exams) return [];
                        if (!currentSubjectId.value) {
                            return currentClass.value.exams; // Toutes les mati√®res
                        }
                        return currentClass.value.exams.filter(e => e.subjectId === currentSubjectId.value);
                    });

                    // Ajouter une mati√®re
                    const addSubject = () => {
                        if (!newSubjectName.value.trim() || !currentClass.value) return;
                        const subject = {
                            id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                            name: newSubjectName.value.trim()
                        };
                        currentClass.value.subjects.push(subject);
                        newSubjectName.value = '';
                        showSubjectModal.value = false;
                    };

                    // Supprimer une mati√®re
                    const deleteSubject = (subjectId) => {
                        if (!currentClass.value) return;
                        // V√©rifier s'il y a des √©valuations pour cette mati√®re
                        const examCount = currentClass.value.exams.filter(e => e.subjectId === subjectId).length;
                        if (examCount > 0) {
                            if (!confirm(t('confirm_delete_subject'))) {
                                return;
                            }
                            // Supprimer les √©valuations associ√©es
                            currentClass.value.exams = currentClass.value.exams.filter(e => e.subjectId !== subjectId);
                        }
                        currentClass.value.subjects = currentClass.value.subjects.filter(s => s.id !== subjectId);
                        // R√©initialiser la mati√®re active si n√©cessaire
                        if (currentSubjectId.value === subjectId) {
                            currentSubjectId.value = currentClass.value.subjects[0]?.id || null;
                        }
                    };

                    // S√©lectionner une mati√®re
                    const selectSubject = (subjectId) => {
                        currentSubjectId.value = subjectId;
                    };

                    // === GESTION DES TRIMESTRES ===

                    // Trimestres de la classe courante
                    const currentTrimesters = computed(() => currentClass.value?.trimesters || []);

                    // R√©initialiser le formulaire de trimestre
                    const resetTrimesterForm = () => {
                        newTrimester.id = '';
                        newTrimester.name = '';
                        newTrimester.observation = '';
                    };

                    // Ouvrir le modal pour modifier un trimestre
                    const editTrimester = (tri) => {
                        newTrimester.id = tri.id;
                        newTrimester.name = tri.name;
                        newTrimester.observation = tri.observation || '';
                        showTrimesterModal.value = true;
                    };

                    // Ajouter/Modifier un trimestre
                    const saveTrimester = () => {
                        if (!newTrimester.name.trim() || !currentClass.value) return;

                        if (newTrimester.id) {
                            // Modification
                            const tri = currentClass.value.trimesters.find(t => t.id === newTrimester.id);
                            if (tri) {
                                tri.name = newTrimester.name.trim();
                                tri.observation = newTrimester.observation;
                            }
                        } else {
                            // Ajout
                            currentClass.value.trimesters.push({
                                id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                                name: newTrimester.name.trim(),
                                observation: newTrimester.observation
                            });
                        }

                        resetTrimesterForm();
                        showTrimesterModal.value = false;
                    };

                    // Supprimer un trimestre
                    const deleteTrimester = (triId) => {
                        if (!currentClass.value) return;

                        // V√©rifier s'il y a des √©valuations pour ce trimestre
                        const examCount = currentClass.value.exams.filter(e => e.trimesterId === triId).length;
                        if (examCount > 0) {
                            alert('Impossible de supprimer ce trimestre car il contient des √©valuations. R√©assignez d\'abord les √©valuations.');
                            return;
                        }

                        if (!confirm('Supprimer ce trimestre ?')) return;

                        currentClass.value.trimesters = currentClass.value.trimesters.filter(t => t.id !== triId);

                        // Supprimer les observations des √©l√®ves pour ce trimestre
                        currentClass.value.students.forEach(student => {
                            if (student.trimesterObservations && student.trimesterObservations[triId]) {
                                delete student.trimesterObservations[triId];
                            }
                        });
                    };

                    // Observations des √©l√®ves par trimestre
                    const getTrimesterObservation = (student, triId) => {
                        return student.trimesterObservations?.[triId] || '';
                    };

                    const setTrimesterObservation = (student, triId, text) => {
                        if (!student.trimesterObservations) student.trimesterObservations = {};
                        student.trimesterObservations[triId] = text;
                    };

                    // === GESTION DES INFORMATIONS DE L'ENSEIGNANT ===

                    // Ouvrir le modal d'√©tablissement (pour ajouter ou modifier)
                    const openEstablishmentModal = (establishment = null, fromClassModal = false) => {
                        if (establishment) {
                            // Mode √©dition
                            editingEstablishment.value = establishment.id;
                            newEstablishment.name = establishment.name || '';
                            newEstablishment.address = establishment.address || '';
                            newEstablishment.phone = establishment.phone || '';
                            newEstablishment.classes = [...(establishment.classes || [])];
                        } else {
                            // Mode ajout
                            editingEstablishment.value = null;
                            newEstablishment.name = '';
                            newEstablishment.address = '';
                            newEstablishment.phone = '';
                            newEstablishment.classes = [];
                        }
                        showEstablishmentModal.value = true;
                    };

                    // Sauvegarder un √©tablissement (ajout ou modification)
                    const saveEstablishment = () => {
                        if (!newEstablishment.name.trim()) return;

                        if (editingEstablishment.value) {
                            // Modification d'un √©tablissement existant
                            const est = db.establishments.find(e => e.id === editingEstablishment.value);
                            if (est) {
                                est.name = newEstablishment.name.trim();
                                est.address = newEstablishment.address || '';
                                est.phone = newEstablishment.phone || '';
                                est.classes = [...newEstablishment.classes];
                            }
                        } else {
                            // Ajout d'un nouvel √©tablissement
                            const estId = Date.now().toString();
                            const classes = [...newEstablishment.classes];

                            // Si on cr√©e un √©tablissement depuis le modal de cr√©ation de classe, ajouter la classe en attente
                            if (pendingClassIdForEstablishment.value) {
                                if (!classes.includes(pendingClassIdForEstablishment.value)) {
                                    classes.push(pendingClassIdForEstablishment.value);
                                }
                                // Mettre √† jour le dropdown de s√©lection d'√©tablissement pour la nouvelle classe
                                newClassEstablishmentId.value = estId;
                                // R√©initialiser l'ID en attente
                                pendingClassIdForEstablishment.value = null;
                            }

                            db.establishments.push({
                                id: estId,
                                name: newEstablishment.name.trim(),
                                address: newEstablishment.address || '',
                                phone: newEstablishment.phone || '',
                                classes: classes
                            });
                        }

                        // R√©initialiser le formulaire
                        newEstablishment.name = '';
                        newEstablishment.address = '';
                        newEstablishment.phone = '';
                        newEstablishment.classes = [];
                        editingEstablishment.value = null;
                        showEstablishmentModal.value = false;
                    };

                    // Supprimer un √©tablissement
                    const deleteEstablishment = (id) => {
                        if (!confirm(t('confirm_delete_establishment'))) return;
                        db.establishments = db.establishments.filter(e => e.id !== id);
                        // Mettre √† jour l'√©tablissement principal si n√©cessaire
                        if (db.teacherInfo.mainEstablishment === id) {
                            db.teacherInfo.mainEstablishment = '';
                        }
                    };

                    // Obtenir les noms des classes li√©es √† un √©tablissement
                    const getEstablishmentClasses = (establishment) => {
                        if (!establishment?.classes || establishment.classes.length === 0) return [];
                        return establishment.classes.map(clsId => {
                            const cls = db.classes.find(c => c.id === clsId);
                            return cls ? cls.name : clsId;
                        });
                    };

                    // Obtenir l'√©tablissement de la classe actuelle (bas√© sur les classes assign√©es √† l'√©tablissement)
                    const getCurrentClassEstablishment = computed(() => {
                        if (!currentClass.value) return null;
                        // Trouver l'√©tablissement qui contient cette classe
                        const est = db.establishments.find(e =>
                            e.classes && e.classes.includes(currentClass.value.id)
                        );
                        return est || null;
                    });

                    // Assigner la classe √† un √©tablissement
                    const assignClassToEstablishment = (establishmentId) => {
                        if (!currentClass.value) return;

                        // Retirer la classe de tous les √©tablissements
                        db.establishments.forEach(est => {
                            if (est.classes) {
                                est.classes = est.classes.filter(id => id !== currentClass.value.id);
                            }
                        });

                        // Ajouter la classe √† l'√©tablissement s√©lectionn√© (sauf si vide)
                        if (establishmentId) {
                            const est = db.establishments.find(e => e.id === establishmentId);
                            if (est) {
                                if (!est.classes) est.classes = [];
                                if (!est.classes.includes(currentClass.value.id)) {
                                    est.classes.push(currentClass.value.id);
                                }
                            }
                        }
                    };

                    // R√©initialiser le formulaire d'√©tablissement
                    const resetEstablishmentForm = () => {
                        newEstablishment.name = '';
                        newEstablishment.address = '';
                        newEstablishment.phone = '';
                        newEstablishment.classes = [];
                        editingEstablishment.value = null;
                    };

                    // === FIN GESTION DES INFORMATIONS DE L'ENSEIGNANT ===

                    // === FIN GESTION DES TRIMESTRES ===

                    // === FIN GESTION DES MATI√àRES ===

                    // Propri√©t√©s calcul√©es
                    const getEstablishmentName = (id) => {
                        if (!id) return '';
                        const est = db.establishments.find(e => e.id === id);
                        return est ? est.name : '';
                    };

                    const currentClass = computed(() => {
                        if (!db.classes || db.classes.length === 0) return { students: [], subjects: [], exams: [], planner: [], attendance: {}, appreciations: {}, trimesters: [] };
                        const idx = currentClassIndex.value;
                        return db.classes[idx < db.classes.length ? idx : 0] || db.classes[0];
                    });

                    const sortedPlanner = computed(() => {
                        if (!currentClass.value?.planner) return [];
                        return [...currentClass.value.planner].sort((a, b) => new Date(b.date) - new Date(a.date));
                    });

                    const classStats = computed(() => {
                        if (!currentClass.value || !currentClass.value.students || !currentClass.value.students.length) return { average: '-', highest: '-', lowest: '-' };

                        const averages = currentClass.value.students
                            .map(s => parseFloat(calculateAverage(s)))
                            .filter(v => !isNaN(v) && v !== '-');

                        if (averages.length === 0) return { average: '-', highest: '-', lowest: '-' };

                        const sum = averages.reduce((a, b) => a + b, 0);
                        return {
                            average: (sum / averages.length).toFixed(2),
                            highest: Math.max(...averages).toFixed(2),
                            lowest: Math.min(...averages).toFixed(2)
                        };
                    });

                    // √âl√®ves filtr√©s par recherche
                    const filteredStudents = computed(() => {
                        if (!currentClass.value?.students) return [];
                        if (!searchQuery.value.trim()) return currentClass.value.students;
                        const query = searchQuery.value.toLowerCase().trim();
                        return currentClass.value.students.filter(s =>
                            (s.lastname && s.lastname.toLowerCase().includes(query)) ||
                            (s.firstname && s.firstname.toLowerCase().includes(query)) ||
                            (s.student_id && s.student_id.toLowerCase().includes(query))
                        );
                    });

                    // Planning filtr√© par recherche
                    const filteredPlanner = computed(() => {
                        if (!currentClass.value?.planner) return [];
                        let items = [...currentClass.value.planner].sort((a, b) => new Date(b.date) - new Date(a.date));
                        if (!searchPlanningQuery.value.trim()) return items;
                        const query = searchPlanningQuery.value.toLowerCase().trim();
                        return items.filter(item =>
                            (item.title && item.title.toLowerCase().includes(query)) ||
                            (item.content && item.content.toLowerCase().includes(query)) ||
                            (item.date && item.date.includes(query))
                        );
                    });

                    // Historique des fichiers avec IndexedDB
                    const loadRecentFiles = async () => {
                        recentFiles.value = await loadRecentFromDB();
                    };


                    // ========== FIN LICENCE RSA ==========

                    const addToRecent = async (name, path, handle) => {
                        const file = { name, path, date: new Date().toISOString(), handle: handle };
                        recentFiles.value = recentFiles.value.filter(f => f.path !== path);
                        recentFiles.value.unshift(file);
                        if (recentFiles.value.length > maxRecentFiles) {
                            recentFiles.value = recentFiles.value.slice(0, maxRecentFiles);
                        }
                        await saveRecentToDB(recentFiles.value);
                    };

                    const removeFromRecent = async (path) => {
                        recentFiles.value = recentFiles.value.filter(f => f.path !== path);
                        await removeFromDB(path);
                    };

                    const clearRecentFiles = async () => {
                        recentFiles.value = [];
                        await clearDB();
                    };

                    // Gestion des fichiers avec File System Access API
                    const openFilePicker = async () => {
                        // MODE ANDROID: Rediriger vers les espaces
                        if (isNative.value || window.Capacitor?.isNativePlatform()) {
                            console.log('üì± Android: Redirection vers loadSpaces');
                            await loadSpaces();
                            // Faire d√©filer vers la section des espaces
                            const espacesSection = document.querySelector('[class*="Mes Espaces"]');
                            if (espacesSection) espacesSection.scrollIntoView({ behavior: 'smooth' });
                            return;
                        }

                        // GUARDIAN: V√©rifier la licence avant d'ex√©cuter
                        await requireLicense(async () => {
                            try {
                                if (!window.showOpenFilePicker) {
                                    alert('Votre navigateur ne supporte pas l\'API File System Access. Utilisez Chrome, Edge ou Opera.');
                                    return;
                                }
                                const [handle] = await window.showOpenFilePicker({
                                    types: [{ description: 'Fichiers TeacherTrack', accept: { 'application/json': ['.json'] } }]
                                });
                                await loadFromHandle(handle, handle.name);
                            } catch (e) {
                                if (e.name !== 'AbortError') { console.error(e); alert('Erreur: ' + e.message); }
                            }
                        });
                    };

                    const loadFromHandle = async (handle, name) => {
                        try {
                            const file = await handle.getFile();
                            const content = await file.text();
                            const data = JSON.parse(content);
                            if (data.classes && Array.isArray(data.classes)) {
                                // Migration des donn√©es anciennes et initialisation
                                data.classes.forEach(cls => {
                                    migrateSubjects(cls);
                                });
                                db.classes = data.classes;

                                // Charger les informations de l'enseignant dans db.teacherInfo
                                if (data.teacherInfo) {
                                    db.teacherInfo.lastname = data.teacherInfo.lastname || '';
                                    db.teacherInfo.firstname = data.teacherInfo.firstname || '';
                                    db.teacherInfo.schoolYear = data.teacherInfo.schoolYear || new Date().getFullYear().toString() + '-' + (new Date().getFullYear() + 1).toString();
                                    db.teacherInfo.mainEstablishment = data.teacherInfo.mainEstablishment || '';
                                    db.teacherInfo.subject = data.teacherInfo.subject || '';
                                    db.teacherInfo.teacherType = data.teacherInfo.teacherType || 'professor';
                                    db.teacherInfo.phone = data.teacherInfo.phone || '';
                                    db.teacherInfo.email = data.teacherInfo.email || '';
                                    db.teacherInfo.fieldRepublic = data.teacherInfo.fieldRepublic || '1- R√©publique Alg√©rienne D√©mocratique et Populaire';
                                    db.teacherInfo.fieldMinistry = data.teacherInfo.fieldMinistry || '2- Minist√®re de l\'√âducation Nationale';
                                    db.teacherInfo.fieldDirectorate = data.teacherInfo.fieldDirectorate || '3- Direction de l\'√âducation de la Wilaya de Constantine';
                                }

                                // Charger les √©tablissements dans db.establishments
                                if (data.establishments && Array.isArray(data.establishments)) {
                                    db.establishments = data.establishments;
                                } else if (data.teacherInfo && data.teacherInfo.secondaryEstablishments) {
                                    // Migration des anciens √©tablissements secondaires
                                    db.establishments = data.teacherInfo.secondaryEstablishments.map((est, idx) => ({
                                        ...est,
                                        id: est.id || (Date.now().toString() + '_' + idx)
                                    }));
                                }

                                // S√©lectionner la premi√®re mati√®re par d√©faut
                                currentSubjectId.value = db.classes[0]?.subjects?.[0]?.id || null;
                                isDataLoaded.value = true;
                                fileHandle.value = handle;
                                fileName.value = name || handle.name;
                                await addToRecent(name || handle.name, name || handle.name, handle);
                                await verifyUserMatchWithLicense();
                            } else { alert('Format de fichier invalide'); }
                        } catch (e) {
                            console.error(e);
                            alert('Erreur lors de l\'ouverture: ' + e.message);
                        }
                    };

                    // Scanner un dossier
                    const scanFolder = async () => {
                        // MODE ANDROID: Rediriger vers les espaces
                        if (isNative.value || window.Capacitor?.isNativePlatform()) {
                            console.log('üì± Android: Redirection vers loadSpaces (scan non disponible)');
                            await loadSpaces();
                            return;
                        }

                        // GUARDIAN: V√©rifier la licence avant d'ex√©cuter
                        await requireLicense(async () => {
                            try {
                                if (!window.showDirectoryPicker) {
                                    alert('Votre navigateur ne supporte pas l\'API Directory Picker. Utilisez Chrome, Edge ou Opera.');
                                    return;
                                }
                                const dirHandle = await window.showDirectoryPicker();
                                scannedFiles.value = [];

                                for await (const entry of dirHandle.values()) {
                                    if (entry.kind === 'file' && entry.name.endsWith('.json')) {
                                        const file = await entry.getFile();
                                        scannedFiles.value.push({
                                            name: entry.name,
                                            handle: entry,
                                            size: file.size
                                        });
                                    }
                                }
                                showScanModal.value = true;
                            } catch (e) {
                                if (e.name !== 'AbortError') { console.error(e); alert('Erreur: ' + e.message); }
                            }
                        });
                    };

                    const openScannedFile = async (file) => {
                        // GUARDIAN: V√©rifier la licence avant d'ex√©cuter
                        await requireLicense(async () => {
                            await loadFromHandle(file.handle, file.name);
                            showScanModal.value = false;
                        });
                    };

                    const formatSize = (bytes) => {
                        if (bytes < 1024) return bytes + ' B';
                        let size = bytes < 1024 * 1024 ? (bytes / 1024).toFixed(1) : (bytes / (1024 * 1024)).toFixed(1);
                        // Convertir les chiffres arabes en chiffres normaux
                        if (currentLang.value === 'ar') {
                            size = size.replace(/[Ÿ†-Ÿ©]/g, d => 'Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©'.indexOf(d));
                        }
                        return size + (bytes < 1024 * 1024 ? ' KB' : ' MB');
                    };

                    // Fallback: charger un fichier via input standard
                    const loadFileFromInput = async (event) => {
                        // GUARDIAN: V√©rifier la licence avant d'ex√©cuter
                        await requireLicense(async () => {
                            const file = event.target.files[0];
                            if (!file) return;

                            try {
                                const content = await file.text();
                                const data = JSON.parse(content);
                                if (data.classes && Array.isArray(data.classes)) {
                                    // Migration des donn√©es anciennes et initialisation
                                    data.classes.forEach(cls => {
                                        migrateSubjects(cls);
                                    });
                                    db.classes = data.classes;

                                    // Charger les informations de l'enseignant dans db.teacherInfo
                                    if (data.teacherInfo) {
                                        db.teacherInfo.lastname = data.teacherInfo.lastname || '';
                                        db.teacherInfo.firstname = data.teacherInfo.firstname || '';
                                        db.teacherInfo.schoolYear = data.teacherInfo.schoolYear || new Date().getFullYear().toString() + '-' + (new Date().getFullYear() + 1).toString();
                                        db.teacherInfo.mainEstablishment = data.teacherInfo.mainEstablishment || '';
                                        db.teacherInfo.subject = data.teacherInfo.subject || '';
                                        db.teacherInfo.teacherType = data.teacherInfo.teacherType || 'professor';
                                        db.teacherInfo.phone = data.teacherInfo.phone || '';
                                        db.teacherInfo.email = data.teacherInfo.email || '';
                                        db.teacherInfo.fieldRepublic = data.teacherInfo.fieldRepublic || '1- R√©publique Alg√©rienne D√©mocratique et Populaire';
                                        db.teacherInfo.fieldMinistry = data.teacherInfo.fieldMinistry || '2- Minist√®re de l\'√âducation Nationale';
                                        db.teacherInfo.fieldDirectorate = data.teacherInfo.fieldDirectorate || '3- Direction de l\'√âducation de la Wilaya de Constantine';
                                    }

                                    // Charger les √©tablissements dans db.establishments
                                    if (data.establishments && Array.isArray(data.establishments)) {
                                        db.establishments = data.establishments;
                                    } else if (data.teacherInfo && data.teacherInfo.secondaryEstablishments) {
                                        // Migration des anciens √©tablissements secondaires
                                        db.establishments = data.teacherInfo.secondaryEstablishments.map((est, idx) => ({
                                            ...est,
                                            id: est.id || (Date.now().toString() + '_' + idx)
                                        }));
                                    }

                                    // VALIDATION: Verifier que le fichier appartient au proprietaire de la licence
                                    if (!validateDataFileOwner(data)) {
                                        // Rejeter le fichier - ne pas charger les donnees
                                        event.target.value = '';
                                        return;
                                    }

                                    // S√©lectionner la premi√®re mati√®re par d√©faut
                                    currentSubjectId.value = db.classes[0]?.subjects?.[0]?.id || null;
                                    fileName.value = file.name;
                                    fileHandle.value = null; // Pas de handle, t√©l√©chargement manuel uniquement
                                    isDataLoaded.value = true;
                                    await addToRecent(file.name, file.name, null);
                                } else {
                                    alert('Format de fichier invalide');
                                }
                            } catch (e) {
                                console.error(e);
                                alert('Erreur lors de l\'ouverture: ' + e.message);
                            }
                            event.target.value = '';
                        });
                    };

                    // Drag & Drop
                    const handleDragOver = (e) => {
                        e.preventDefault();
                        const dropZone = document.getElementById('dropZone');
                        if (dropZone) dropZone.classList.add('dragover');
                    };

                    const handleDragLeave = (e) => {
                        e.preventDefault();
                        const dropZone = document.getElementById('dropZone');
                        if (dropZone) dropZone.classList.remove('dragover');
                    };

                    const handleDrop = async (e) => {
                        e.preventDefault();
                        const dropZone = document.getElementById('dropZone');
                        if (dropZone) dropZone.classList.remove('dragover');

                        const file = e.dataTransfer.files[0];
                        if (!file) return;

                        if (!file.name.endsWith('.json')) {
                            alert('Veuillez d√©poser un fichier .json');
                            return;
                        }

                        try {
                            const content = await file.text();
                            const data = JSON.parse(content);
                            if (data.classes && Array.isArray(data.classes)) {
                                // VALIDATION: Verifier que le fichier appartient au proprietaire de la licence
                                if (!validateDataFileOwner(data)) {
                                    // Rejeter le fichier
                                    return;
                                }

                                db.classes = data.classes;
                                fileName.value = file.name;
                                fileHandle.value = null;
                                isDataLoaded.value = true;
                                await addToRecent(file.name, file.name, null);
                            } else {
                                alert('Format de fichier invalide');
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Erreur lors de l\'ouverture: ' + err.message);
                        }
                    };

                    // ========== FONCTIONS CAPACITOR NATIF (ANDROID) ==========

                    // Scanner les espaces disponibles sur Android
                    const loadSpaces = async () => {
                        if (!window.Capacitor || !window.Capacitor.isNativePlatform()) return;

                        try {
                            // 1. Cr√©er le dossier 'sgc-teachertrack' s'il n'existe pas dans Documents
                            try {
                                await window.Filesystem.mkdir({
                                    path: 'sgc-teachertrack',
                                    directory: window.Directory.Documents,
                                    recursive: true
                                });
                            } catch (e) { }

                            // 2. Lire le contenu
                            const result = await window.Filesystem.readdir({
                                path: 'sgc-teachertrack',
                                directory: window.Directory.Documents
                            });

                            // 3. Filtrer les .json
                            availableSpaces.value = result.files
                                .filter(f => f.name.endsWith('.json'))
                                .map(f => ({
                                    name: f.name.replace('.json', ''),
                                    path: 'sgc-teachertrack/' + f.name
                                }));

                        } catch (e) {
                            console.error("Erreur chargement espaces:", e);
                        }
                    };

                    // Cr√©er un nouvel espace sur Android
                    const createNewSpace = async () => {
                        // Mode Web classique
                        if (!window.Capacitor?.isNativePlatform()) {
                            createNewFile(); // Appel ancienne fonction web
                            return;
                        }

                        // Mode Android
                        const name = prompt("Nom du nouvel espace (ex: Ann√©e 2025) :");
                        if (!name) return;

                        // V√©rifier qu'une licence valide existe
                        if (!isLicenseValid.value) {
                            alert('Une licence valide est requise pour cr√©er un espace.');
                            return;
                        }

                        const safeName = name.replace(/[^a-z0-9√†√¢√ß√©√®√™√´√Æ√Ø√¥√ª√π√º√ø√±√¶≈ì -]/gi, '_');
                        const fullPath = `sgc-teachertrack/${safeName}.json`;

                        // Extraire le nom et pr√©nom depuis la licence
                        const licenseParts = licenseOwner.value ? licenseOwner.value.split(' ') : [];
                        const teacherLastname = licenseParts.length > 1 ? licenseParts.slice(0, -1).join(' ') : (licenseParts[0] || '');
                        const teacherFirstname = licenseParts.length > 1 ? licenseParts[licenseParts.length - 1] : '';

                        // Structure avec les informations de l'enseignant depuis la licence
                        const emptyDb = {
                            classes: [],
                            teacherInfo: {
                                lastname: teacherLastname,
                                firstname: teacherFirstname
                            },
                            establishments: []
                        };

                        try {
                            // V√©rifier que Filesystem est disponible
                            if (!window.Filesystem || !window.Filesystem.writeFile) {
                                throw new Error('Filesystem non initialis√©. Veuillez red√©marrer l\'application.');
                            }

                            await window.Filesystem.writeFile({
                                path: fullPath,
                                data: JSON.stringify(emptyDb, null, 2),
                                directory: window.Directory.Documents,
                                encoding: window.Encoding.UTF8
                            });

                            await loadSpaces(); // Rafra√Æchir la liste
                            await openSpace(safeName); // Ouvrir direct
                        } catch (e) {
                            alert("Erreur cr√©ation : " + e.message);
                        }
                    };

                    // Ouvrir un espace existant sur Android
                    const openSpace = async (spaceName) => {
                        // GUARDIAN: V√©rifier la licence avant d'ex√©cuter
                        await requireLicense(async () => {
                            try {
                                const contents = await window.Filesystem.readFile({
                                    path: `sgc-teachertrack/${spaceName}.json`,
                                    directory: window.Directory.Documents,
                                    encoding: window.Encoding.UTF8
                                });

                                const data = JSON.parse(contents.data);

                                // Logique de chargement existante
                                if (data.classes) {
                                    if (Array.isArray(data.classes)) data.classes.forEach(cls => migrateSubjects(cls));
                                    db.classes = data.classes;
                                    if (data.teacherInfo) Object.assign(db.teacherInfo, data.teacherInfo);
                                    if (data.establishments) db.establishments = data.establishments;
                                }

                                isDataLoaded.value = true;
                                fileName.value = spaceName;
                                await verifyUserMatchWithLicense();
                            } catch (e) {
                                alert("Impossible d'ouvrir : " + e.message);
                            }
                        });
                    };

                    const createNewFile = async () => {
                        // GUARDIAN: V√©rifier la licence avant d'ex√©cuter
                        await requireLicense(async () => {
                            try {
                                if (!window.showSaveFilePicker) {
                                    alert('Votre navigateur ne supporte pas l\'API File System Access.');
                                    return;
                                }

                                // V√©rifier qu'une licence valide existe
                                if (!isLicenseValid.value) {
                                    alert('Une licence valide est requise pour cr√©er un fichier.');
                                    return;
                                }

                                const handle = await window.showSaveFilePicker({
                                    suggestedName: 'TeacherTrack_' + new Date().toISOString().slice(0, 10) + '.json',
                                    types: [{ description: 'Fichiers TeacherTrack', accept: { 'application/json': ['.json'] } }]
                                });
                                fileHandle.value = handle;
                                fileName.value = handle.name;

                                // Extraire le nom et pr√©nom depuis la licence
                                const licenseParts = licenseOwner.value ? licenseOwner.value.split(' ') : [];
                                db.teacherInfo.lastname = licenseParts.length > 1 ? licenseParts.slice(0, -1).join(' ') : (licenseParts[0] || '');
                                db.teacherInfo.firstname = licenseParts.length > 1 ? licenseParts[licenseParts.length - 1] : '';

                                db.classes = [];
                                isDataLoaded.value = true;
                                await addToRecent(handle.name, handle.name, handle);
                                await verifyUserMatchWithLicense();
                            } catch (e) {
                                if (e.name !== 'AbortError') { console.error(e); alert('Erreur: ' + e.message); }
                            }
                        });
                    };

                    const openRecentFile = async (file) => {
                        // GUARDIAN: V√©rifier la licence avant d'ex√©cuter
                        await requireLicense(async () => {
                            try {
                                if (file.handle) {
                                    // Tenter de rouvrir avec le handle stock√©
                                    await loadFromHandle(file.handle, file.name);
                                } else {
                                    // Fallback: ouvrir via s√©lecteur
                                    const [handle] = await window.showOpenFilePicker({
                                        types: [{ description: 'Fichiers TeacherTrack', accept: { 'application/json': ['.json'] } }]
                                    });
                                    await loadFromHandle(handle, file.name);
                                }
                            } catch (e) {
                                if (e.name !== 'AbortError') { alert('Erreur: ' + e.message); }
                            }
                        });
                    };

                    const saveFile = async () => {
                        // --- CAS 1 : ANDROID (APK) ---
                        // On √©crit silencieusement dans le dossier Documents/sgc-teachertrack
                        if (window.Capacitor?.isNativePlatform()) {
                            try {
                                const fileNameToSave = fileName.value || 'classe_sans_nom';
                                await window.Filesystem.writeFile({
                                    path: `sgc-teachertrack/${fileNameToSave}.json`,
                                    data: JSON.stringify(db, null, 2),
                                    directory: window.Directory.Documents,
                                    encoding: window.Encoding.UTF8
                                });
                                hasUnsavedChanges.value = false;
                                alert("Sauvegard√© sur le mobile !");
                            } catch (e) {
                                alert("Erreur Mobile : " + e.message);
                            }
                            return;
                        }

                        // --- CAS 2 : DESKTOP (Web Moderne - Chrome/Edge) ---
                        // On √©crase le fichier ouvert via l'API File System Access
                        if (fileHandle.value) {
                            try {
                                const writable = await fileHandle.value.createWritable();
                                await writable.write(JSON.stringify(db, null, 2));
                                await writable.close();
                                hasUnsavedChanges.value = false;
                                console.log('Sauvegard√© sur le PC (√âcrasement)');
                            } catch (e) {
                                console.error(e);
                                alert("Erreur PC : " + e.message);
                            }
                            return;
                        }

                        // --- CAS 3 : FALLBACK (Firefox / Safari / Anciens fichiers) ---
                        // On d√©clenche un t√©l√©chargement
                        const data = JSON.stringify(db, null, 2);
                        const blob = new Blob([data], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName.value || 'teachertrack.json';
                        a.click();
                        URL.revokeObjectURL(url);
                        hasUnsavedChanges.value = false;
                    };

                    const closeFile = () => {
                        if (hasUnsavedChanges.value) {
                            const action = confirm('Des modifications n\'ont pas √©t√© sauvegard√©es.\n\nCliquez sur OK pour sauvegarder avant de fermer, ou Annuler pour fermer sans sauvegarder.');
                            if (action) {
                                saveFile();
                            }
                        }
                        if (!hasUnsavedChanges.value || !fileHandle.value) {
                            if (!hasUnsavedChanges.value || confirm('Fermer sans sauvegarder ?')) {
                                isDataLoaded.value = false;
                                db.classes = [];
                                fileHandle.value = null;
                                fileName.value = '';
                                hasUnsavedChanges.value = false;
                            }
                        }
                    };

                    // Classes
                    const addClass = () => {
                        if (!newClassName.value) return;
                        const subjectName = newClassSubject.value.trim() || t('main_subject');
                        // Utiliser l'ID en attente si disponible, sinon g√©n√©rer un nouveau
                        const newClassId = pendingClassIdForEstablishment.value || Date.now().toString();

                        db.classes.push({
                            id: newClassId,
                            name: newClassName.value,
                            subjects: [{
                                id: Date.now().toString() + '_sub',
                                name: subjectName
                            }],
                            students: [],
                            exams: [],
                            attendance: {},
                            planner: []
                        });

                        // Assigner la classe √† l'√©tablissement s√©lectionn√©
                        if (newClassEstablishmentId.value) {
                            const est = db.establishments.find(e => e.id === newClassEstablishmentId.value);
                            if (est) {
                                if (!est.classes) est.classes = [];
                                if (!est.classes.includes(newClassId)) {
                                    est.classes.push(newClassId);
                                }
                            }
                        }

                        // R√©initialiser le formulaire
                        newClassName.value = '';
                        newClassSubject.value = '';
                        newClassEstablishmentId.value = '';
                        pendingClassIdForEstablishment.value = null;
                        currentClassIndex.value = db.classes.length - 1;
                        // S√©lectionner la premi√®re mati√®re de la nouvelle classe
                        currentSubjectId.value = db.classes[currentClassIndex.value].subjects[0].id;
                    };

                    // √âl√®ves
                    const resetStudentForm = () => {
                        newStudent.firstname = '';
                        newStudent.lastname = '';
                        newStudent.student_id = '';
                        newStudent.birthdate = '';
                        newStudent.address = '';
                        newStudent.phone = '';
                        newStudent.parent_father = '';
                        newStudent.parent_father_email = '';
                        newStudent.parent_mother = '';
                        newStudent.parent_mother_email = '';
                        newStudent.photo = '';
                    };

                    const addStudent = () => {
                        if (!newStudent.lastname) return;
                        currentClass.value.students.push({
                            id: Date.now().toString(),
                            student_id: newStudent.student_id,
                            firstname: newStudent.firstname,
                            lastname: newStudent.lastname,
                            birthdate: newStudent.birthdate,
                            address: newStudent.address,
                            phone: newStudent.phone,
                            parent_father: newStudent.parent_father,
                            parent_father_email: newStudent.parent_father_email,
                            parent_mother: newStudent.parent_mother,
                            parent_mother_email: newStudent.parent_mother_email,
                            photo: newStudent.photo,
                            grades: {}
                        });
                        resetStudentForm();
                        showStudentModal.value = false;
                    };

                    const deleteStudent = (idx) => {
                        if (confirm(t('confirm_delete_student'))) currentClass.value.students.splice(idx, 1);
                    };

                    // Gestion des photos
                    const handlePhotoUpload = (event) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        // V√©rifier le type de fichier
                        if (!file.type.match(/image\/(jpeg|png|jpg)/)) {
                            alert('Veuillez s√©lectionner une image JPG ou PNG');
                            return;
                        }

                        // V√©rifier la taille (2Mo max)
                        if (file.size > 2097152) {
                            alert('L\'image est trop volumineuse. Maximum 2Mo requis.');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            newStudent.photo = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    };

                    const removeStudentPhoto = () => {
                        newStudent.photo = '';
                    };

                    const handleDetailPhotoUpload = (event, student) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        if (!file.type.match(/image\/(jpeg|png|jpg)/)) {
                            alert('Veuillez s√©lectionner une image JPG ou PNG');
                            return;
                        }

                        if (file.size > 2097152) {
                            alert('L\'image est trop volumineuse. Maximum 2Mo requis.');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            student.photo = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    };

                    const removeDetailPhoto = (student) => {
                        student.photo = '';
                    };

                    const importExcel = (event) => {
                        const file = event.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                                // Utiliser header: 1 pour obtenir des tableaux, pas des objets
                                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                                console.log('Total rows:', rows.length);
                                console.log('First 10 rows:');
                                for (let i = 0; i < Math.min(rows.length, 10); i++) {
                                    console.log(`Row ${i}:`, rows[i]);
                                }

                                // Trouver la ligne avec les donn√©es √©l√®ves (skip lignes d'en-t√™te)
                                let dataStartIndex = 0;
                                for (let i = 0; i < Math.min(rows.length, 20); i++) {
                                    const row = rows[i];
                                    // Si la premi√®re cellule contient un matricule (num√©rique)
                                    const firstCell = row && row[0] ? String(row[0]).trim() : '';
                                    console.log(`Row ${i}: firstCell="${firstCell}" isNumeric=${/^\d+$/.test(firstCell)}`);

                                    if (firstCell.length > 10 && /^\d+$/.test(firstCell)) {
                                        dataStartIndex = i;
                                        console.log('Data starts at row', i);
                                        break;
                                    }
                                }

                                let count = 0;
                                for (let i = dataStartIndex; i < rows.length; i++) {
                                    const row = rows[i];
                                    if (!row || row.length < 4) continue;

                                    const matricule = String(row[0] || '').trim();
                                    const lastname = String(row[1] || '').trim();
                                    const firstname = String(row[2] || '').trim();
                                    const birthdate = String(row[3] || '').trim();

                                    console.log(`Row ${i}: mat="${matricule}" nom="${lastname}" prenom="${firstname}"`);

                                    // Skip les lignes d'en-t√™te et les lignes vides
                                    if (matricule && matricule !== 'matricule' && matricule !== 'ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ' &&
                                        (lastname || firstname) && lastname !== 'ÿßŸÑŸÑŸÇÿ®') {
                                        currentClass.value.students.push({
                                            id: Date.now().toString() + Math.random(),
                                            student_id: matricule,
                                            firstname: firstname,
                                            lastname: lastname,
                                            birthdate: birthdate,
                                            address: '',
                                            phone: '',
                                            parent_father: '',
                                            parent_mother: '',
                                            photo: '',
                                            grades: {}
                                        });
                                        count++;
                                    }
                                }
                                alert(t('import_success', count));
                            } catch (e) { alert('Erreur: ' + e.message); console.error(e); }
                        };
                        reader.readAsArrayBuffer(file);
                    };

                    // √âvaluations
                    const addExam = () => {
                        if (!newExam.name) return;
                        // Utiliser la mati√®re active ou la premi√®re mati√®re
                        const subjectId = currentSubjectId.value || currentClass.value.subjects?.[0]?.id;
                        // Utiliser le premier trimestre par d√©faut si aucun s√©lectionn√©
                        const trimesterId = newExam.trimesterId || currentClass.value.trimesters?.[0]?.id || 'tri1';
                        currentClass.value.exams.push({
                            id: Date.now().toString(),
                            name: newExam.name,
                            max: newExam.max,
                            coeff: newExam.coeff,
                            subjectId: subjectId,
                            trimesterId: trimesterId
                        });
                        newExam.name = '';
                        newExam.max = 20;
                        newExam.coeff = 1;
                        newExam.subjectId = '';
                        newExam.trimesterId = '';
                        showExamModal.value = false;
                    };

                    // Moyennes
                    const calculateAverage = (student) => {
                        if (!filteredExams.value.length) return '-';
                        let total = 0, coefTotal = 0;
                        filteredExams.value.forEach(exam => {
                            const grade = student.grades[exam.id];
                            if (grade !== undefined && grade !== null && grade !== '') {
                                total += (grade / exam.max) * 10 * exam.coeff;
                                coefTotal += exam.coeff;
                            }
                        });
                        return coefTotal === 0 ? '-' : (total / coefTotal).toFixed(2);
                    };

                    // Moyenne par trimestre
                    const calculateTrimesterAverage = (student, trimesterId) => {
                        const trimesterExams = filteredExams.value.filter(e => e.trimesterId === trimesterId);
                        if (!trimesterExams.length) return '-';

                        let total = 0, coefTotal = 0;
                        trimesterExams.forEach(exam => {
                            const grade = student.grades[exam.id];
                            if (grade !== undefined && grade !== null && grade !== '') {
                                total += (grade / exam.max) * 10 * exam.coeff;
                                coefTotal += exam.coeff;
                            }
                        });
                        return coefTotal === 0 ? '-' : (total / coefTotal).toFixed(2);
                    };

                    // Moyenne annuelle (moyenne des moyennes trimestrielles)
                    const calculateAnnualAverage = (student) => {
                        const trimesters = currentClass.value?.trimesters || [];
                        if (!trimesters.length) return '-';

                        let total = 0, count = 0;
                        trimesters.forEach(tri => {
                            const triAvg = calculateTrimesterAverage(student, tri.id);
                            if (triAvg !== '-') {
                                total += parseFloat(triAvg);
                                count++;
                            }
                        });
                        return count === 0 ? '-' : (total / count).toFixed(2);
                    };

                    // Compter le nombre d'examens pour un trimestre donn√©
                    const getTrimesterExamCount = (trimesterId) => {
                        return filteredExams.value.filter(e => e.trimesterId === trimesterId).length;
                    };

                    // Observation pour un trimestre
                    const promptObservation = (student, tri) => {
                        const currentObs = getTrimesterObservation(student, tri.id);
                        const newObs = prompt(t('trimester_observation') + ' - ' + tri.name, currentObs);
                        if (newObs !== null) {
                            setTrimesterObservation(student, tri.id, newObs);
                        }
                    };

                    const getGradeBadgeClass = (student) => {
                        const avg = calculateAverage(student);
                        if (avg === '-') return 'bg-slate-100 text-slate-500 px-2 py-1 rounded text-sm font-medium';
                        const n = parseFloat(avg);
                        if (n < 5) return 'bg-red-100 text-red-700 px-2 py-1 rounded text-sm font-medium';
                        if (n < 7) return 'bg-amber-100 text-amber-700 px-2 py-1 rounded text-sm font-medium';
                        return 'bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-sm font-medium';
                    };

                    // Fonctions pour les d√©tails √©l√®ve
                    const getSubjectName = (subjectId) => {
                        return currentClass.value?.subjects?.find(s => s.id === subjectId)?.name || 'Inconnue';
                    };

                    const getStudentSubjectAverage = (student) => {
                        if (!filteredExams.value.length) return '-';
                        let total = 0, coefTotal = 0;
                        filteredExams.value.forEach(exam => {
                            const grade = student.grades[exam.id];
                            if (grade !== undefined && grade !== null && grade !== '') {
                                total += (grade / exam.max) * 10 * exam.coeff;
                                coefTotal += exam.coeff;
                            }
                        });
                        return coefTotal === 0 ? '-' : (total / coefTotal).toFixed(2);
                    };

                    const getStudentGradeClass = (student, exam) => {
                        const grade = student.grades[exam.id];
                        if (grade === undefined || grade === null || grade === '') return 'text-slate-400';
                        const normalized = grade / exam.max;
                        if (normalized < 0.5) return 'bg-red-100 text-red-700 px-2 py-1 rounded font-medium';
                        if (normalized < 0.7) return 'bg-amber-100 text-amber-700 px-2 py-1 rounded font-medium';
                        return 'bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-medium';
                    };

                    const getStudentAttendance = (student) => {
                        if (!student) return {};
                        const id = typeof student === 'object' ? student.id : student;
                        if (!id) return {};
                        return currentClass.value?.attendance?.[id] || {};
                    };

                    const formatDateShort = (dateStr) => {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        const locale = currentLang.value === 'ar' ? 'ar-EG' : 'fr-FR';
                        let formatted = date.toLocaleDateString(locale, { day: '2-digit', month: '2-digit' });
                        // Convertir les chiffres arabes en chiffres normaux
                        if (currentLang.value === 'ar') {
                            formatted = formatted.replace(/[Ÿ†-Ÿ©]/g, d => 'Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©'.indexOf(d));
                        }
                        return formatted;
                    };

                    const formatDateFull = (dateStr) => {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        const locale = currentLang.value === 'ar' ? 'ar-EG' : 'fr-FR';
                        let formatted = date.toLocaleDateString(locale, { day: '2-digit', month: '2-digit', year: 'numeric' });
                        // Convertir les chiffres arabes en chiffres normaux
                        if (currentLang.value === 'ar') {
                            formatted = formatted.replace(/[Ÿ†-Ÿ©]/g, d => 'Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©'.indexOf(d));
                        }
                        return formatted;
                    };

                    const getAttendanceCount = (student, type) => {
                        if (!student) return 0;
                        const id = typeof student === 'object' ? student.id : student;
                        if (!id) return 0;
                        const att = currentClass.value?.attendance || {};
                        let count = 0;
                        Object.values(att).forEach(day => { if (day[id] === type) count++; });
                        return count;
                    };

                    // Pr√©sences
                    const setAttendance = (studentId, status) => {
                        if (!currentClass.value.attendance[attendanceDate.value]) currentClass.value.attendance[attendanceDate.value] = {};
                        const current = currentClass.value.attendance[attendanceDate.value][studentId];
                        if (current === status) delete currentClass.value.attendance[attendanceDate.value][studentId];
                        else currentClass.value.attendance[attendanceDate.value][studentId] = status;
                    };

                    const getAttendanceClass = (studentId, status) => {
                        const current = currentClass.value.attendance[attendanceDate.value]?.[studentId];
                        if (status === 'present') return current === 'present' ? 'text-white border-emerald-600' : 'text-slate-400 border-slate-200';
                        if (status === 'absent') return current === 'absent' ? 'text-white border-red-600' : 'text-slate-400 border-slate-200';
                        if (status === 'late') return current === 'late' ? 'text-white border-amber-600' : 'text-slate-400 border-slate-200';
                        return 'text-slate-400 border-slate-200';
                    };

                    const getAttendanceStyle = (studentId, status) => {
                        const current = currentClass.value.attendance[attendanceDate.value]?.[studentId];
                        if (status === 'present' && current === 'present') return { backgroundColor: '#10b981' };
                        if (status === 'absent' && current === 'absent') return { backgroundColor: '#ef4444' };
                        if (status === 'late' && current === 'late') return { backgroundColor: '#f59e0b' };
                        return { backgroundColor: '#ffffff' };
                    };

                    // Appr√©ciations journali√®res
                    const setAppreciation = (studentId, type) => {
                        if (!currentClass.value.appreciations) currentClass.value.appreciations = {};
                        if (!currentClass.value.appreciations[attendanceDate.value]) currentClass.value.appreciations[attendanceDate.value] = {};
                        const current = currentClass.value.appreciations[attendanceDate.value][studentId];
                        if (current === type) delete currentClass.value.appreciations[attendanceDate.value][studentId];
                        else currentClass.value.appreciations[attendanceDate.value][studentId] = type;
                    };

                    const getAppreciationCount = (student, type) => {
                        if (!student) return 0;
                        const id = typeof student === 'object' ? student.id : student;
                        if (!id) return 0;
                        const app = currentClass.value?.appreciations || {};
                        let count = 0;
                        Object.values(app).forEach(day => { if (day[id] === type) count++; });
                        return count;
                    };

                    const getAppreciationClass = (studentId, type) => {
                        const current = currentClass.value.appreciations?.[attendanceDate.value]?.[studentId];
                        if (type === 'star') return current === 'star' ? 'text-yellow-500 border-yellow-500 bg-yellow-50' : 'text-slate-300 border-slate-200';
                        if (type === 'stop') return current === 'stop' ? 'text-red-500 border-red-500 bg-red-50' : 'text-slate-300 border-slate-200';
                        return 'text-slate-300 border-slate-200';
                    };

                    const getAppreciationIcon = (studentId, type) => {
                        const current = currentClass.value.appreciations?.[attendanceDate.value]?.[studentId];
                        if (type === 'star') return current === 'star' ? 'fa-star text-yellow-500' : 'fa-star text-slate-300';
                        if (type === 'stop') return current === 'stop' ? 'fa-stop text-red-500' : 'fa-stop text-slate-300';
                        return 'fa-star text-slate-300';
                    };

                    // Planning
                    const addPlannerItem = () => {
                        currentClass.value.planner.push({ date: new Date().toISOString().split('T')[0], title: '', content: '' });
                    };

                    const deletePlannerItem = (idx) => { currentClass.value.planner.splice(idx, 1); };

                    // Export
                    const exportToExcel = () => {
                        if (!currentClass.value) return;
                        const rows = [['Nom', 'Pr√©nom', 'Moyenne']];
                        currentClass.value.exams.forEach(ex => { rows[0].push(ex.name + ' (/' + ex.max + ')'); });
                        currentClass.value.students.forEach(s => {
                            const row = [s.lastname, s.firstname, calculateAverage(s)];
                            currentClass.value.exams.forEach(ex => { row.push(s.grades[ex.id] || ''); });
                            rows.push(row);
                        });
                        const ws = XLSX.utils.aoa_to_sheet(rows);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'Notes');
                        XLSX.writeFile(wb, 'Notes_' + currentClass.value.name + '.xlsx');
                    };

                    // Export format officiel (document de relev√© de notes)
                    const exportGradesToExcel = () => {
                        if (!currentClass.value) return;

                        const isRTL = exportFormat.value === 'rtl';
                        const trimestersList = Array.isArray(currentTrimesters.value) ? currentTrimesters.value : [];
                        const selectedTriName = selectedTrimesterExport.value
                            ? trimestersList.find(t => t.id === selectedTrimesterExport.value)?.name || ''
                            : '';
                        const trimesterExams = selectedTrimesterExport.value
                            ? currentClass.value.exams.filter(e => e.trimesterId === selectedTrimesterExport.value)
                            : currentClass.value.exams;

                        let rows = [];

                        // En-t√™tes officiels - Version Arabe ou Fran√ßaise
                        // Les 2 versions utilisent les valeurs configurables dans "Mes Infos"
                        if (isRTL) {
                            // Version Arabe: Utiliser les valeurs du JSON (√©ditables dans Mes Infos)
                            // Ligne 1: R√©publique (sans le chiffre)
                            rows.push([db.teacherInfo.fieldRepublic ? db.teacherInfo.fieldRepublic.replace(/^\d+-\s*/, '') : '', null, null, null, null, null, null, null, null]);
                            // Ligne 2: Minist√®re (sans le chiffre)
                            rows.push([db.teacherInfo.fieldMinistry ? db.teacherInfo.fieldMinistry.replace(/^\d+-\s*/, '') : '', null, null, null, null, null, null, null, null]);
                            // Ligne 3: Direction + Wilaya (sans le chiffre)
                            const directionAr = db.teacherInfo.fieldDirectorate ? db.teacherInfo.fieldDirectorate.replace(/^\d+-\s*/, '') : '';
                            rows.push([directionAr, null, null, null, null, null, null, null, null]);

                            // Ligne 4: √âtablissement
                            const establishmentName = getEstablishmentName(db.teacherInfo.mainEstablishment);
                            rows.push([establishmentName || '', null, null, null, null, null, null, null, null]);

                            // Ligne 5: Titre document + Classe + Mati√®re + Ann√©e (Arabe)
                            const classInfo = `Ÿàÿ´ŸäŸÇÿ© ÿ≠ÿ¨ÿ≤ ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÄ:${selectedTriName} ${t('school_year')}:${db.teacherInfo.schoolYear || ''} ÿßŸÑŸÅŸàÿ¨ ÿßŸÑÿ™ÿ±ÿ®ŸàŸä :${currentClass.value.name} ŸÖÿßÿØÿ© :${currentSubject?.name || ''}`;
                            rows.push([classInfo, null, null, null, null, null, null, null, null]);

                            // En-t√™tes colonnes arabes uniquement (ordre invers√© pour affichage RTL)
                            const examHeaders = trimesterExams.map(ex => `${ex.name} /${ex.max}`);
                            // En RTL: la premi√®re colonne (A) est √† DROITE, donc on inverse l'ordre
                            const headerRowAr = ['ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™', ...examHeaders.map(h => h.replace('/', ' /')).reverse(), 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ', 'ÿßŸÑÿßÿ≥ŸÖ', 'ÿßŸÑŸÑŸÇÿ®', 'ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ'].reverse();
                            rows.push(headerRowAr);
                        } else {
                            // Version Fran√ßaise: Utiliser les valeurs de l'utilisateur (√©ditables)
                            // Ligne 1: R√©publique
                            rows.push([db.teacherInfo.fieldRepublic ? db.teacherInfo.fieldRepublic.replace(/^\d+-\s*/, '') : '', null, null, null, null, null, null, null, null]);
                            // Ligne 2: Minist√®re
                            rows.push([db.teacherInfo.fieldMinistry ? db.teacherInfo.fieldMinistry.replace(/^\d+-\s*/, '') : '', null, null, null, null, null, null, null, null]);
                            // Ligne 3: Direction + Wilaya
                            const directionFr = db.teacherInfo.fieldDirectorate ? db.teacherInfo.fieldDirectorate.replace(/^\d+-\s*/, '') : '';
                            rows.push([directionFr, null, null, null, null, null, null, null, null]);

                            // Ligne 4: √âtablissement
                            const establishmentName = getEstablishmentName(db.teacherInfo.mainEstablishment);
                            rows.push([establishmentName || '', null, null, null, null, null, null, null, null]);

                            // Ligne 5: Classe + Mati√®re + Ann√©e
                            const classInfo = `${currentClass.value.name} - ${currentSubject?.name || ''} - ${t('school_year')}: ${db.teacherInfo.schoolYear || ''}`;
                            rows.push([classInfo, null, null, null, null, null, null, null, null]);

                            // Ligne 6: Titre du document
                            let title = `Relev√© de notes - ${selectedTriName || 'Tous'}`;
                            rows.push([title, null, null, null, null, null, null, null, null]);

                            const examHeaders = trimesterExams.map(ex => `${ex.name} /${ex.max}`);
                            const headerRow = ['Matricule', 'Nom', 'Pr√©nom', 'Date de naissance', ...examHeaders, 'Observations'];
                            rows.push(headerRow);
                        }

                        // Donn√©es √©l√®ves
                        // Pour RTL: inverser l'ordre des √©l√®ves pour que le remplissage se fasse de droite √† gauche
                        const studentsToExport = isRTL
                            ? [...currentClass.value.students].reverse()
                            : currentClass.value.students;

                        studentsToExport.forEach(s => {
                            let studentRow;

                            if (isRTL) {
                                // Pour RTL: construire la ligne dans l'ordre inverse
                                // Le matricule doit √™tre en premier (colonne A) pour appara√Ætre √† DROITE en mode RTL
                                const examGrades = trimesterExams.map(ex => s.grades[ex.id] !== undefined ? s.grades[ex.id] : '');
                                const observation = selectedTrimesterExport.value
                                    ? (s.trimesterObservations?.[selectedTrimesterExport.value] || '')
                                    : '';
                                // Ordre: matricule, nom, prenom, date_n, exam1, exam2, exam3, obs
                                // Avec RTL: A=matricule (droite), H=obs (gauche)
                                studentRow = [
                                    s.student_id || '',
                                    s.lastname || '',
                                    s.firstname || '',
                                    s.birthdate || '',
                                    ...examGrades,
                                    observation
                                ];
                            } else {
                                // Format Occidental
                                studentRow = [s.student_id || '', s.lastname || '', s.firstname || '', s.birthdate || ''];
                                trimesterExams.forEach(ex => {
                                    studentRow.push(s.grades[ex.id] !== undefined ? s.grades[ex.id] : '');
                                });
                                const observation = selectedTrimesterExport.value
                                    ? (s.trimesterObservations?.[selectedTrimesterExport.value] || '')
                                    : '';
                                studentRow.push(observation);
                            }
                            rows.push(studentRow);
                        });

                        // Cr√©er la feuille
                        const ws = XLSX.utils.aoa_to_sheet(rows);

                        // Appliquer le style (gras et centrage) aux 5 premi√®res lignes d'en-t√™te
                        // Note: js-xlsx free a des limitations pour le style, mais on essaie d'ajouter ce qui est possible
                        const headerRowCount = 5;
                        for (let r = 0; r < headerRowCount; r++) {
                            for (let c = 0; c <= 8; c++) {
                                const cellRef = XLSX.utils.encode_cell({ r: r, c: c });
                                if (ws[cellRef]) {
                                    // Style gras
                                    ws[cellRef].s = {
                                        font: { bold: true },
                                        alignment: { horizontal: 'center', vertical: 'center' }
                                    };
                                }
                            }
                        }

                        // D√©finir les largeurs de colonnes (l'ordre des largeurs doit correspondre √† l'ordre des donn√©es)
                        // Pour RTL: les largeurs doivent √™tre dans le m√™me ordre que les donn√©es
                        const colWidths = isRTL
                            ? [
                                { wch: 20 }, // matricule (colonne de droite visuellement en RTL)
                                { wch: 15 }, // nom
                                { wch: 15 }, // prenom
                                { wch: 15 }, // date_n
                                ...Array(trimesterExams.length || 3).fill({ wch: 25 }), // examens
                                { wch: 30 }  // obs (colonne de gauche visuellement en RTL)
                            ]
                            : [
                                { wch: 20 }, // matricule
                                { wch: 15 }, // nom
                                { wch: 15 }, // prenom
                                { wch: 15 }, // date_n
                                ...Array(trimesterExams.length || 3).fill({ wch: 25 }), // examens
                                { wch: 30 }  // obs
                            ];
                        ws['!cols'] = colWidths;

                        // Fusionner les cellules des premi√®res lignes d'en-t√™te officiel
                        // Les 5 premi√®res lignes sont fusionn√©es horizontalement (A1:I5)
                        // La ligne des en-t√™tes de colonnes n'est PAS fusionn√©e
                        const headerRowsToMerge = 5;
                        const merges = [];
                        for (let r = 0; r < headerRowsToMerge; r++) {
                            merges.push({ s: { r: r, c: 0 }, e: { r: r, c: 8 } });
                        }
                        ws['!merges'] = merges;

                        // Pour le format Arabe: appliquer la direction RTL √† Excel
                        // Cela inverse l'affichage des colonnes A,B,C... pour qu'elles apparaissent de droite √† gauche
                        if (isRTL) {
                            ws['!view'] = { rightToLeft: true };
                        }

                        // Cr√©er le workbook et activer les styles
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'Notes');

                        // Activer les styles si disponible
                        if (wb && !wb.props) wb.props = {};
                        wb.props.cellStyles = true;

                        // Configurer les vues du workbook pour RTL (inverse l'ordre des lettres de colonnes)
                        if (isRTL) {
                            // D√©finir explicitement les propri√©t√©s du workbook pour RTL
                            wb.Workbook = {
                                AppName: 'SheetJS',
                                CreatedDate: new Date(),
                                ModifiedDate: new Date(),
                                Views: [{
                                    RTL: true,
                                    xWindow: 0,
                                    yWindow: 0,
                                    windowWidth: 25600,
                                    windowHeight: 14400,
                                    activeCell: 'A1',
                                    firstSheet: 0,
                                    tabRatio: 600
                                }],
                                WorkbookView: {
                                    RTL: true
                                }
                            };
                        }

                        const formatSuffix = isRTL ? 'Arabe' : 'Occidental';
                        const trimesterName = selectedTrimesterExport.value
                            ? trimestersList.find(t => t.id === selectedTrimesterExport.value)?.name || ''
                            : 'Tous';
                        XLSX.writeFile(wb, `Notes_${currentClass.value.name}_${trimesterName}_${formatSuffix}.xlsx`);

                        // Fermer le modal et r√©initialiser
                        showExportModal.value = false;
                        selectedTrimesterExport.value = '';
                        exportFormat.value = 'rtl';
                    };

                    const formatDate = (dateStr) => {
                        const date = new Date(dateStr);
                        const locale = currentLang.value === 'ar' ? 'ar-EG' : 'fr-FR';
                        let formatted = date.toLocaleDateString(locale, { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                        // Convertir les chiffres arabes en chiffres normaux
                        if (currentLang.value === 'ar') {
                            formatted = formatted.replace(/[Ÿ†-Ÿ©]/g, d => 'Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©'.indexOf(d));
                        }
                        return formatted;
                    };

                    // Mettre √† jour la mati√®re active quand on change de classe
                    const updateSubjectForClass = () => {
                        if (currentClass.value?.subjects?.length > 0) {
                            // Essayer de garder la m√™me mati√®re si elle existe dans la nouvelle classe
                            const hasCurrentSubject = currentClass.value.subjects.some(s => s.id === currentSubjectId.value);
                            if (!hasCurrentSubject) {
                                currentSubjectId.value = currentClass.value.subjects[0].id;
                            }
                        } else {
                            currentSubjectId.value = null;
                        }
                    };

                    onMounted(async () => {
                        // Fonction d'initialisation principale
                        const initApp = async () => {
                            // SI ANDROID : D√©tecter la plateforme
                            isNative.value = window.Capacitor?.isNativePlatform() || false;

                            // SI ANDROID : Demander les permissions de stockage
                            if (isNative.value && window.Filesystem) {
                                try {
                                    const permStatus = await window.Filesystem.requestPermissions();
                                    console.log('üì± Permissions stockage:', permStatus);
                                } catch (permErr) {
                                    console.warn('‚ö†Ô∏è Permissions non disponibles:', permErr);
                                }
                            }

                            // Scanner/charger la licence (fichier .txt sur Android ou localStorage sur Desktop)
                            const savedLicense = await scanForLicenseFile();
                            if (savedLicense) {
                                await verifyLicense(savedLicense);
                            }

                            // Si pas de licence valide, ouvrir le modal
                            if (!isLicenseValid.value) {
                                showLicenseModal.value = true;
                            }

                            // SI ANDROID : Charger le gestionnaire d'espaces
                            if (isNative.value) {
                                await loadSpaces(); // Scanne le dossier sgc-teachertrack
                            }

                            // SI PC : Charger l'historique classique
                            else {
                                await loadRecentFiles();
                            }

                            console.log('TeacherTrack initialis√© (Mode Hybride)');
                        };

                        // Attendre que Capacitor soit pr√™t (si en mode natif)
                        if (window.CapacitorReady) {
                            // D√©j√† pr√™t, initialiser imm√©diatement
                            await initApp();
                        } else if (window.Capacitor?.isNativePlatform && !window.CapacitorReady) {
                            // Attendre l'√©v√©nement capacitor-ready
                            window.addEventListener('capacitor-ready', async () => {
                                console.log('üì± Capacitor ready, initialisation...');
                                await initApp();
                            }, { once: true });

                            // Fallback: si apr√®s 2 secondes toujours pas pr√™t, initialiser quand m√™me
                            setTimeout(async () => {
                                if (!window.CapacitorReady) {
                                    console.warn('‚ö†Ô∏è Capacitor timeout, tentative d\'initialisation...');
                                    await initApp();
                                }
                            }, 2000);
                        } else {
                            // Mode Desktop, pas besoin d'attendre
                            await initApp();
                        }

                        // Handler pour eviter l'ecran blanc lors du retour a l'app
                        document.addEventListener('visibilitychange', async () => {
                            if (document.visibilityState === 'visible') {
                                console.log('üì± App resumed - visibility restored');
                                // Forcer un re-render en touchant une variable r√©active
                                if (isNative.value && !isDataLoaded.value) {
                                    await loadSpaces();
                                }
                            }
                        });
                    });

                    // Watch pour d√©tecter les modifications non sauvegard√©es
                    watch(() => db.classes, () => {
                        if (isDataLoaded.value) {
                            hasUnsavedChanges.value = true;
                        }
                    }, { deep: true });

                    // Watch pour d√©tecter les modifications des informations de l'enseignant
                    watch(() => db.teacherInfo, () => {
                        if (isDataLoaded.value) {
                            hasUnsavedChanges.value = true;
                        }
                    }, { deep: true });

                    // Watch pour d√©tecter les modifications des √©tablissements
                    watch(() => db.establishments, () => {
                        if (isDataLoaded.value) {
                            hasUnsavedChanges.value = true;
                        }
                    }, { deep: true });

                    // Watch pour changer de mati√®re quand on change de classe
                    watch(currentClassIndex, updateSubjectForClass);

                    // NOTE: L'ancien watch sur isLicenseValid a √©t√© supprim√©
                    // La nouvelle logique utilise validateDataFileOwner() qui rejette
                    // le fichier de donn√©es si le propri√©taire ne correspond pas,
                    // au lieu d'invalider la licence.

                    return {
                        isDataLoaded, db, currentClassIndex, currentTab, fileName,
                        showStudentModal, showExamModal, showClassModal, showSubjectModal, showScanModal, showTrimesterModal, showEstablishmentModal, showClassEstablishmentModal, showExportModal,
                        newStudent, newExam, newTrimester, newClassName, newClassSubject, newClassEstablishmentId, newSubjectName, attendanceDate, newEstablishment, selectedTrimesterExport, exportFormat,
                        currentSubjectId, selectedStudent,
                        recentFiles, scannedFiles, tabs, availableSpaces, isNative,
                        currentClass, currentSubjects, currentSubject, filteredExams, sortedPlanner, classStats, getCurrentClassEstablishment,
                        openFilePicker, loadFileFromInput, createNewFile, createNewSpace, openSpace, openRecentFile, saveFile, closeFile,
                        scanFolder, openScannedFile, formatSize, loadSpaces,
                        handleDragOver, handleDragLeave, handleDrop,
                        addToRecent, removeFromRecent, clearRecentFiles,
                        addClass, addStudent, deleteStudent, importExcel, resetStudentForm,
                        addExam, calculateAverage, calculateTrimesterAverage, calculateAnnualAverage, getTrimesterExamCount, getGradeBadgeClass, promptObservation,
                        setAttendance, getAttendanceClass, getAttendanceStyle, getAttendanceCount,
                        setAppreciation, getAppreciationCount, getAppreciationClass, getAppreciationIcon,
                        addPlannerItem, deletePlannerItem,
                        addSubject, deleteSubject, selectSubject, assignClassToEstablishment,
                        currentTrimesters,
                        editTrimester, deleteTrimester, saveTrimester, resetTrimesterForm,
                        getTrimesterObservation, setTrimesterObservation,
                        getSubjectName, getStudentSubjectAverage, getStudentGradeClass, getStudentAttendance, formatDateShort, formatDateFull,
                        exportToExcel, formatDate, hasUnsavedChanges,
                        exportGradesToExcel,
                        currentLang, setLang, t,
                        handlePhotoUpload, removeStudentPhoto, handleDetailPhotoUpload, removeDetailPhoto,
                        searchQuery, searchPlanningQuery, filteredStudents, filteredPlanner,
                        openEstablishmentModal, saveEstablishment, deleteEstablishment, resetEstablishmentForm, getEstablishmentClasses,
                        getEstablishmentName,
                        // Licence
                        showLicenseModal, licenseInput, licenseError, isLicenseValid, licenseOwner,
                        verifyLicense, verifyUserMatchWithLicense, cancelLicenseModal, importLicenseFile
                    };
                }
            }).mount('#app');
        } // Fin de initApp()

        // Enregistrement du Service Worker PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('./sw.js')
                    .then(function (registration) {
                        console.log('[PWA] Service Worker enregistr√© avec succ√®s:', registration.scope);
                    })
                    .catch(function (error) {
                        console.log('[PWA] √âchec de l\'enregistrement du Service Worker:', error);
                    });
            });
        }
    </script>

    <!-- Chargement Capacitor pour mode APK uniquement -->
    <script>
        if (window.location.protocol !== 'file:') {
            // Mode APK: charger le module Capacitor
            const script = document.createElement('script');
            script.type = 'module';
            script.src = './vendor/capacitor-loader.js';
            script.onerror = function () {
                console.error('‚ùå Erreur chargement capacitor-loader.js');
            };
            document.body.appendChild(script);
        }
    </script>

</body>

</html>